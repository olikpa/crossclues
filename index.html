<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Cross Clues â€” Online</title>
<link href="https://fonts.googleapis.com/css2?family=Syne:wght@700;800&family=Instrument+Sans:wght@400;500;600&family=Instrument+Serif:ital@0;1&display=swap" rel="stylesheet">

<style>
:root {
  --bg: #f5f0e8;
  --surface: #fffdf8;
  --card: #ffffff;
  --border: #e0d8cc;
  --shadow: rgba(60,40,10,.08);
  --ink: #1c1710;
  --muted: #8a7f6e;
  --row-clr: #c0392b;
  --col-clr: #1a6fa8;
  --accent: #d4a017;
  --success: #2e7d52;
  --success-bg: #d4f0e0;
  --wrong: #c0392b;
  --wrong-bg: #fdf0ef;
  --tag-bg: #f0ece3;
}

*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

body {
  font-family: 'Instrument Sans', sans-serif;
  background: var(--bg);
  color: var(--ink);
  min-height: 100vh;
  overflow-x: hidden;
}

body::after {
  content: '';
  position: fixed;
  inset: 0;
  pointer-events: none;
  z-index: 999;
  opacity: .025;
  background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)'/%3E%3C/svg%3E");
}

.screen { display: none; min-height: 100vh; }
.screen.active { display: flex; flex-direction: column; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   LOBBY
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#lobby {
  align-items: center;
  justify-content: center;
  padding: 2rem 1rem;
  gap: 2rem;
  background:
    radial-gradient(ellipse 80% 60% at 20% 10%, rgba(212,160,23,.12) 0%, transparent 60%),
    radial-gradient(ellipse 60% 50% at 80% 90%, rgba(26,111,168,.1) 0%, transparent 60%),
    var(--bg);
}

.logo-block { text-align: center; }

.logo-cross {
  display: inline-flex;
  align-items: center;
  gap: .3rem;
  font-family: 'Syne', sans-serif;
  font-size: clamp(2.4rem, 7vw, 4rem);
  font-weight: 800;
  letter-spacing: -.03em;
  line-height: 1;
}
.logo-cross .w-row { color: var(--row-clr); }
.logo-cross .w-sep { color: var(--muted); font-size: .6em; }
.logo-cross .w-col { color: var(--col-clr); }

.logo-sub {
  margin-top: .5rem;
  font-size: .85rem;
  color: var(--muted);
  letter-spacing: .12em;
  text-transform: uppercase;
}

.lobby-card {
  background: var(--card);
  border: 1px solid var(--border);
  border-radius: 20px;
  padding: 2rem;
  width: 100%;
  max-width: 420px;
  box-shadow: 0 4px 24px var(--shadow);
}

.lang-row {
  display: flex;
  gap: .5rem;
  margin-bottom: 1.8rem;
  padding: .3rem;
  background: var(--tag-bg);
  border-radius: 12px;
}

.lang-pill {
  flex: 1;
  padding: .55rem;
  border: none;
  border-radius: 9px;
  background: transparent;
  font-family: 'Instrument Sans', sans-serif;
  font-size: .85rem;
  color: var(--muted);
  cursor: pointer;
  transition: all .18s;
  font-weight: 500;
}
.lang-pill.active {
  background: var(--card);
  color: var(--ink);
  box-shadow: 0 1px 4px var(--shadow);
}

.or-divider {
  display: flex;
  align-items: center;
  gap: .8rem;
  margin: 1.4rem 0;
  color: var(--muted);
  font-size: .8rem;
  text-transform: uppercase;
  letter-spacing: .1em;
}
.or-divider::before, .or-divider::after {
  content: '';
  flex: 1;
  height: 1px;
  background: var(--border);
}

.section-lbl {
  font-size: .75rem;
  text-transform: uppercase;
  letter-spacing: .1em;
  color: var(--muted);
  margin-bottom: .6rem;
  font-weight: 600;
}

.field {
  width: 100%;
  padding: .75rem 1rem;
  border: 1.5px solid var(--border);
  border-radius: 12px;
  background: var(--surface);
  font-family: 'Instrument Sans', sans-serif;
  font-size: 1rem;
  color: var(--ink);
  outline: none;
  transition: border-color .18s, box-shadow .18s;
  margin-bottom: .8rem;
}
.field:focus {
  border-color: var(--accent);
  box-shadow: 0 0 0 3px rgba(212,160,23,.15);
}
.field::placeholder { color: var(--muted); }

.btn-main {
  width: 100%;
  padding: .85rem;
  border: none;
  border-radius: 12px;
  font-family: 'Syne', sans-serif;
  font-size: 1rem;
  font-weight: 700;
  cursor: pointer;
  transition: transform .12s, opacity .18s;
  letter-spacing: .02em;
}
.btn-main:hover { opacity: .9; transform: translateY(-1px); }
.btn-main:active { transform: translateY(0); }
.btn-create { background: var(--ink); color: var(--bg); }
.btn-join { background: var(--accent); color: var(--ink); }

.room-code-display {
  background: var(--tag-bg);
  border: 1.5px dashed var(--border);
  border-radius: 12px;
  padding: 1.2rem;
  text-align: center;
  margin-bottom: 1rem;
}
.room-code-label {
  font-size: .75rem;
  text-transform: uppercase;
  letter-spacing: .1em;
  color: var(--muted);
  margin-bottom: .4rem;
}
.room-code-value {
  font-family: 'Syne', sans-serif;
  font-size: 2.2rem;
  font-weight: 800;
  letter-spacing: .15em;
  color: var(--ink);
}

.waiting-dots::after {
  content: '';
  animation: dots 1.4s infinite;
}
@keyframes dots {
  0%   { content: ''; }
  25%  { content: '.'; }
  50%  { content: '..'; }
  75%  { content: '...'; }
}

.status-msg {
  text-align: center;
  font-size: .9rem;
  color: var(--muted);
  padding: .5rem 0;
}
.status-msg.error { color: var(--wrong); }

/* players-in-room list */
.players-in-room {
  margin-top: .8rem;
}
.players-in-room-label {
  font-size: .72rem;
  text-transform: uppercase;
  letter-spacing: .1em;
  color: var(--muted);
  margin-bottom: .4rem;
}
.players-list {
  display: flex;
  flex-wrap: wrap;
  gap: .4rem;
}
.player-chip {
  display: flex;
  align-items: center;
  gap: .35rem;
  padding: .25rem .6rem;
  background: var(--tag-bg);
  border: 1px solid var(--border);
  border-radius: 20px;
  font-size: .8rem;
  font-weight: 500;
}
.player-chip-dot {
  width: 8px; height: 8px;
  border-radius: 50%;
  flex-shrink: 0;
}

.start-game-btn {
  margin-top: .8rem;
  width: 100%;
  padding: .8rem;
  background: var(--success);
  border: none;
  border-radius: 12px;
  color: #fff;
  font-family: 'Syne', sans-serif;
  font-size: .95rem;
  font-weight: 700;
  cursor: pointer;
  transition: opacity .18s;
}
.start-game-btn:hover { opacity: .88; }
.start-game-btn:disabled { opacity: .4; cursor: not-allowed; }

/* timer toggle row */
.timer-row {
  display: flex;
  align-items: center;
  gap: .8rem;
  padding: .8rem 0;
  border-top: 1px solid var(--border);
  margin-top: .5rem;
}
.toggle-switch {
  position: relative;
  width: 40px; height: 22px;
  cursor: pointer;
  flex-shrink: 0;
}
.toggle-switch input { opacity: 0; width: 0; height: 0; }
.toggle-slider {
  position: absolute;
  inset: 0;
  background: var(--border);
  border-radius: 11px;
  transition: .2s;
}
.toggle-slider::before {
  content: '';
  position: absolute;
  width: 16px; height: 16px;
  left: 3px; top: 3px;
  background: #fff;
  border-radius: 50%;
  transition: .2s;
  box-shadow: 0 1px 3px rgba(0,0,0,.2);
}
.toggle-switch input:checked + .toggle-slider { background: var(--accent); }
.toggle-switch input:checked + .toggle-slider::before { transform: translateX(18px); }

.timer-input {
  width: 56px;
  padding: .3rem .5rem;
  border: 1.5px solid var(--border);
  border-radius: 8px;
  background: var(--surface);
  font-family: 'Syne', sans-serif;
  font-size: .9rem;
  text-align: center;
  color: var(--ink);
  outline: none;
}
.timer-input:focus { border-color: var(--accent); }
.timer-input:disabled { opacity: .4; }
.timer-label { font-size: .85rem; color: var(--muted); flex: 1; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   GAME SCREEN
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#game { flex-direction: column; background: var(--bg); }

.game-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: .7rem 1.2rem;
  background: var(--card);
  border-bottom: 1px solid var(--border);
  flex-shrink: 0;
  gap: .8rem;
  box-shadow: 0 1px 4px var(--shadow);
}

.header-logo {
  font-family: 'Syne', sans-serif;
  font-weight: 800;
  font-size: 1.1rem;
  letter-spacing: -.02em;
}
.header-logo .r { color: var(--row-clr); }
.header-logo .c { color: var(--col-clr); }

.header-center {
  display: flex;
  align-items: center;
  gap: .7rem;
}

.score-chip {
  font-family: 'Syne', sans-serif;
  font-size: .85rem;
  font-weight: 700;
  padding: .25rem .7rem;
  border-radius: 20px;
  background: var(--tag-bg);
  border: 1px solid var(--border);
  color: var(--ink);
}

.timer-chip {
  font-family: 'Syne', sans-serif;
  font-size: 1rem;
  font-weight: 800;
  padding: .2rem .65rem;
  border-radius: 20px;
  background: var(--ink);
  color: var(--bg);
  min-width: 50px;
  text-align: center;
  transition: background .3s;
}
.timer-chip.urgent { background: var(--wrong); animation: urgentPulse .5s alternate infinite; }
@keyframes urgentPulse { to { opacity: .7; } }

.room-chip {
  font-family: 'Syne', sans-serif;
  font-size: .75rem;
  font-weight: 700;
  letter-spacing: .1em;
  color: var(--muted);
  border: 1px solid var(--border);
  border-radius: 8px;
  padding: .2rem .55rem;
  cursor: pointer;
}
.room-chip:hover { border-color: var(--muted); }

.header-quit {
  padding: .3rem .7rem;
  border: 1px solid var(--border);
  border-radius: 8px;
  background: transparent;
  font-family: 'Instrument Sans', sans-serif;
  font-size: .8rem;
  color: var(--muted);
  cursor: pointer;
  transition: all .15s;
}
.header-quit:hover { border-color: var(--wrong); color: var(--wrong); }

.header-new-game {
  padding: .3rem .8rem;
  border: 1.5px solid var(--success);
  border-radius: 8px;
  background: transparent;
  font-family: 'Syne', sans-serif;
  font-size: .8rem;
  font-weight: 700;
  color: var(--success);
  cursor: pointer;
  transition: all .15s;
}
.header-new-game:hover { background: var(--success); color: #fff; }

.game-body {
  flex: 1;
  display: grid;
  grid-template-columns: 1fr 290px;
  min-height: 0;
  overflow: hidden;
}
@media (max-width: 720px) {
  .game-body {
    grid-template-columns: 1fr;
    grid-template-rows: 1fr auto;
    overflow: auto;
  }
}

/* Grid area */
.grid-area {
  display: flex;
  align-items: center;
  justify-content: center;
  padding: 1rem;
  overflow: auto;
}

.grid-wrap { display: flex; flex-direction: column; gap: 0; }

.col-headers { display: flex; margin-left: 96px; gap: 4px; }

.col-hdr {
  width: 72px;
  text-align: center;
  font-size: .68rem;
  font-weight: 600;
  color: var(--col-clr);
  text-transform: uppercase;
  letter-spacing: .04em;
  line-height: 1.2;
  padding-bottom: 5px;
  word-break: break-word;
}

.grid-row-wrap { display: flex; align-items: center; gap: 4px; }

.row-hdr {
  width: 92px;
  text-align: right;
  padding-right: 8px;
  font-size: .68rem;
  font-weight: 600;
  color: var(--row-clr);
  text-transform: uppercase;
  letter-spacing: .04em;
  line-height: 1.2;
  word-break: break-word;
}

.cell {
  width: 72px;
  height: 72px;
  border: 1.5px solid var(--border);
  border-radius: 10px;
  background: var(--card);
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  position: relative;
  transition: all .15s;
  overflow: hidden;
  box-shadow: 0 1px 3px var(--shadow);
}

.cell::before {
  content: '';
  position: absolute;
  inset: 0;
  background: linear-gradient(135deg, rgba(192,57,43,.05), rgba(26,111,168,.05));
  opacity: 0;
  transition: opacity .15s;
}
.cell:hover::before { opacity: 1; }
.cell:hover { border-color: var(--accent); transform: scale(1.06); z-index: 2; box-shadow: 0 4px 12px var(--shadow); }

.cell.disabled { cursor: default; }
.cell.disabled:hover { border-color: var(--border); transform: none; box-shadow: 0 1px 3px var(--shadow); }
.cell.disabled::before { display: none; }

/* â”€â”€ GUESSED CELL: vivid green glow â”€â”€ */
.cell.guessed {
  background: var(--success-bg);
  border-color: var(--success);
  border-width: 2px;
  cursor: default;
  box-shadow: 0 0 0 3px rgba(46,125,82,.18), 0 2px 8px rgba(46,125,82,.15);
}
.cell.guessed:hover { transform: none; border-color: var(--success); box-shadow: 0 0 0 3px rgba(46,125,82,.18), 0 2px 8px rgba(46,125,82,.15); }

/* pop animation when first guessed */
.cell.guessed-pop {
  animation: guessedPop .45s cubic-bezier(.36,1.56,.64,1) both;
}
@keyframes guessedPop {
  0%   { transform: scale(.85); opacity: .6; }
  60%  { transform: scale(1.12); }
  100% { transform: scale(1); opacity: 1; }
}

.cell-check {
  font-size: 1.6rem;
  color: var(--success);
  line-height: 1;
}

.cell.wrong-flash { animation: wrongFlash .5s ease; }
@keyframes wrongFlash {
  0%, 100% { background: var(--card); }
  50% { background: var(--wrong-bg); border-color: var(--wrong); }
}

/* Missed cell â€” stays red permanently until end of game */
.cell.missed {
  background: #fff0e0;
  border-color: #e07b00;
  border-width: 2px;
  box-shadow: 0 0 0 3px rgba(224,123,0,.22), 0 2px 8px rgba(224,123,0,.14);
  cursor: default;
}
.cell.missed:hover { transform: none; border-color: #e07b00; }
.cell.missed::before { display: none; }

/* Pop-in animation when a cell first becomes missed */
.cell.missed-pop {
  animation: missedPop .4s cubic-bezier(.36,1.4,.64,1) both;
}
@keyframes missedPop {
  0%   { transform: scale(.9); }
  60%  { transform: scale(1.08); }
  100% { transform: scale(1); }
}

.cell-miss-icon {
  font-size: 1.4rem;
  font-weight: 700;
  color: #e07b00;
  line-height: 1;
}

.cell.active-target {
  border-color: var(--accent);
  box-shadow: 0 0 0 3px rgba(212,160,23,.25), 0 2px 8px var(--shadow);
}

.cell-coord {
  position: absolute;
  bottom: 3px;
  right: 5px;
  font-family: 'Syne', sans-serif;
  font-size: .52rem;
  font-weight: 700;
  color: var(--muted);
  opacity: .5;
}

/* Side panel */
.side {
  border-left: 1px solid var(--border);
  background: var(--surface);
  display: flex;
  flex-direction: column;
  overflow: hidden;
}

.side-section {
  padding: 1rem;
  border-bottom: 1px solid var(--border);
  flex-shrink: 0;
}

.side-lbl {
  font-size: .7rem;
  text-transform: uppercase;
  letter-spacing: .12em;
  color: var(--muted);
  margin-bottom: .6rem;
  font-weight: 600;
}

/* Player strip - shows all players in room */
.players-strip {
  display: flex;
  flex-wrap: wrap;
  gap: .35rem;
}
.player-pill {
  display: flex;
  align-items: center;
  gap: .3rem;
  padding: .22rem .55rem;
  border-radius: 20px;
  border: 1.5px solid transparent;
  font-size: .78rem;
  font-weight: 500;
  transition: all .2s;
}
.player-pill.active-player {
  border-color: var(--accent);
  background: rgba(212,160,23,.08);
  font-weight: 700;
}
.player-pill.is-me {
  text-decoration: underline;
  text-underline-offset: 2px;
}
.pill-dot {
  width: 8px; height: 8px;
  border-radius: 50%;
  flex-shrink: 0;
}
.pill-role {
  font-size: .65rem;
  color: var(--muted);
  text-transform: uppercase;
  letter-spacing: .06em;
}

.player-card {
  display: flex;
  align-items: center;
  gap: .75rem;
  padding: .7rem;
  background: var(--card);
  border: 1px solid var(--border);
  border-radius: 10px;
}
.p-avatar {
  width: 38px; height: 38px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-family: 'Syne', sans-serif;
  font-size: 1.1rem;
  font-weight: 800;
  flex-shrink: 0;
}
.p-name {
  font-weight: 600;
  font-size: .95rem;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}
.p-role { font-size: .75rem; color: var(--muted); margin-top: .1rem; }

.target-card {
  background: var(--card);
  border: 1px solid var(--border);
  border-radius: 10px;
  padding: .75rem;
}
.target-coord-badge {
  font-family: 'Syne', sans-serif;
  font-size: .75rem;
  font-weight: 700;
  color: var(--muted);
  margin-bottom: .4rem;
}
.target-pair {
  display: flex;
  align-items: center;
  gap: .4rem;
  flex-wrap: wrap;
}
.tw { font-size: .9rem; font-weight: 600; padding: .2rem .5rem; border-radius: 6px; }
.tw-row { color: var(--row-clr); background: rgba(192,57,43,.08); }
.tw-col { color: var(--col-clr); background: rgba(26,111,168,.08); }
.tw-sep { color: var(--muted); font-size: .8rem; }
.hint-note { font-size: .78rem; color: var(--muted); font-style: italic; margin-top: .5rem; }

.clue-field {
  width: 100%;
  padding: .7rem .9rem;
  border: 1.5px solid var(--border);
  border-radius: 10px;
  background: var(--card);
  font-family: 'Instrument Sans', sans-serif;
  font-size: 1rem;
  color: var(--ink);
  outline: none;
  transition: border-color .18s, box-shadow .18s;
  margin-bottom: .6rem;
}
.clue-field:focus { border-color: var(--accent); box-shadow: 0 0 0 3px rgba(212,160,23,.12); }
.clue-field:disabled { background: var(--tag-bg); color: var(--muted); cursor: not-allowed; }

.give-btn {
  width: 100%;
  padding: .72rem;
  background: var(--ink);
  border: none;
  border-radius: 10px;
  color: var(--bg);
  font-family: 'Syne', sans-serif;
  font-size: .95rem;
  font-weight: 700;
  cursor: pointer;
  transition: opacity .18s;
}
.give-btn:hover:not(:disabled) { opacity: .85; }
.give-btn:disabled { opacity: .4; cursor: not-allowed; }

.clue-reveal {
  background: var(--card);
  border: 1.5px solid var(--accent);
  border-radius: 10px;
  padding: 1rem;
  text-align: center;
  margin-bottom: .6rem;
}
.clue-word {
  font-family: 'Instrument Serif', serif;
  font-size: 1.9rem;
  font-weight: 400;
  color: var(--ink);
  letter-spacing: -.01em;
}
.clue-sub {
  font-size: .72rem;
  text-transform: uppercase;
  letter-spacing: .1em;
  color: var(--muted);
  margin-top: .3rem;
}
.guess-tip { font-size: .82rem; color: var(--muted); text-align: center; line-height: 1.5; }

.waiting-note {
  background: var(--tag-bg);
  border: 1px solid var(--border);
  border-radius: 10px;
  padding: .8rem;
  text-align: center;
  font-size: .85rem;
  color: var(--muted);
  line-height: 1.5;
}

.log-scroll {
  flex: 1;
  overflow-y: auto;
  padding: .8rem 1rem;
  display: flex;
  flex-direction: column;
  gap: .35rem;
  min-height: 0;
}
.log-scroll::-webkit-scrollbar { width: 4px; }
.log-scroll::-webkit-scrollbar-thumb { background: var(--border); border-radius: 2px; }

.log-entry {
  font-size: .78rem;
  line-height: 1.45;
  color: var(--muted);
  display: flex;
  gap: .4rem;
  align-items: flex-start;
}
.log-entry .li { flex-shrink: 0; }
.log-entry strong { color: var(--ink); }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   END SCREEN
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#end {
  align-items: center;
  justify-content: center;
  padding: 2rem;
  background: var(--bg);
}

.end-inner {
  max-width: 400px;
  width: 100%;
  text-align: center;
  animation: rise .5s ease both;
}
@keyframes rise {
  from { opacity: 0; transform: translateY(20px); }
  to   { opacity: 1; transform: translateY(0); }
}

.end-trophy { font-size: 5rem; line-height: 1; margin-bottom: 1rem; }
.end-title { font-family: 'Syne', sans-serif; font-size: 2.5rem; font-weight: 800; letter-spacing: -.03em; margin-bottom: .4rem; }
.end-sub { color: var(--muted); margin-bottom: 2rem; }

.end-stats { display: grid; grid-template-columns: 1fr 1fr; gap: .75rem; margin-bottom: 2rem; }
.stat-box { background: var(--card); border: 1px solid var(--border); border-radius: 14px; padding: 1.2rem .8rem; box-shadow: 0 2px 8px var(--shadow); }
.stat-n { font-family: 'Syne', sans-serif; font-size: 2.2rem; font-weight: 800; color: var(--ink); line-height: 1; }
.stat-desc { font-size: .72rem; text-transform: uppercase; letter-spacing: .1em; color: var(--muted); margin-top: .3rem; }

.end-btns { display: flex; flex-direction: column; gap: .7rem; }
.btn-again { padding: .9rem; background: var(--success); border: none; border-radius: 12px; color: #fff; font-family: 'Syne', sans-serif; font-size: 1rem; font-weight: 700; cursor: pointer; transition: opacity .18s; }
.btn-again:hover { opacity: .85; }
.btn-home { padding: .9rem; background: transparent; border: 1.5px solid var(--border); border-radius: 12px; color: var(--muted); font-family: 'Instrument Sans', sans-serif; font-size: .9rem; cursor: pointer; transition: all .18s; }
.btn-home:hover { border-color: var(--muted); color: var(--ink); }

/* room code in end screen */
.end-room-code {
  font-family: 'Syne', sans-serif;
  font-size: .85rem;
  font-weight: 700;
  color: var(--muted);
  letter-spacing: .1em;
  margin-bottom: 1rem;
  padding: .4rem .9rem;
  background: var(--tag-bg);
  border: 1px solid var(--border);
  border-radius: 20px;
  display: inline-block;
}


/* â”€â”€ MODE SELECTOR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.mode-selector {
  margin-top: .9rem;
  padding-top: .9rem;
  border-top: 1px solid var(--border);
}
.mode-pills { display: flex; gap: .5rem; margin-top: .4rem; }
.mode-pill {
  flex: 1; padding: .55rem .4rem;
  border: 1.5px solid var(--border); border-radius: 10px;
  background: transparent;
  font-family: 'Instrument Sans', sans-serif; font-size: .82rem; font-weight: 500;
  color: var(--muted); cursor: pointer; transition: all .18s; text-align: center;
}
.mode-pill.active { border-color: var(--accent); background: rgba(212,160,23,.1); color: var(--ink); font-weight: 600; }

/* Team assignment rows */
.team-assign-row {
  display: flex; align-items: center; justify-content: space-between;
  padding: .45rem 0; border-bottom: 1px solid var(--border); font-size: .85rem;
}
.team-assign-row:last-child { border-bottom: none; }
.team-assign-name { font-weight: 500; }
.team-select {
  padding: .25rem .5rem; border: 1.5px solid var(--border); border-radius: 8px;
  background: var(--surface); font-family: 'Instrument Sans', sans-serif;
  font-size: .82rem; color: var(--ink); outline: none; cursor: pointer;
}
.team-select:focus { border-color: var(--accent); }

/* â”€â”€ TEAMS SCORE BAR (in-game) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.teams-score-bar {
  display: flex; gap: .5rem; padding: .6rem 1rem;
  border-bottom: 1px solid var(--border); flex-shrink: 0; background: var(--card);
}
.team-score-chip {
  flex: 1; padding: .4rem .6rem; border-radius: 10px;
  border: 2px solid transparent; text-align: center;
  font-family: 'Syne', sans-serif; font-size: .85rem; font-weight: 700; transition: all .2s;
}
.team-score-chip.active-team { transform: scale(1.04); box-shadow: 0 2px 8px var(--shadow); }
.team-score-n { font-size: 1.4rem; line-height: 1; }
.team-score-label { font-size: .65rem; text-transform: uppercase; letter-spacing: .08em; opacity: .7; margin-top: .1rem; }

/* toast */
.toast {
  position: fixed;
  bottom: 1.5rem;
  left: 50%;
  transform: translateX(-50%) translateY(80px);
  background: var(--ink);
  color: var(--bg);
  padding: .65rem 1.2rem;
  border-radius: 24px;
  font-size: .9rem;
  font-weight: 500;
  z-index: 500;
  transition: transform .3s ease;
  pointer-events: none;
  white-space: nowrap;
  max-width: 90vw;
  text-align: center;
}
.toast.show { transform: translateX(-50%) translateY(0); }
</style>
</head>
<body>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• LOBBY â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="lobby" class="screen active">
  <div class="logo-block">
    <div class="logo-cross">
      <span class="w-row">Cross</span>
      <span class="w-sep">âœ•</span>
      <span class="w-col">Clues</span>
    </div>
    <div class="logo-sub" id="lg-sub">Online Cooperative Word Game</div>
  </div>

  <div class="lobby-card">
    <div class="lang-row">
      <button class="lang-pill active" onclick="setLang('en')">ğŸ‡¬ğŸ‡§ English</button>
      <button class="lang-pill" onclick="setLang('es')">ğŸ‡ªğŸ‡¸ EspaÃ±ol</button>
    </div>

    <!-- Create Room -->
    <div id="create-section">
      <div class="section-lbl" id="lbl-your-name">Your Name</div>
      <input type="text" class="field" id="create-name" maxlength="20" placeholder="Player 1">

      <div class="timer-row">
        <label class="toggle-switch">
          <input type="checkbox" id="timer-toggle" onchange="onTimerToggle()">
          <span class="toggle-slider"></span>
        </label>
        <span class="timer-label" id="lbl-timer-toggle">Enable timer</span>
        <input type="number" class="timer-input" id="timer-secs" value="90" min="15" max="600" disabled>
        <span class="timer-label" style="flex:none" id="lbl-secs">sec</span>
      </div>

      <button class="btn-main btn-create" onclick="createRoom()" id="btn-create">Create Room</button>
    </div>

    <!-- Waiting in room (creator sees this) -->
    <div id="waiting-section" style="display:none">
      <div class="room-code-display">
        <div class="room-code-label" id="lbl-room-code">Room Code â€” share with everyone</div>
        <div class="room-code-value" id="room-code-value">â€”â€”â€”</div>
      </div>

      <div class="players-in-room">
        <div class="players-in-room-label" id="lbl-players-joined">Players joined</div>
        <div class="players-list" id="lobby-players-list"></div>
      </div>

      <!-- Mode selector â€” host only, visible when â‰¥2 players -->
      <div class="mode-selector" id="mode-selector" style="display:none">
        <div class="section-lbl" id="lbl-game-mode">Game Mode</div>
        <div class="mode-pills">
          <button class="mode-pill active" id="mode-pill-coop" onclick="selectMode('coop')">
            ğŸ¤ <span id="lbl-mode-coop">Cooperative</span>
          </button>
          <button class="mode-pill" id="mode-pill-teams" onclick="selectMode('teams')">
            âš”ï¸ <span id="lbl-mode-teams">Teams</span>
          </button>
        </div>
        <div id="teams-config" style="display:none;margin-top:.8rem">
          <div class="section-lbl" id="lbl-assign-teams">Assign players to teams</div>
          <div id="team-assign-list"></div>
        </div>
      </div>

      <button class="start-game-btn" id="start-game-btn" onclick="hostStartGame()" disabled>
        Start Game â†’
      </button>

      <div class="status-msg" id="waiting-msg" style="margin-top:.6rem">
        <span id="waiting-text">Waiting for players</span><span class="waiting-dots"></span>
      </div>
    </div>

    <div class="or-divider" id="or-div">or</div>

    <!-- Join Room -->
    <div id="join-section">
      <div class="section-lbl" id="lbl-join-name">Your Name</div>
      <input type="text" class="field" id="join-name" maxlength="20" placeholder="Player 2">
      <div class="section-lbl" id="lbl-enter-code">Room Code</div>
      <input type="text" class="field" id="join-code" maxlength="6" placeholder="ABC123"
        style="text-transform:uppercase;letter-spacing:.15em;font-family:'Syne',sans-serif;font-weight:700;"
        oninput="this.value=this.value.toUpperCase()">
      <button class="btn-main btn-join" onclick="joinRoom()" id="btn-join">Join Room</button>
      <div class="status-msg" id="join-status" style="margin-top:.5rem;display:none"></div>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• GAME â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="game" class="screen">
  <div class="game-header">
    <div class="header-logo"><span class="r">Cross</span> <span class="c">Clues</span></div>
    <div class="header-center">
      <span class="score-chip" id="hdr-score">0 / 25</span>
      <span class="timer-chip" id="hdr-timer" style="display:none">1:30</span>
      <span class="room-chip" id="hdr-room" title="Click to copy room code" onclick="copyRoomCode()">â€”</span>
    </div>
    <button class="header-new-game" id="btn-new-game" onclick="playAgain()">New Game</button>
    <button class="header-quit" id="btn-quit" onclick="quitGame()">Quit</button>
  </div>

  <!-- Teams scoreboard â€” only shown in teams mode -->
  <div class="teams-score-bar" id="teams-score-bar" style="display:none"></div>

  <div class="game-body">
    <div class="grid-area">
      <div id="grid-wrap" class="grid-wrap"></div>
    </div>

    <div class="side">
      <!-- All players strip -->
      <div class="side-section" id="side-players">
        <div class="side-lbl" id="lbl-players">Players</div>
        <div class="players-strip" id="players-strip"></div>
      </div>

      <!-- Current active player -->
      <div class="side-section" id="side-player">
        <div class="side-lbl" id="lbl-now-playing">Now Playing</div>
        <div class="player-card">
          <div class="p-avatar" id="p-avatar">?</div>
          <div>
            <div class="p-name" id="p-name-display">â€”</div>
            <div class="p-role" id="p-role-display">â€”</div>
          </div>
        </div>
      </div>

      <!-- Giver's target -->
      <div class="side-section" id="giver-block">
        <div class="side-lbl" id="lbl-target">Target</div>
        <div class="target-card">
          <div class="target-coord-badge" id="tc-coord">â€”</div>
          <div class="target-pair" id="tc-pair"></div>
          <div class="hint-note" id="tc-hint"></div>
        </div>
      </div>

      <!-- Giver's clue input -->
      <div class="side-section" id="clue-input-block">
        <div class="side-lbl" id="lbl-give-clue">Your Clue</div>
        <input type="text" class="clue-field" id="clue-input" maxlength="40" placeholder="one wordâ€¦"
          onkeydown="if(event.key==='Enter') submitClue()">
        <button class="give-btn" id="give-btn" onclick="submitClue()">Give Clue â†’</button>
      </div>

      <!-- Guesser's view -->
      <div class="side-section" id="guesser-block" style="display:none">
        <div class="side-lbl" id="lbl-the-clue">The Clue</div>
        <div class="clue-reveal">
          <div class="clue-word" id="revealed-clue">â€”</div>
          <div class="clue-sub" id="lbl-one-word">one word</div>
        </div>
        <div class="guess-tip" id="guess-tip">Tap the grid cell that matches!</div>
      </div>

      <!-- Waiting note -->
      <div class="side-section" id="waiting-block" style="display:none">
        <div class="waiting-note" id="waiting-note-text">Waitingâ€¦</div>
      </div>

      <div class="side-lbl" style="padding:.7rem 1rem .2rem;flex-shrink:0" id="lbl-log">Log</div>
      <div class="log-scroll" id="log-scroll"></div>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• END â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="end" class="screen">
  <div class="end-inner">
    <div class="end-trophy" id="end-trophy">ğŸ†</div>
    <div class="end-title" id="end-title">Congratulations!</div>
    <div class="end-sub" id="end-sub">You matched all pairs!</div>
    <div class="end-room-code" id="end-room-code"></div>
    <div class="end-stats">
      <div class="stat-box">
        <div class="stat-n" id="stat-matched">0</div>
        <div class="stat-desc" id="lbl-stat-matched">Matched</div>
      </div>
      <div class="stat-box">
        <div class="stat-n" id="stat-rounds">0</div>
        <div class="stat-desc" id="lbl-stat-rounds">Rounds</div>
      </div>
    </div>
    <div class="end-btns">
      <button class="btn-again" id="btn-play-again" onclick="playAgain()">Play Again (same room)</button>
      <button class="btn-home" id="btn-go-home" onclick="goHome()">Leave Room</button>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script type="module">
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  FIREBASE CONFIG  â€” your credentials are already set below
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const FIREBASE_CONFIG = {
  apiKey: "AIzaSyCa_uT9_f2LbjO-zAKXPVK5Fob_4NWoHLA",
  authDomain: "cross-clues-31450.firebaseapp.com",
  databaseURL: "https://cross-clues-31450-default-rtdb.firebaseio.com",
  projectId: "cross-clues-31450",
  storageBucket: "cross-clues-31450.firebasestorage.app",
  messagingSenderId: "1043663543507",
  appId: "1:1043663543507:web:13ee17b1da0c47b2c74826",
  measurementId: "G-63Z8MV0CFB"
};

import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import {
  getDatabase, ref, set, get, update, onValue, off
} from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

const app = initializeApp(FIREBASE_CONFIG);
const db  = getDatabase(app);

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  WORD LISTS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const WORDS = {
  es: [
    // LUGARES NATURALES
    "Selva","Desierto","Playa","VolcÃ¡n","Isla","Cueva","OcÃ©ano","RÃ­o","MontaÃ±a","Bosque",
    "Pantano","Glaciar","Pradera","Cascada","Acantilado","Valle","Jungla","Polo","Arrecife",
    "Abismo","Horizonte","Estanque","JardÃ­n","Invernadero",
    // LUGARES CONSTRUIDOS
    "Ciudad","Pueblo","Hospital","Escuela","Parque","Cine","Estadio","Biblioteca",
    "Aeropuerto","Granja","Castillo","PrisiÃ³n","Laboratorio","Hotel","Restaurante",
    "Oficina","Iglesia","Museo","Cementerio","ZoolÃ³gico","Tienda","Supermercado",
    "Puente","EstaciÃ³n","Gimnasio","Teatro","Circo","Casino","Banco","FÃ¡brica",
    "Mina","Puerto","Faro","Templo","PirÃ¡mide","Torre","Muro","Trinchera",
    "MansiÃ³n","CabaÃ±a","Rascacielos","Metro","Carretera","CallejÃ³n","Plaza",
    "Mercado","Universidad","GuarderÃ­a","ComisarÃ­a","Cuartel","Juzgado",
    "Parlamento","Ayuntamiento","Catedral","Sinagoga","Mezquita","Santuario",
    "Altar","Tumba","Ruinas","Laberinto","Helipuerto","Quiosco",
    // ESPACIO
    "Espacio","Marte","Estrella","Planeta","Cometa","Galaxia","Universo","SatÃ©lite","Cohete",
    // OBJETOS COTIDIANOS
    "Manzana","Pan","CafÃ©","Chocolate","Pizza","Queso","Huevo","Vino",
    "Cuchillo","Tenedor","Martillo","Llave","Reloj","TelÃ©fono","CÃ¡mara","Libro",
    "Espejo","LÃ¡mpara","Silla","Mesa","Cama","Maleta","Dinero","Guitarra","Pelota",
    "Bicicleta","Coche","AviÃ³n","Barco","Tren","Paraguas","Gafas","Zapato","Sombrero",
    "Anillo","JabÃ³n","Cepillo","Papel","Pintura","Piedra","Radio",
    "Botella","Caja","Bolsa","Cesta","Cuchara","Plato","Vaso","SartÃ©n","Olla","Horno",
    "Nevera","Toalla","Peine","Esponja","Almohada","SÃ¡bana","Manta","Cortina",
    "Microondas","Aspiradora","Lavadora","Plancha","Ventilador","Estufa","Grifo",
    "Ladrillo","Cemento","Clavo","Tornillo","Sierra","Taladro","BrÃºjula","Mapa",
    "Telescopio","Microscopio","Jeringuilla","Pastilla","Vendaje","Muleta","TermÃ³metro",
    "Dron","Chip","LÃ¡ser","PrismÃ¡ticos","BaterÃ­a","Enchufe","Cable","Pantalla","Laptop",
    // ANIMALES
    "Perro","Gato","Caballo","LeÃ³n","Elefante","PÃ¡jaro","Pez","Serpiente","AraÃ±a","Abeja",
    "Tigre","Oso","Lobo","TiburÃ³n","Ballena","DelfÃ­n","Ãguila","BÃºho","Mariposa","Hormiga",
    "Rana","Tortuga","Cocodrilo","Mono","Vaca","Oveja","Cerdo","Pollo","RatÃ³n","Conejo",
    // PERSONAS Y PROFESIONES
    "MÃ©dico","PolicÃ­a","Bombero","Profesor","Chef","Artista","Piloto","Astronauta",
    "Soldado","Rey","BebÃ©","Gigante","Fantasma","Robot","Alien","Pirata","Payaso",
    "Mago","Atleta","CientÃ­fico","Abogado","Granjero","Actor","Cantante","BailarÃ­n",
    "Periodista","Carpintero","FotÃ³grafo","Detective","EspÃ­a","Ninja","Caballero",
    "Vikingo","Vaquero","Zombi","Vampiro","Sirena","DragÃ³n","Juez","PolÃ­tico",
    "Banquero","Marinero","Minero","MecÃ¡nico","Electricista","Fontanero","Peluquero","Veterinario",
    // NATURALEZA
    "Ãrbol","Flor","Nube",
    // CUERPO HUMANO
    "Ãtomo","Sangre","Hueso","Cerebro","CorazÃ³n","PulmÃ³n","Mano","Pie","Ojo","Oreja",
    "Nariz","Boca","Diente","Pelo","Piel","UÃ±a","MÃºsculo","Esqueleto","Nervio","Gen",
    // CONCEPTOS ABSTRACTOS
    "Amor","Miedo","Tiempo","SueÃ±o","Guerra","Paz","MÃºsica","Magia","Suerte","Destino",
    "Ruido","Calor","Velocidad","Peso","Altura","Color","Forma","NÃºmero","Historia","Futuro",
    "Mentira","Verdad","Crimen","Justicia","Veneno","Medicina","Electricidad",
    "Fuego","Agua","Aire","Tierra","Oro","Basura","Regalo","Vacaciones","Peligro",
    "Odio","AlegrÃ­a","Tristeza","Ira","Orgullo","Envidia","Poder","Libertad","Ley",
    "Deuda","Ã‰xito","Fracaso","Victoria","Derrota","Secreto","Misterio","Enigma",
    "Arte","Ciencia","ReligiÃ³n","PolÃ­tica","Idioma","Sonido","Ritmo","PoesÃ­a","Danza",
    "Juego","Deporte","Trabajo","Fiesta","Boda","Funeral","Viaje","Aventura",
    "Caos","Orden","EnergÃ­a","Fuerza","Gravedad","VacÃ­o","Infinito",
    "MaÃ±ana","Semana","Mes","AÃ±o","Siglo","Pasado","Presente","Eternidad",
    // VERBOS/ACCIONES
    "Volar","Nadar","Correr","Dormir","Comer","Cantar","Bailar","Escribir","Leer","Pelear",
    "Ganar","Perder","Romper","Arreglar","Comprar","Vender",
    // ADJETIVOS
    "Grande","PequeÃ±o","RÃ¡pido","Lento","Viejo","Nuevo","Caro","Barato","Pesado","Ligero",
    "Duro","Blando","Dulce","Salado","Amargo","Picante","Sucio","Limpio","Mojado","Seco",
    "Fuerte","DÃ©bil","Invisible","Brillante","Oscuro","Rojo","Azul","Verde","Amarillo",
    "Blanco","Negro","Redondo","Cuadrado","Largo","Corto","Caliente","Helado","Suave",
    "Ãspero","Lleno","Abierto","Cerrado","Joven","Anciano","Rico","Pobre","Sano","Enfermo",
    "Vivo","Muerto","Real","Falso","FÃ¡cil","DifÃ­cil","Ãštil","Solo","Libre","Preso",
    "Cerca","Lejos","Arriba","Abajo","Dentro","Fuera","Norte","Sur","Este","Oeste"
  ],
  en: [
    // NATURAL PLACES
    "Jungle","Desert","Beach","Volcano","Island","Cave","Ocean","River","Mountain","Forest",
    "Swamp","Glacier","Meadow","Waterfall","Cliff","Valley","Reef","Abyss","Horizon","Pond",
    // BUILT PLACES
    "City","Village","Hospital","School","Park","Cinema","Stadium","Library",
    "Airport","Farm","Castle","Prison","Laboratory","Hotel","Restaurant",
    "Office","Church","Museum","Cemetery","Zoo","Store","Bridge","Station",
    "Gym","Theater","Circus","Casino","Bank","Factory","Mine","Harbor","Lighthouse",
    "Temple","Pyramid","Tower","Wall","Trench","Mansion","Skyscraper","Subway",
    "Highway","Alley","Square","Market","University","Precinct","Barracks","Courthouse",
    "Parliament","Cathedral","Mosque","Sanctuary","Altar","Tomb","Ruins","Maze","Greenhouse",
    // SPACE
    "Space","Mars","Star","Planet","Comet","Galaxy","Universe","Satellite","Rocket",
    // OBJECTS
    "Apple","Bread","Coffee","Chocolate","Pizza","Cheese","Egg","Wine",
    "Knife","Fork","Hammer","Key","Clock","Phone","Camera","Book",
    "Mirror","Lamp","Chair","Table","Bed","Suitcase","Money","Guitar","Ball",
    "Bicycle","Car","Airplane","Ship","Train","Umbrella","Glasses","Shoe","Hat",
    "Ring","Soap","Brush","Paper","Paint","Stone","Radio",
    "Bottle","Box","Bag","Spoon","Plate","Cup","Pan","Oven","Fridge",
    "Towel","Pillow","Blanket","Curtain","Microwave","Drill","Compass","Map",
    "Telescope","Microscope","Syringe","Pill","Bandage","Thermometer",
    "Drone","Chip","Laser","Binoculars","Battery","Screen","Laptop",
    // ANIMALS
    "Dog","Cat","Horse","Lion","Elephant","Bird","Fish","Snake","Spider","Bee",
    "Tiger","Bear","Wolf","Shark","Whale","Dolphin","Eagle","Owl","Butterfly","Ant",
    "Frog","Turtle","Crocodile","Monkey","Cow","Sheep","Pig","Chicken","Mouse","Rabbit",
    // PEOPLE
    "Doctor","Police","Firefighter","Teacher","Chef","Artist","Pilot","Astronaut",
    "Soldier","King","Baby","Giant","Ghost","Robot","Alien","Pirate","Clown",
    "Wizard","Athlete","Scientist","Lawyer","Farmer","Actor","Singer","Dancer",
    "Journalist","Carpenter","Photographer","Detective","Spy","Ninja","Knight",
    "Viking","Cowboy","Zombie","Vampire","Mermaid","Dragon","Judge","Politician",
    "Sailor","Miner","Mechanic","Electrician","Plumber","Barber","Vet",
    // BODY
    "Blood","Bone","Brain","Heart","Lung","Hand","Foot","Eye","Ear",
    "Nose","Mouth","Tooth","Hair","Skin","Muscle","Skeleton","Nerve","Gene",
    // ABSTRACT
    "Love","Fear","Time","Dream","War","Peace","Music","Magic","Luck","Destiny",
    "Noise","Heat","Speed","Weight","Height","Color","Shape","Number","History","Future",
    "Lie","Truth","Crime","Justice","Poison","Medicine","Fire","Water","Air","Earth",
    "Gold","Trash","Gift","Danger","Hate","Joy","Sadness","Anger","Pride","Envy",
    "Power","Freedom","Law","Debt","Success","Failure","Victory","Defeat","Secret","Mystery",
    "Art","Science","Religion","Politics","Language","Sound","Rhythm","Poetry","Dance",
    "Game","Sport","Work","Party","Wedding","Journey","Adventure","Chaos","Order",
    "Energy","Gravity","Infinity","Morning","Week","Month","Year","Century","Past","Eternity",
    // ADJECTIVES
    "Big","Small","Fast","Slow","Old","New","Expensive","Heavy","Light",
    "Hard","Soft","Sweet","Salty","Bitter","Spicy","Dirty","Clean","Wet","Dry",
    "Strong","Weak","Invisible","Bright","Dark","Red","Blue","Green","Yellow",
    "White","Black","Round","Square","Long","Short","Hot","Cold","Smooth","Rough",
    "Full","Open","Closed","Young","Rich","Poor","Healthy","Sick","Alive","Dead",
    "Real","Fake","Easy","Difficult","Useful","Alone","Free","Near","Far","Up","Down"
  ]
};

// â”€â”€ SIMILARITY GROUPS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Words in the same group will never appear together on the same 5x5 grid.
// Add as many groups as needed; each entry is a Set for O(1) lookup.
const SIMILAR_GROUPS_ES = [
  new Set(["Selva","Jungla","Bosque"]),
  new Set(["OcÃ©ano","Mar","RÃ­o","Lago","Estanque","Arrecife"]),
  new Set(["MontaÃ±a","VolcÃ¡n","Acantilado","Valle","Colina"]),
  new Set(["Desierto","Pradera","Pantano","Glaciar"]),
  new Set(["Playa","Isla","Puerto","Faro"]),
  new Set(["Ciudad","Pueblo","Plaza","CallejÃ³n","Mercado","Rascacielos","Carretera","Metro"]),
  new Set(["Iglesia","Catedral","Sinagoga","Mezquita","Templo","Santuario","Altar"]),
  new Set(["Hospital","GuarderÃ­a","Universidad","Escuela","Laboratorio","ComisarÃ­a","Cuartel","Juzgado","Parlamento","Ayuntamiento"]),
  new Set(["Hotel","MansiÃ³n","CabaÃ±a","Castillo"]),
  new Set(["Cine","Teatro","Circo","Casino","Estadio","Gimnasio"]),
  new Set(["Tienda","Supermercado","Mercado","Banco","Quiosco"]),
  new Set(["Estrella","Luna","Sol","Planeta","Cometa","Galaxia","Universo","Espacio","Marte","SatÃ©lite","Cohete"]),
  new Set(["Fuego","Calor","Llama","VolcÃ¡n"]),
  new Set(["Nieve","Hielo","Glaciar","FrÃ­o","Helado","Polo"]),
  new Set(["Agua","Lluvia","RÃ­o","OcÃ©ano","Lago"]),
  new Set(["Ãrbol","Flor","JardÃ­n","Invernadero","Bosque","Selva"]),
  new Set(["Nube","Lluvia","Niebla","Horizonte"]),
  new Set(["Perro","Gato","Conejo","RatÃ³n"]),
  new Set(["LeÃ³n","Tigre","Leopardo","Pantera"]),
  new Set(["Ballena","DelfÃ­n","TiburÃ³n","Pez"]),
  new Set(["Ãguila","BÃºho","PÃ¡jaro"]),
  new Set(["AraÃ±a","Hormiga","Abeja","Mariposa"]),
  new Set(["Serpiente","Cocodrilo","Rana","Tortuga"]),
  new Set(["Vaca","Oveja","Cerdo","Caballo","Pollo"]),
  new Set(["Mono","Gorila","Elefante","Oso"]),
  new Set(["Amor","Odio","Envidia","Orgullo","Ira","AlegrÃ­a","Tristeza"]),
  new Set(["Guerra","Paz","Crimen","Justicia","Ley","Derrota","Victoria"]),
  new Set(["Miedo","Peligro","Veneno","Muerte"]),
  new Set(["MÃºsica","Sonido","Ritmo","Danza","Cantar","Bailar"]),
  new Set(["Arte","PoesÃ­a","Pintura","Danza"]),
  new Set(["Ciencia","Medicina","Laboratorio","Microscopio","Telescopio"]),
  new Set(["MaÃ±ana","Tarde","Noche","Semana","Mes","AÃ±o","Siglo","Pasado","Presente","Futuro","Eternidad"]),
  new Set(["Mano","Pie","Ojo","Oreja","Nariz","Boca","Diente","Pelo","Piel","UÃ±a","MÃºsculo","Hueso","Esqueleto","Nervio","Cerebro","CorazÃ³n","PulmÃ³n","Sangre"]),
  new Set(["Cuchillo","Tenedor","Cuchara","Plato","Vaso","SartÃ©n","Olla","Horno","Nevera","Microondas"]),
  new Set(["Cama","Almohada","SÃ¡bana","Manta"]),
  new Set(["Silla","Mesa","Cortina","Ventana","Puerta","LÃ¡mpara"]),
  new Set(["Lavadora","Aspiradora","Plancha","Ventilador","Estufa","Grifo"]),
  new Set(["Coche","Bicicleta","Tren","AviÃ³n","Barco","Metro"]),
  new Set(["Rojo","Azul","Verde","Amarillo","Blanco","Negro"]),
  new Set(["Grande","PequeÃ±o","Largo","Corto","Alto","Bajo"]),
  new Set(["RÃ¡pido","Lento","Velocidad","Tiempo"]),
  new Set(["Caliente","Helado","FrÃ­o","Calor"]),
  new Set(["Dulce","Salado","Amargo","Picante"]),
  new Set(["Sucio","Limpio","Mojado","Seco"]),
  new Set(["Fuerte","DÃ©bil","Duro","Blando","Suave","Ãspero"]),
  new Set(["Lleno","VacÃ­o","Abierto","Cerrado"]),
  new Set(["Arriba","Abajo","Dentro","Fuera","Cerca","Lejos"]),
  new Set(["Norte","Sur","Este","Oeste"]),
  new Set(["Vivo","Muerto","Sano","Enfermo"]),
  new Set(["Rico","Pobre","Deuda","Dinero","Oro"]),
  new Set(["Zombi","Vampiro","Fantasma","DragÃ³n","Sirena"]),
  new Set(["Pirata","Vikingo","Ninja","Caballero","Vaquero"]),
  new Set(["Rey","Juez","PolÃ­tico","Banquero"]),
  new Set(["MÃ©dico","Veterinario","Enfermero"]),
  new Set(["Detective","EspÃ­a","PolicÃ­a"]),
  new Set(["Cantante","BailarÃ­n","Actor","Artista"]),
];

const SIMILAR_GROUPS_EN = [
  new Set(["Jungle","Forest","Woods"]),
  new Set(["Ocean","Sea","River","Lake","Pond","Reef"]),
  new Set(["Mountain","Volcano","Cliff","Valley"]),
  new Set(["Desert","Meadow","Swamp","Glacier"]),
  new Set(["Beach","Island","Harbor","Lighthouse"]),
  new Set(["City","Village","Square","Alley","Market","Skyscraper","Highway","Subway"]),
  new Set(["Church","Cathedral","Mosque","Temple","Sanctuary","Altar"]),
  new Set(["Hospital","University","School","Laboratory","Precinct","Barracks","Courthouse"]),
  new Set(["Hotel","Mansion","Castle"]),
  new Set(["Cinema","Theater","Circus","Casino","Stadium","Gym"]),
  new Set(["Store","Market","Bank"]),
  new Set(["Star","Moon","Sun","Planet","Comet","Galaxy","Universe","Space","Mars","Satellite","Rocket"]),
  new Set(["Fire","Heat","Flame"]),
  new Set(["Snow","Ice","Glacier","Cold","Frozen","Pole"]),
  new Set(["Water","Rain","River","Ocean","Lake"]),
  new Set(["Tree","Flower","Garden","Greenhouse","Forest","Jungle"]),
  new Set(["Cloud","Rain","Fog","Horizon"]),
  new Set(["Dog","Cat","Rabbit","Mouse"]),
  new Set(["Lion","Tiger","Leopard"]),
  new Set(["Whale","Dolphin","Shark","Fish"]),
  new Set(["Eagle","Owl","Bird"]),
  new Set(["Spider","Ant","Bee","Butterfly"]),
  new Set(["Snake","Crocodile","Frog","Turtle"]),
  new Set(["Cow","Sheep","Pig","Horse","Chicken"]),
  new Set(["Love","Hate","Envy","Pride","Anger","Joy","Sadness"]),
  new Set(["War","Peace","Crime","Justice","Law","Defeat","Victory"]),
  new Set(["Music","Sound","Rhythm","Dance","Sing"]),
  new Set(["Art","Poetry","Painting","Dance"]),
  new Set(["Science","Medicine","Laboratory","Microscope","Telescope"]),
  new Set(["Morning","Night","Week","Month","Year","Century","Past","Present","Future","Eternity"]),
  new Set(["Hand","Foot","Eye","Ear","Nose","Mouth","Tooth","Hair","Skin","Muscle","Bone","Brain","Heart","Lung","Blood"]),
  new Set(["Knife","Fork","Spoon","Plate","Cup","Pan","Oven","Fridge","Microwave"]),
  new Set(["Bed","Pillow","Blanket"]),
  new Set(["Chair","Table","Curtain","Lamp"]),
  new Set(["Car","Bicycle","Train","Airplane","Ship","Subway"]),
  new Set(["Red","Blue","Green","Yellow","White","Black"]),
  new Set(["Big","Small","Long","Short"]),
  new Set(["Fast","Slow","Speed","Time"]),
  new Set(["Hot","Cold","Heat","Frozen"]),
  new Set(["Sweet","Salty","Bitter","Spicy"]),
  new Set(["Dirty","Clean","Wet","Dry"]),
  new Set(["Strong","Weak","Hard","Soft","Smooth","Rough"]),
  new Set(["Full","Empty","Open","Closed"]),
  new Set(["Up","Down","Inside","Outside","Near","Far"]),
  new Set(["North","South","East","West"]),
  new Set(["Alive","Dead","Healthy","Sick"]),
  new Set(["Rich","Poor","Debt","Money","Gold"]),
  new Set(["Zombie","Vampire","Ghost","Dragon","Mermaid"]),
  new Set(["Pirate","Viking","Ninja","Knight","Cowboy"]),
  new Set(["Doctor","Vet"]),
  new Set(["Detective","Spy","Police"]),
  new Set(["Singer","Dancer","Actor","Artist"]),
];

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  TRANSLATIONS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const T = {
  en: {
    sub: "Online Cooperative Word Game",
    yourName: "Your Name", joinName: "Your Name",
    enterCode: "Room Code", timerToggle: "Enable timer", secs: "sec",
    createBtn: "Create Room", joinBtn: "Join Room",
    roomCode: "Room Code â€” share with everyone",
    playersJoined: "Players in room",
    waitingText: "Waiting for players",
    startGame: "Start Game â†’",
    nowPlaying: "Now Playing", players: "Players",
    target: "Target", giveClue: "Your Clue",
    theClue: "The Clue", oneWord: "one word",
    guessInstruction: "Tap the grid cell that matches!",
    hintNote: "Give one word that hints at both!",
    giver: "Clue Giver", guesser: "Guesser",
    cluePlaceholder: "one wordâ€¦", giveBtn: "Give Clue â†’",
    log: "Log", quit: "Quit", newGame: "New Game",
    statMatched: "Matched", statRounds: "Rounds",
    playAgain: "Play Again (same room)", goHome: "Leave Room",
    newGame: "New Game", gameMode: "Game Mode",
    modeCoop: "Cooperative", modeTeams: "Teams",
    assignTeams: "Assign players to teams",
    team: "Team", team1: "Team 1", team2: "Team 2",
    wins: "wins", tieGame: "It's a tie!",
    teamsNeedBoth: "Each team needs at least 1 player.",
    sameTeamWatch: "Your team is giving â€” watch!",
    otherTeamGuessing: "Other team is guessingâ€¦",
    congratsTitle: "Congratulations!",
    congratsSub: n => `You matched all ${n} pairs!`,
    wrongMsg: (clue, rw, cw) => `"${clue}" was for ${rw} Ã— ${cw}`,
    p1def: "Player 1", p2def: "Player 2",
    partnerThinking: name => `${name} is giving a clueâ€¦`,
    waitingGuess: name => `${name} is guessingâ€¦`,
    roundLog: (n, c) => `${n}: "${c}"`,
    correctLog: (c, r, col) => `âœ“ "${c}" â†’ ${r}Ã—${col}`,
    wrongLog: (c, r, col) => `âœ— "${c}" â†’ ${r}Ã—${col}`,
    joinError: "Room not found. Check the code.",
    roomFull: "Room is full (max 10 players).",
    codedRoom: code => `Room: ${code}`,
    copiedCode: "Room code copied!",
    needPlayers: "Need at least 2 players to start.",
    waitingForHost: "Waiting for host to start the gameâ€¦",
    youLabel: "you",
  },
  es: {
    sub: "Juego cooperativo de palabras en lÃ­nea",
    yourName: "Tu Nombre", joinName: "Tu Nombre",
    enterCode: "CÃ³digo de Sala", timerToggle: "Activar temporizador", secs: "seg",
    createBtn: "Crear Sala", joinBtn: "Unirse",
    roomCode: "CÃ³digo de Sala â€” comparte con todos",
    playersJoined: "Jugadores en la sala",
    waitingText: "Esperando jugadores",
    startGame: "Empezar Partida â†’",
    nowPlaying: "Turno de", players: "Jugadores",
    target: "Objetivo", giveClue: "Tu Pista",
    theClue: "La Pista", oneWord: "una palabra",
    guessInstruction: "Â¡Toca la celda del tablero que corresponde!",
    hintNote: "Â¡Da una palabra que insinÃºe las dos!",
    giver: "Da la Pista", guesser: "Adivina",
    cluePlaceholder: "una palabraâ€¦", giveBtn: "Dar Pista â†’",
    log: "Registro", quit: "Salir", newGame: "Nuevo Juego",
    statMatched: "Adivinadas", statRounds: "Rondas",
    playAgain: "Nueva Partida (misma sala)", goHome: "Salir de la sala",
    newGame: "Nuevo Juego", gameMode: "Modo de Juego",
    modeCoop: "Cooperativo", modeTeams: "Equipos",
    assignTeams: "Asignar jugadores a equipos",
    team: "Equipo", team1: "Equipo 1", team2: "Equipo 2",
    wins: "gana", tieGame: "Â¡Empate!",
    teamsNeedBoth: "Cada equipo necesita al menos 1 jugador.",
    sameTeamWatch: "Tu equipo da la pista â€” Â¡observÃ¡!",
    otherTeamGuessing: "El otro equipo estÃ¡ adivinandoâ€¦",
    congratsTitle: "Â¡Felicidades!",
    congratsSub: n => `Â¡Adivinasteis las ${n} parejas!`,
    wrongMsg: (clue, rw, cw) => `"${clue}" era para ${rw} Ã— ${cw}`,
    p1def: "Jugador 1", p2def: "Jugador 2",
    partnerThinking: name => `${name} estÃ¡ dando una pistaâ€¦`,
    waitingGuess: name => `${name} estÃ¡ adivinandoâ€¦`,
    roundLog: (n, c) => `${n}: "${c}"`,
    correctLog: (c, r, col) => `âœ“ "${c}" â†’ ${r}Ã—${col}`,
    wrongLog: (c, r, col) => `âœ— "${c}" â†’ ${r}Ã—${col}`,
    joinError: "Sala no encontrada. Verifica el cÃ³digo.",
    roomFull: "La sala estÃ¡ llena (mÃ¡x. 10 jugadores).",
    codedRoom: code => `Sala: ${code}`,
    copiedCode: "Â¡CÃ³digo copiado!",
    needPlayers: "Se necesitan al menos 2 jugadores.",
    waitingForHost: "Esperando que el anfitriÃ³n empiece la partidaâ€¦",
    youLabel: "tÃº",
  }
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  PLAYER COLORS (up to 10)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const PLAYER_COLORS = [
  '#c0392b','#1a6fa8','#2e7d52','#7b3fa0',
  '#d4a017','#00868a','#e07b39','#5a5a9c',
  '#8b4513','#1a7a4a'
];

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let lang = 'en';
let myPlayerId = null;
let myName = '';
let isHost = false;
let roomId = null;
let roomRef = null;
let gstate = null;
let selectedMode = 'coop';   // 'coop' | 'teams'
let teamAssignments = {};    // { playerId: 1|2 }

let timerInterval = null;
let localTimerLeft = 0;

const t = (key, ...args) => {
  const v = T[lang]?.[key];
  return typeof v === 'function' ? v(...args) : (v ?? key);
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  UTILS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function shuffle(arr) {
  const a = [...arr];
  for (let i = a.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [a[i], a[j]] = [a[j], a[i]];
  }
  return a;
}
function genCode() {
  const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
  return Array.from({length:6}, () => chars[Math.floor(Math.random()*chars.length)]).join('');
}
function genPlayerId() { return Math.random().toString(36).slice(2) + Date.now().toString(36); }
// â”€â”€ SOUND â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function playPing() {
  try {
    const ctx = new (window.AudioContext || window.webkitAudioContext)();
    const osc = ctx.createOscillator();
    const gain = ctx.createGain();
    osc.connect(gain);
    gain.connect(ctx.destination);
    osc.type = 'sine';
    osc.frequency.setValueAtTime(880, ctx.currentTime);
    osc.frequency.exponentialRampToValueAtTime(660, ctx.currentTime + 0.15);
    gain.gain.setValueAtTime(0.18, ctx.currentTime);
    gain.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + 0.5);
    osc.start(ctx.currentTime);
    osc.stop(ctx.currentTime + 0.5);
  } catch(e) {}
}

function showToast(msg, dur = 3000) {
  const el = document.getElementById('toast');
  el.textContent = msg;
  el.classList.add('show');
  setTimeout(() => el.classList.remove('show'), dur);
}
function showScreen(id) {
  document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
  document.getElementById(id).classList.add('active');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  SOUND
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function playSound(type) {
  try {
    const ctx = new (window.AudioContext || window.webkitAudioContext)();
    const osc = ctx.createOscillator();
    const gain = ctx.createGain();
    osc.connect(gain); gain.connect(ctx.destination);
    if (type === 'clue_ready') {
      osc.frequency.setValueAtTime(520, ctx.currentTime);
      osc.frequency.setValueAtTime(780, ctx.currentTime + 0.13);
      gain.gain.setValueAtTime(0.18, ctx.currentTime);
      gain.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + 0.45);
      osc.start(ctx.currentTime); osc.stop(ctx.currentTime + 0.45);
    } else if (type === 'correct') {
      osc.frequency.setValueAtTime(660, ctx.currentTime);
      osc.frequency.setValueAtTime(880, ctx.currentTime + 0.1);
      gain.gain.setValueAtTime(0.15, ctx.currentTime);
      gain.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + 0.4);
      osc.start(ctx.currentTime); osc.stop(ctx.currentTime + 0.4);
    } else if (type === 'wrong') {
      osc.type = 'sawtooth';
      osc.frequency.setValueAtTime(220, ctx.currentTime);
      osc.frequency.setValueAtTime(180, ctx.currentTime + 0.12);
      gain.gain.setValueAtTime(0.12, ctx.currentTime);
      gain.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + 0.35);
      osc.start(ctx.currentTime); osc.stop(ctx.currentTime + 0.35);
    }
  } catch(e) {}
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  LANGUAGE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
window.setLang = (l) => {
  lang = l;
  document.querySelectorAll('.lang-pill').forEach((b,i) => {
    b.classList.toggle('active', (i===0&&l==='en')||(i===1&&l==='es'));
  });
  applyLobbyTranslations();
};

function applyLobbyTranslations() {
  const ids = {
    'lg-sub':'sub','lbl-your-name':'yourName','lbl-join-name':'joinName',
    'lbl-enter-code':'enterCode','lbl-timer-toggle':'timerToggle','lbl-secs':'secs',
    'btn-create':'createBtn','btn-join':'joinBtn','lbl-room-code':'roomCode',
    'lbl-players-joined':'playersJoined','waiting-text':'waitingText',
    'start-game-btn':'startGame','lbl-game-mode':'gameMode',
    'lbl-mode-coop':'modeCoop','lbl-mode-teams':'modeTeams',
    'lbl-assign-teams':'assignTeams',
  };
  Object.entries(ids).forEach(([id,key]) => {
    const el = document.getElementById(id);
    if (el) el.textContent = t(key);
  });
  const cn = document.getElementById('create-name');
  if (cn) cn.placeholder = t('p1def');
  const jn = document.getElementById('join-name');
  if (jn) jn.placeholder = t('p2def');
}

function applyGameTranslations() {
  const ids = {
    'lbl-now-playing':'nowPlaying','lbl-players':'players','lbl-target':'target',
    'lbl-give-clue':'giveClue','lbl-the-clue':'theClue','lbl-one-word':'oneWord',
    'guess-tip':'guessInstruction','lbl-log':'log','btn-quit':'quit',
    'btn-new-game':'newGame',
  };
  Object.entries(ids).forEach(([id,key]) => {
    const el = document.getElementById(id);
    if (el) el.textContent = t(key);
  });
  const ci = document.getElementById('clue-input');
  if (ci) ci.placeholder = t('cluePlaceholder');
  const gb = document.getElementById('give-btn');
  if (gb) gb.textContent = t('giveBtn');
}

window.onTimerToggle = () => {
  document.getElementById('timer-secs').disabled = !document.getElementById('timer-toggle').checked;
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  MODE SELECTION (lobby)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
window.selectMode = (mode) => {
  selectedMode = mode;
  document.getElementById('mode-pill-coop').classList.toggle('active', mode==='coop');
  document.getElementById('mode-pill-teams').classList.toggle('active', mode==='teams');
  document.getElementById('teams-config').style.display = mode==='teams' ? '' : 'none';
  if (mode==='teams' && gstate) renderTeamAssign(gstate.players||[]);
};

function renderTeamAssign(players) {
  const container = document.getElementById('team-assign-list');
  if (!container) return;
  container.innerHTML = '';
  players.forEach(p => {
    if (!teamAssignments[p.id]) teamAssignments[p.id] = 1;
    const row = document.createElement('div');
    row.className = 'team-assign-row';
    const nameEl = document.createElement('span');
    nameEl.className = 'team-assign-name';
    nameEl.textContent = p.id === myPlayerId ? `${p.name} (${t('youLabel')})` : p.name;
    const sel = document.createElement('select');
    sel.className = 'team-select';
    sel.innerHTML = `<option value="1">ğŸ”´ ${t('team1')}</option><option value="2">ğŸ”µ ${t('team2')}</option>`;
    sel.value = String(teamAssignments[p.id]);
    sel.onchange = () => { teamAssignments[p.id] = parseInt(sel.value); };
    row.appendChild(nameEl);
    row.appendChild(sel);
    container.appendChild(row);
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  CREATE ROOM
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
window.createRoom = async () => {
  const name = document.getElementById('create-name').value.trim() || t('p1def');
  const useTimer = document.getElementById('timer-toggle').checked;
  const timerSecs = parseInt(document.getElementById('timer-secs').value)||90;
  myPlayerId = genPlayerId(); myName = name; isHost = true; roomId = genCode();
  const roomData = {
    created: Date.now(), lang, useTimer, timerSecs,
    status: 'lobby', hostId: myPlayerId,
    players: [{ id: myPlayerId, name }], game: null,
  };
  roomRef = ref(db, `rooms/${roomId}`);
  await set(roomRef, roomData);
  document.getElementById('create-section').style.display = 'none';
  document.getElementById('or-div').style.display = 'none';
  document.getElementById('join-section').style.display = 'none';
  document.getElementById('waiting-section').style.display = '';
  document.getElementById('room-code-value').textContent = roomId;
  document.getElementById('mode-selector').style.display = 'none';
  listenRoom();
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  JOIN ROOM
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
window.joinRoom = async () => {
  const name = document.getElementById('join-name').value.trim() || t('p2def');
  const code = document.getElementById('join-code').value.trim().toUpperCase();
  if (!code || code.length < 4) { showJoinError(t('joinError')); return; }
  const snap = await get(ref(db, `rooms/${code}`));
  if (!snap.exists()) { showJoinError(t('joinError')); return; }
  const data = snap.val();
  if ((data.players||[]).length >= 10) { showJoinError(t('roomFull')); return; }
  myPlayerId = genPlayerId(); myName = name; isHost = false;
  roomId = code; lang = data.lang || 'en';
  document.querySelectorAll('.lang-pill').forEach((b,i) => {
    b.classList.toggle('active', (i===0&&lang==='en')||(i===1&&lang==='es'));
  });
  roomRef = ref(db, `rooms/${roomId}`);
  await update(roomRef, { players: [...(data.players||[]), {id:myPlayerId, name}] });
  listenRoom();
  document.getElementById('create-section').style.display = 'none';
  document.getElementById('or-div').style.display = 'none';
  document.getElementById('join-section').style.display = 'none';
  document.getElementById('waiting-section').style.display = '';
  document.getElementById('room-code-value').textContent = roomId;
  document.getElementById('start-game-btn').style.display = 'none';
  document.getElementById('mode-selector').style.display = 'none';
};

function showJoinError(msg) {
  const el = document.getElementById('join-status');
  el.textContent = msg; el.className = 'status-msg error'; el.style.display = '';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  HOST START GAME
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
window.hostStartGame = async () => {
  if (!isHost || !roomRef) return;
  const snap = await get(roomRef);
  if (!snap.exists()) return;
  const data = snap.val();
  const players = data.players || [];
  if (players.length < 2) { showToast(t('needPlayers')); return; }
  if (selectedMode === 'teams') {
    const t1 = players.filter(p => (teamAssignments[p.id]||1) === 1);
    const t2 = players.filter(p => (teamAssignments[p.id]||1) === 2);
    if (t1.length === 0 || t2.length === 0) { showToast(t('teamsNeedBoth')); return; }
  }
  const gameData = buildNewGameData(players, data.lang||lang, selectedMode, teamAssignments);
  await update(roomRef, { status:'playing', mode:selectedMode, game:gameData });
  const newData = { ...data, status:'playing', mode:selectedMode, game:gameData };
  gstate = newData;
  applyGameTranslations();
  showScreen('game');
  document.getElementById('hdr-room').textContent = roomId;
  renderGame(newData);
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  BUILD NEW GAME DATA
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function buildNewGameData(players, gameLang, mode, teamsMap) {
  const G = 5;
  const L = gameLang || lang;
  const pool = shuffle(WORDS[L] || WORDS.es);
  const groups = L === 'en' ? SIMILAR_GROUPS_EN : SIMILAR_GROUPS_ES;

  function pickWords(source, count) {
    const picked = [];
    for (const word of source) {
      if (picked.length >= count) break;
      if (!groups.some(g => g.has(word) && picked.some(p => g.has(p)))) picked.push(word);
    }
    while (picked.length < count) {
      const w = source.find(w => !picked.includes(w));
      if (w) picked.push(w); else break;
    }
    return picked;
  }

  const rowWords = pickWords(pool, G);
  const colWords = pickWords(pool.filter(w => !rowWords.includes(w)), G);
  const allCells = [];
  for (let r=0;r<G;r++) for (let c=0;c<G;c++) allCells.push(`${r},${c}`);

  // Build teams structure
  let teams = null;
  if (mode === 'teams' && teamsMap) {
    const t1 = players.filter(p => (teamsMap[p.id]||1) === 1);
    const t2 = players.filter(p => (teamsMap[p.id]||1) === 2);
    teams = {
      1: { players: t1, score: 0, giverIndex: Math.floor(Math.random()*t1.length) },
      2: { players: t2, score: 0, giverIndex: Math.floor(Math.random()*t2.length) },
    };
  }

  // Random starting player
  const startIdx = Math.floor(Math.random() * players.length);

  return {
    rowWords, colWords, targetOrder: shuffle(allCells),
    targetIndex: 0,
    mode: mode || 'coop',
    teams,
    currentTeam: 1,              // teams mode: which team's turn
    currentPlayerIndex: startIdx, // coop mode: who is giver
    phase: 'giving',
    currentClue: '',
    guessed: [], missed: [],
    rounds: 0,
    log: [],
    timerStartedAt: null,
  };
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  LISTEN TO ROOM
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function listenRoom() {
  if (!roomRef) return;
  off(roomRef);
  onValue(roomRef, (snap) => {
    if (!snap.exists()) return;
    const data = snap.val();
    gstate = data;
    lang = data.lang || lang;
    const players = data.players || [];

    if (data.status === 'lobby') {
      renderLobbyPlayers(players);
      if (isHost) {
        const startBtn = document.getElementById('start-game-btn');
        startBtn.disabled = players.length < 2;
        const modeEl = document.getElementById('mode-selector');
        if (modeEl) modeEl.style.display = players.length >= 2 ? '' : 'none';
        if (selectedMode === 'teams') renderTeamAssign(players);
      }
      return;
    }

    if (data.status === 'playing' && data.game) {
      const prevPhase = gstate && gstate.game ? gstate.game.phase : null;
      const prevClue  = gstate && gstate.game ? gstate.game.currentClue : '';
      applyGameTranslations();
      showScreen('game');
      document.getElementById('hdr-room').textContent = roomId;
      renderGame(data);
      // Play a soft ping for guessers when a new clue just arrived
      const players = data.players || [];
      const giverPlayer = players[data.game.currentPlayerIndex ?? 0];
      const amGiver = giverPlayer && giverPlayer.id === myPlayerId;
      if (!amGiver && data.game.phase === 'guessing' &&
          (prevPhase !== 'guessing' || prevClue !== data.game.currentClue)) {
        playPing();
      }
    }

    if (data.status === 'ended' && data.game) {
      renderEndScreen(data);
    }
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  LOBBY PLAYER LIST
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderLobbyPlayers(players) {
  const list = document.getElementById('lobby-players-list');
  if (!list) return;
  list.innerHTML = '';
  players.forEach((p, i) => {
    const chip = document.createElement('div');
    chip.className = 'player-chip';
    const dot = document.createElement('div');
    dot.className = 'player-chip-dot';
    dot.style.background = PLAYER_COLORS[i % PLAYER_COLORS.length];
    chip.appendChild(dot);
    const nameEl = document.createElement('span');
    nameEl.textContent = p.id === myPlayerId ? `${p.name} (${t('youLabel')})` : p.name;
    chip.appendChild(nameEl);
    list.appendChild(chip);
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  RENDER GAME  (mode-aware)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderGame(data) {
  const g = data.game;
  const players = data.players || [];
  const mode = g.mode || 'coop';
  const guessedSet = new Set(g.guessed || []);
  const missedSet  = new Set(g.missed  || []);

  // â”€â”€ Determine giver and whether I can guess â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  let giverPlayer, amGiver, amGuesser, activeTeamN;

  if (mode === 'teams' && g.teams) {
    activeTeamN = g.currentTeam || 1;
    const teamData = g.teams[activeTeamN];
    const gi = (teamData.giverIndex || 0) % teamData.players.length;
    giverPlayer = teamData.players[gi];
    amGiver = giverPlayer?.id === myPlayerId;
    // Guessing team = the OTHER team
    const myTeamN = getMyTeam(g);
    amGuesser = (myTeamN !== null) && (myTeamN !== activeTeamN);
  } else {
    const idx = g.currentPlayerIndex ?? 0;
    giverPlayer = players[idx] || players[0];
    amGiver   = giverPlayer?.id === myPlayerId;
    amGuesser = !amGiver;
  }

  // â”€â”€ Score â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  document.getElementById('hdr-score').textContent =
    `${guessedSet.size} / ${g.rowWords.length * g.colWords.length}`;

  // â”€â”€ Teams score bar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const bar = document.getElementById('teams-score-bar');
  if (mode === 'teams' && g.teams) {
    bar.style.display = '';
    bar.innerHTML = '';
    [1,2].forEach(n => {
      const td = g.teams[n];
      const chip = document.createElement('div');
      chip.className = 'team-score-chip' + (n === activeTeamN ? ' active-team' : '');
      chip.style.cssText = n===1
        ? 'background:rgba(192,57,43,.1);border-color:#c0392b;color:#c0392b'
        : 'background:rgba(26,111,168,.1);border-color:#1a6fa8;color:#1a6fa8';
      chip.innerHTML = `<div class="team-score-n">${td.score||0}</div>
        <div class="team-score-label">${t('team')} ${n}${n===activeTeamN?' ğŸ¯':''}</div>`;
      bar.appendChild(chip);
    });
  } else {
    bar.style.display = 'none';
  }

  // â”€â”€ Timer â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  if (data.useTimer) {
    document.getElementById('hdr-timer').style.display = '';
    if (g.timerStartedAt) startLocalTimer(data.timerSecs, g.timerStartedAt);
    else stopLocalTimer();
  } else {
    document.getElementById('hdr-timer').style.display = 'none';
    stopLocalTimer();
  }

  // â”€â”€ Players strip â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  renderPlayersStrip(players, giverPlayer, mode, g.teams, activeTeamN);

  // â”€â”€ Active player card â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const giverColor = mode === 'teams'
    ? (activeTeamN === 1 ? '#c0392b' : '#1a6fa8')
    : PLAYER_COLORS[(g.currentPlayerIndex??0) % PLAYER_COLORS.length];
  document.getElementById('p-avatar').textContent =
    (giverPlayer?.name||'?').charAt(0).toUpperCase();
  document.getElementById('p-avatar').style.background = giverColor;
  document.getElementById('p-avatar').style.color = '#fff';
  document.getElementById('p-name-display').textContent = giverPlayer?.name || 'â€”';
  document.getElementById('p-role-display').textContent = t('giver');

  // â”€â”€ Side panels â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const giverBlock     = document.getElementById('giver-block');
  const clueInputBlock = document.getElementById('clue-input-block');
  const guesserBlock   = document.getElementById('guesser-block');
  const waitingBlock   = document.getElementById('waiting-block');
  giverBlock.style.display = clueInputBlock.style.display =
  guesserBlock.style.display = waitingBlock.style.display = 'none';

  if (g.phase === 'giving') {
    if (amGiver) {
      giverBlock.style.display = clueInputBlock.style.display = '';
      document.getElementById('clue-input').disabled = false;
      document.getElementById('give-btn').disabled = false;
      document.getElementById('clue-input').value = '';
      setTimeout(() => document.getElementById('clue-input').focus(), 100);
      const tgt = currentTargetFromState(g);
      if (tgt) {
        const [tr,tc] = tgt.split(',').map(Number);
        document.getElementById('tc-coord').textContent =
          `${String.fromCharCode(65+tr)}${tc+1}`;
        document.getElementById('tc-pair').innerHTML =
          `<span class="tw tw-row">${g.rowWords[tr]}</span>
           <span class="tw-sep">Ã—</span>
           <span class="tw tw-col">${g.colWords[tc]}</span>`;
        document.getElementById('tc-hint').textContent = t('hintNote');
        highlightTargetCell(`${tr},${tc}`);
      }
    } else {
      waitingBlock.style.display = '';
      document.getElementById('waiting-note-text').textContent =
        t('partnerThinking', giverPlayer?.name || '?');
    }
  } else { // guessing
    const newClue = g.currentClue || 'â€”';
    if (newClue !== 'â€”' && newClue !== document.getElementById('revealed-clue').textContent) {
      playSound('clue_ready');
    }
    document.getElementById('revealed-clue').textContent = newClue;

    if (amGuesser) {
      guesserBlock.style.display = '';
    } else {
      // Giver and same-team watchers see the clue but can't click
      guesserBlock.style.display = '';
      waitingBlock.style.display = '';
      const watchMsg = amGiver
        ? t('waitingGuess', 'â€¦')
        : (mode === 'teams' ? t('sameTeamWatch') : t('waitingGuess', 'â€¦'));
      document.getElementById('waiting-note-text').textContent = watchMsg;
    }
  }

  buildGrid(g, guessedSet, missedSet, g.phase, amGuesser);
  renderLog(g.log || []);
}

function getMyTeam(g) {
  if (!g.teams) return null;
  for (const n of [1,2]) {
    if ((g.teams[n]?.players||[]).some(p => p.id === myPlayerId)) return n;
  }
  return null;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  PLAYERS STRIP
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderPlayersStrip(players, giverPlayer, mode, teams, activeTeamN) {
  const strip = document.getElementById('players-strip');
  strip.innerHTML = '';

  if (mode === 'teams' && teams) {
    // Show two team columns
    [1,2].forEach(n => {
      const teamEl = document.createElement('div');
      teamEl.style.cssText = 'display:flex;flex-direction:column;gap:.25rem;flex:1;';
      const hdr = document.createElement('div');
      hdr.style.cssText = `font-size:.65rem;font-weight:700;text-transform:uppercase;
        letter-spacing:.08em;color:${n===1?'#c0392b':'#1a6fa8'};margin-bottom:.15rem;`;
      hdr.textContent = `${t('team')} ${n}${n===activeTeamN?' ğŸ¯':''}`;
      teamEl.appendChild(hdr);
      (teams[n]?.players||[]).forEach(p => {
        const pill = document.createElement('div');
        pill.className = 'player-pill' + (p.id===myPlayerId?' is-me':'') +
          (p.id===giverPlayer?.id?' active-player':'');
        pill.style.borderColor = n===1?'rgba(192,57,43,.3)':'rgba(26,111,168,.3)';
        const dot = document.createElement('div');
        dot.className = 'pill-dot';
        dot.style.background = n===1?'#c0392b':'#1a6fa8';
        const nameEl = document.createElement('span');
        nameEl.textContent = p.id===myPlayerId ? `${p.name}(${t('youLabel')})` : p.name;
        pill.appendChild(dot); pill.appendChild(nameEl);
        if (p.id===giverPlayer?.id) {
          const role = document.createElement('span');
          role.className = 'pill-role'; role.textContent = t('giver');
          pill.appendChild(role);
        }
        teamEl.appendChild(pill);
      });
      strip.appendChild(teamEl);
    });
  } else {
    players.forEach((p, i) => {
      const pill = document.createElement('div');
      pill.className = 'player-pill' +
        (p.id===giverPlayer?.id?' active-player':'') +
        (p.id===myPlayerId?' is-me':'');
      const dot = document.createElement('div');
      dot.className = 'pill-dot';
      dot.style.background = PLAYER_COLORS[i % PLAYER_COLORS.length];
      const nameEl = document.createElement('span');
      nameEl.textContent = p.id===myPlayerId ? `${p.name} (${t('youLabel')})` : p.name;
      pill.appendChild(dot); pill.appendChild(nameEl);
      if (p.id===giverPlayer?.id) {
        const role = document.createElement('span');
        role.className = 'pill-role'; role.textContent = t('giver');
        pill.appendChild(role);
      }
      strip.appendChild(pill);
    });
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  GRID
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function buildGrid(g, guessedSet, missedSet, phase, amGuesser) {
  const wrap = document.getElementById('grid-wrap');
  const needsRebuild = !wrap.querySelector('.col-headers') ||
    wrap.dataset.rowWords !== g.rowWords.join(',') ||
    wrap.dataset.colWords !== g.colWords.join(',');

  if (needsRebuild) {
    wrap.innerHTML = '';
    wrap.dataset.rowWords = g.rowWords.join(',');
    wrap.dataset.colWords = g.colWords.join(',');
    const G = g.rowWords.length;
    const colHdr = document.createElement('div');
    colHdr.className = 'col-headers';
    for (let c=0;c<G;c++) {
      const d = document.createElement('div');
      d.className = 'col-hdr'; d.textContent = g.colWords[c];
      colHdr.appendChild(d);
    }
    wrap.appendChild(colHdr);
    for (let r=0;r<G;r++) {
      const row = document.createElement('div');
      row.className = 'grid-row-wrap';
      const rh = document.createElement('div');
      rh.className = 'row-hdr'; rh.textContent = g.rowWords[r];
      row.appendChild(rh);
      for (let c=0;c<G;c++) {
        const cell = document.createElement('div');
        cell.className = 'cell'; cell.id = `cell-${r}-${c}`;
        row.appendChild(cell);
      }
      wrap.appendChild(row);
    }
  }

  const G = g.rowWords.length;
  for (let r=0;r<G;r++) {
    for (let c=0;c<G;c++) {
      const cell = document.getElementById(`cell-${r}-${c}`);
      if (!cell) continue;
      const key = `${r},${c}`;
      const wasGuessed = cell.classList.contains('guessed');
      const wasMissed  = cell.classList.contains('missed');
      const isGuessed  = guessedSet.has(key);
      const isMissed   = missedSet.has(key);
      const fresh = cell.cloneNode(false);
      cell.parentNode.replaceChild(fresh, cell);
      const el = document.getElementById(`cell-${r}-${c}`);
      el.className = 'cell';

      if (isGuessed) {
        el.classList.add('guessed','disabled');
        el.innerHTML = `<div class="cell-check">âœ“</div>`;
        if (!wasGuessed) {
          el.classList.add('guessed-pop');
          el.addEventListener('animationend', () => el.classList.remove('guessed-pop'), {once:true});
        }
      } else if (isMissed) {
        el.classList.add('missed','disabled');
        el.innerHTML = `<div class="cell-miss-icon">âœ•</div>
          <div class="cell-coord">${String.fromCharCode(65+r)}${c+1}</div>`;
        if (!wasMissed) {
          el.classList.add('missed-pop');
          el.addEventListener('animationend', () => el.classList.remove('missed-pop'), {once:true});
        }
      } else {
        el.innerHTML = `<div class="cell-coord">${String.fromCharCode(65+r)}${c+1}</div>`;
        if (phase==='guessing' && amGuesser) {
          el.addEventListener('click', () => onCellClick(r,c));
        } else {
          el.classList.add('disabled');
        }
      }
    }
  }
}

function highlightTargetCell(key) {
  document.querySelectorAll('.cell').forEach(c => c.classList.remove('active-target'));
  const [r,c] = key.split(',');
  const el = document.getElementById(`cell-${r}-${c}`);
  if (el) el.classList.add('active-target');
}

function currentTargetFromState(g) {
  const guessedSet = new Set(g.guessed||[]);
  const order = g.targetOrder||[];
  for (let i=g.targetIndex||0; i<order.length; i++) {
    if (!guessedSet.has(order[i])) return order[i];
  }
  return null;
}

function renderLog(entries) {
  const scroll = document.getElementById('log-scroll');
  scroll.innerHTML = '';
  [...entries].reverse().forEach(entry => {
    const div = document.createElement('div');
    div.className = 'log-entry';
    div.innerHTML = `<span class="li">${entry.icon}</span><span>${entry.text}</span>`;
    scroll.appendChild(div);
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  CELL CLICK â€” mode-aware
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
window.onCellClick = async (r, c) => {
  if (!gstate?.game) return;
  const g = gstate.game;
  const players = gstate.players || [];
  const mode = g.mode || 'coop';
  if (g.phase !== 'guessing') return;

  // Check I'm allowed to click
  if (mode === 'teams' && g.teams) {
    const activeTeamN = g.currentTeam || 1;
    const myTeamN = getMyTeam(g);
    if (myTeamN === activeTeamN || myTeamN === null) return; // active team can't guess
    const gi = (g.teams[activeTeamN].giverIndex||0) % g.teams[activeTeamN].players.length;
    const giverPlayer = g.teams[activeTeamN].players[gi];
    if (giverPlayer?.id === myPlayerId) return;
  } else {
    const giverPlayer = players[g.currentPlayerIndex??0];
    if (giverPlayer?.id === myPlayerId) return;
  }

  const guessedSet = new Set(g.guessed||[]);
  if (guessedSet.has(`${r},${c}`)) return;
  const tgt = currentTargetFromState(g);
  if (!tgt) return;

  const [tr,tc] = tgt.split(',').map(Number);
  const correct = tgt === `${r},${c}`;
  let newGuessed = [...(g.guessed||[])];
  let newMissed  = [...(g.missed||[])];
  let newLog     = [...(g.log||[])];
  let newTargetIndex = g.targetIndex||0;

  // Advance turn
  let nextPlayerIdx, nextTeam, newTeams;
  if (mode === 'teams' && g.teams) {
    const activeTeamN = g.currentTeam || 1;
    const otherTeamN  = activeTeamN === 1 ? 2 : 1;
    newTeams = JSON.parse(JSON.stringify(g.teams)); // deep copy
    if (correct) {
      newTeams[activeTeamN].score = (newTeams[activeTeamN].score||0) + 1;
    }
    // Advance giver within the active team, then switch teams
    newTeams[activeTeamN].giverIndex =
      ((newTeams[activeTeamN].giverIndex||0) + 1) % newTeams[activeTeamN].players.length;
    nextTeam = otherTeamN;
    nextPlayerIdx = g.currentPlayerIndex;
  } else {
    nextPlayerIdx = ((g.currentPlayerIndex??0) + 1) % players.length;
    nextTeam = null;
    newTeams = null;
  }

  if (correct) {
    playSound('correct');
    newGuessed.push(`${r},${c}`);
    newTargetIndex++;
    newLog.push({ icon:'âœ…', text: t('correctLog', g.currentClue, g.rowWords[tr], g.colWords[tc]) });

    if (newGuessed.length >= g.rowWords.length * g.colWords.length) {
      // Win!
      const winUpdate = { guessed:newGuessed, targetIndex:newTargetIndex,
        log:newLog, phase:'giving', currentClue:'', timerStartedAt:null };
      if (newTeams) winUpdate.teams = newTeams;
      await update(ref(db,`rooms/${roomId}/game`), winUpdate);
      await update(roomRef, { status:'ended' });
      return;
    }
  } else {
    playSound('wrong');
    const el = document.getElementById(`cell-${r}-${c}`);
    if (el) { el.classList.add('wrong-flash'); setTimeout(()=>el.classList.remove('wrong-flash'),600); }
    const missedKey = `${tr},${tc}`;
    if (!newMissed.includes(missedKey)) newMissed.push(missedKey);
    newLog.push({ icon:'âŒ', text: t('wrongLog', g.currentClue, g.rowWords[tr], g.colWords[tc]) });
    newTargetIndex++;
    showToast(t('wrongMsg', g.currentClue, g.rowWords[tr], g.colWords[tc]));
  }

  stopLocalTimer();
  const upd = {
    guessed:newGuessed, missed:newMissed,
    targetIndex:newTargetIndex, log:newLog,
    phase:'giving', currentClue:'', timerStartedAt:null,
    currentPlayerIndex: nextPlayerIdx,
    rounds: (g.rounds||0)+1,
  };
  if (nextTeam !== null) upd.currentTeam = nextTeam;
  if (newTeams)          upd.teams = newTeams;
  await update(ref(db,`rooms/${roomId}/game`), upd);
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  SUBMIT CLUE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
window.submitClue = async () => {
  const clue = document.getElementById('clue-input').value.trim().toUpperCase();
  if (!clue || !gstate?.game) return;
  const g = gstate.game;
  const players = gstate.players||[];
  const mode = g.mode||'coop';
  if (g.phase !== 'giving') return;

  // Verify I'm the giver
  if (mode === 'teams' && g.teams) {
    const activeTeamN = g.currentTeam||1;
    const gi = (g.teams[activeTeamN].giverIndex||0) % g.teams[activeTeamN].players.length;
    if (g.teams[activeTeamN].players[gi]?.id !== myPlayerId) return;
  } else {
    const giverPlayer = players[g.currentPlayerIndex??0];
    if (giverPlayer?.id !== myPlayerId) return;
  }

  document.getElementById('give-btn').disabled = true;
  document.getElementById('clue-input').disabled = true;
  const newLog = [...(g.log||[]), { icon:'ğŸ—£ï¸', text: t('roundLog', myName, clue) }];
  await update(ref(db,`rooms/${roomId}/game`), {
    phase:'guessing', currentClue:clue, log:newLog,
    timerStartedAt: gstate.useTimer ? Date.now() : null,
  });
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  TIMER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function startLocalTimer(totalSecs, startedAt) {
  stopLocalTimer();
  localTimerLeft = Math.max(0, totalSecs - Math.floor((Date.now()-startedAt)/1000));
  renderTimerDisplay();
  timerInterval = setInterval(async () => {
    localTimerLeft--;
    renderTimerDisplay();
    if (localTimerLeft <= 0) { stopLocalTimer(); await handleTimerExpiry(); }
  }, 1000);
}
function stopLocalTimer() { clearInterval(timerInterval); timerInterval = null; }
function renderTimerDisplay() {
  const el = document.getElementById('hdr-timer');
  const m = Math.floor(localTimerLeft/60), s = localTimerLeft%60;
  el.textContent = `${m}:${s.toString().padStart(2,'0')}`;
  el.classList.toggle('urgent', localTimerLeft<=10);
}
async function handleTimerExpiry() {
  if (!gstate?.game) return;
  const g = gstate.game;
  const players = gstate.players||[];
  const mode = g.mode||'coop';
  let isMyResp;
  if (mode==='teams'&&g.teams) {
    const activeTeamN = g.currentTeam||1;
    const gi = (g.teams[activeTeamN].giverIndex||0)%g.teams[activeTeamN].players.length;
    const giverPlayer = g.teams[activeTeamN].players[gi];
    const myTeamN = getMyTeam(g);
    isMyResp = (g.phase==='giving'&&giverPlayer?.id===myPlayerId)||
               (g.phase==='guessing'&&myTeamN!==activeTeamN&&myPlayerId===
                 (gstate.players||[]).find(p=>p.id===myPlayerId)?.id);
  } else {
    const giverPlayer = players[g.currentPlayerIndex??0];
    isMyResp = (g.phase==='giving'&&giverPlayer?.id===myPlayerId)||
               (g.phase==='guessing'&&giverPlayer?.id!==myPlayerId);
  }
  if (!isMyResp) return;
  const newLog = [...(g.log||[]), {icon:'â±ï¸', text:'Time expired'}];
  const upd = {
    phase:'giving', currentClue:'', timerStartedAt:null,
    rounds:(g.rounds||0)+1,
    targetIndex:(g.targetIndex||0)+(g.phase==='guessing'?1:0),
    log:newLog,
  };
  if (mode==='teams'&&g.teams) {
    const activeTeamN = g.currentTeam||1;
    const newTeams = JSON.parse(JSON.stringify(g.teams));
    newTeams[activeTeamN].giverIndex =
      ((newTeams[activeTeamN].giverIndex||0)+1)%newTeams[activeTeamN].players.length;
    upd.currentTeam = activeTeamN===1?2:1;
    upd.teams = newTeams;
  } else {
    upd.currentPlayerIndex = ((g.currentPlayerIndex??0)+1)%(players.length||1);
  }
  await update(ref(db,`rooms/${roomId}/game`), upd);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  END SCREEN
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderEndScreen(data) {
  stopLocalTimer();
  showScreen('end');
  const g = data.game;
  const mode = g.mode||'coop';
  const n = (g.guessed||[]).length;
  document.getElementById('end-trophy').textContent = 'ğŸ†';
  document.getElementById('end-room-code').textContent = t('codedRoom', roomId);
  document.getElementById('stat-matched').textContent = n;
  document.getElementById('stat-rounds').textContent = g.rounds||0;
  document.getElementById('btn-play-again').textContent = t('playAgain');
  document.getElementById('btn-go-home').textContent = t('goHome');
  document.getElementById('lbl-stat-matched').textContent = t('statMatched');
  document.getElementById('lbl-stat-rounds').textContent = t('statRounds');

  if (mode==='teams'&&g.teams) {
    const s1 = g.teams[1]?.score||0, s2 = g.teams[2]?.score||0;
    document.getElementById('end-title').textContent =
      s1>s2 ? `ğŸ”´ ${t('team')} 1 ${t('wins')}!` :
      s2>s1 ? `ğŸ”µ ${t('team')} 2 ${t('wins')}!` :
      t('tieGame');
    document.getElementById('end-sub').textContent =
      `${t('team')} 1: ${s1} pts  â€”  ${t('team')} 2: ${s2} pts`;
  } else {
    document.getElementById('end-title').textContent = t('congratsTitle');
    document.getElementById('end-sub').textContent = t('congratsSub', n);
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  PLAY AGAIN â€” same room
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
window.playAgain = async () => {
  if (!roomRef||!gstate) return;
  stopLocalTimer();
  const players = gstate.players||[];
  const curMode = gstate.mode||'coop';
  let teamsMap = {};
  if (gstate.game?.teams) {
    [1,2].forEach(n => (gstate.game.teams[n]?.players||[]).forEach(p => { teamsMap[p.id]=n; }));
  }
  const gameData = buildNewGameData(players, gstate.lang||lang, curMode, teamsMap);
  await update(roomRef, { status:'playing', mode:curMode, game:gameData });
  const newData = { ...gstate, status:'playing', mode:curMode, game:gameData };
  gstate = newData;
  applyGameTranslations();
  showScreen('game');
  document.getElementById('hdr-room').textContent = roomId;
  renderGame(newData);
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  QUIT / HOME
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
window.quitGame = () => {
  if (confirm(lang==='es'?'Â¿Salir del juego?':'Quit the game?')) {
    stopLocalTimer(); if (roomRef) off(roomRef); resetToLobby();
  }
};
window.goHome = () => { stopLocalTimer(); if (roomRef) off(roomRef); resetToLobby(); };

function resetToLobby() {
  roomId=null; roomRef=null; gstate=null;
  myPlayerId=null; myName=''; isHost=false;
  selectedMode='coop'; teamAssignments={};
  ['create-section','or-div','join-section'].forEach(id => {
    document.getElementById(id).style.display='';
  });
  ['waiting-section','join-status'].forEach(id => {
    document.getElementById(id).style.display='none';
  });
  document.getElementById('join-code').value='';
  document.getElementById('log-scroll').innerHTML='';
  document.getElementById('start-game-btn').style.display='';
  document.getElementById('mode-pill-coop').classList.add('active');
  document.getElementById('mode-pill-teams').classList.remove('active');
  document.getElementById('teams-config').style.display='none';
  showScreen('lobby');
  applyLobbyTranslations();
}

window.copyRoomCode = () => {
  if (!roomId) return;
  navigator.clipboard.writeText(roomId).catch(()=>{});
  showToast(t('copiedCode'));
};

applyLobbyTranslations();

</script>
</body>
</html>
