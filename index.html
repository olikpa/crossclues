<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Cross Clues â€” Online</title>
<link href="https://fonts.googleapis.com/css2?family=Syne:wght@700;800&family=Instrument+Sans:wght@400;500;600&family=Instrument+Serif:ital@0;1&display=swap" rel="stylesheet">

<style>
:root {
  --bg: #f5f0e8;
  --surface: #fffdf8;
  --card: #ffffff;
  --border: #e0d8cc;
  --shadow: rgba(60,40,10,.08);
  --ink: #1c1710;
  --muted: #8a7f6e;
  --row-clr: #c0392b;
  --col-clr: #1a6fa8;
  --accent: #d4a017;
  --success: #2e7d52;
  --success-bg: #edf7f0;
  --wrong: #c0392b;
  --wrong-bg: #fdf0ef;
  --tag-bg: #f0ece3;
}

*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

body {
  font-family: 'Instrument Sans', sans-serif;
  background: var(--bg);
  color: var(--ink);
  min-height: 100vh;
  overflow-x: hidden;
}

/* â”€â”€â”€ NOISE TEXTURE overlay â”€â”€â”€ */
body::after {
  content: '';
  position: fixed;
  inset: 0;
  pointer-events: none;
  z-index: 999;
  opacity: .025;
  background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)'/%3E%3C/svg%3E");
}

/* â”€â”€â”€ SCREENS â”€â”€â”€ */
.screen { display: none; min-height: 100vh; }
.screen.active { display: flex; flex-direction: column; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   LOBBY SCREEN
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#lobby {
  align-items: center;
  justify-content: center;
  padding: 2rem 1rem;
  gap: 2rem;
  background:
    radial-gradient(ellipse 80% 60% at 20% 10%, rgba(212,160,23,.12) 0%, transparent 60%),
    radial-gradient(ellipse 60% 50% at 80% 90%, rgba(26,111,168,.1) 0%, transparent 60%),
    var(--bg);
}

.logo-block { text-align: center; }

.logo-cross {
  display: inline-flex;
  align-items: center;
  gap: .3rem;
  font-family: 'Syne', sans-serif;
  font-size: clamp(2.4rem, 7vw, 4rem);
  font-weight: 800;
  letter-spacing: -.03em;
  line-height: 1;
}

.logo-cross .w-row { color: var(--row-clr); }
.logo-cross .w-sep { color: var(--muted); font-size: .6em; }
.logo-cross .w-col { color: var(--col-clr); }

.logo-sub {
  margin-top: .5rem;
  font-size: .85rem;
  color: var(--muted);
  letter-spacing: .12em;
  text-transform: uppercase;
  font-family: 'Instrument Sans', sans-serif;
}

.lobby-card {
  background: var(--card);
  border: 1px solid var(--border);
  border-radius: 20px;
  padding: 2rem;
  width: 100%;
  max-width: 420px;
  box-shadow: 0 4px 24px var(--shadow);
}

/* language pills */
.lang-row {
  display: flex;
  gap: .5rem;
  margin-bottom: 1.8rem;
  padding: .3rem;
  background: var(--tag-bg);
  border-radius: 12px;
}

.lang-pill {
  flex: 1;
  padding: .55rem;
  border: none;
  border-radius: 9px;
  background: transparent;
  font-family: 'Instrument Sans', sans-serif;
  font-size: .85rem;
  color: var(--muted);
  cursor: pointer;
  transition: all .18s;
  font-weight: 500;
}

.lang-pill.active {
  background: var(--card);
  color: var(--ink);
  box-shadow: 0 1px 4px var(--shadow);
}

/* divider */
.or-divider {
  display: flex;
  align-items: center;
  gap: .8rem;
  margin: 1.4rem 0;
  color: var(--muted);
  font-size: .8rem;
  text-transform: uppercase;
  letter-spacing: .1em;
}

.or-divider::before, .or-divider::after {
  content: '';
  flex: 1;
  height: 1px;
  background: var(--border);
}

/* section label */
.section-lbl {
  font-size: .75rem;
  text-transform: uppercase;
  letter-spacing: .1em;
  color: var(--muted);
  margin-bottom: .6rem;
  font-weight: 600;
}

/* input field */
.field {
  width: 100%;
  padding: .75rem 1rem;
  border: 1.5px solid var(--border);
  border-radius: 12px;
  background: var(--surface);
  font-family: 'Instrument Sans', sans-serif;
  font-size: 1rem;
  color: var(--ink);
  outline: none;
  transition: border-color .18s, box-shadow .18s;
  margin-bottom: .8rem;
}

.field:focus {
  border-color: var(--accent);
  box-shadow: 0 0 0 3px rgba(212,160,23,.15);
}

.field::placeholder { color: var(--muted); }

/* big action buttons */
.btn-main {
  width: 100%;
  padding: .85rem;
  border: none;
  border-radius: 12px;
  font-family: 'Syne', sans-serif;
  font-size: 1rem;
  font-weight: 700;
  cursor: pointer;
  transition: transform .12s, opacity .18s;
  letter-spacing: .02em;
}

.btn-main:hover { opacity: .9; transform: translateY(-1px); }
.btn-main:active { transform: translateY(0); }

.btn-create {
  background: var(--ink);
  color: var(--bg);
}

.btn-join {
  background: var(--accent);
  color: var(--ink);
}

/* code display */
.room-code-display {
  background: var(--tag-bg);
  border: 1.5px dashed var(--border);
  border-radius: 12px;
  padding: 1.2rem;
  text-align: center;
  margin-bottom: 1rem;
}

.room-code-label {
  font-size: .75rem;
  text-transform: uppercase;
  letter-spacing: .1em;
  color: var(--muted);
  margin-bottom: .4rem;
}

.room-code-value {
  font-family: 'Syne', sans-serif;
  font-size: 2.2rem;
  font-weight: 800;
  letter-spacing: .15em;
  color: var(--ink);
}

.waiting-dots::after {
  content: '';
  animation: dots 1.4s infinite;
}

@keyframes dots {
  0%   { content: ''; }
  25%  { content: '.'; }
  50%  { content: '..'; }
  75%  { content: '...'; }
}

.status-msg {
  text-align: center;
  font-size: .9rem;
  color: var(--muted);
  padding: .5rem 0;
}

.status-msg.connected { color: var(--success); font-weight: 600; }
.status-msg.error { color: var(--wrong); }

/* timer toggle row */
.timer-row {
  display: flex;
  align-items: center;
  gap: .8rem;
  padding: .8rem 0;
  border-top: 1px solid var(--border);
  margin-top: .5rem;
}

.toggle-switch {
  position: relative;
  width: 40px; height: 22px;
  cursor: pointer;
  flex-shrink: 0;
}

.toggle-switch input { opacity: 0; width: 0; height: 0; }

.toggle-slider {
  position: absolute;
  inset: 0;
  background: var(--border);
  border-radius: 11px;
  transition: .2s;
}

.toggle-slider::before {
  content: '';
  position: absolute;
  width: 16px; height: 16px;
  left: 3px; top: 3px;
  background: #fff;
  border-radius: 50%;
  transition: .2s;
  box-shadow: 0 1px 3px rgba(0,0,0,.2);
}

.toggle-switch input:checked + .toggle-slider { background: var(--accent); }
.toggle-switch input:checked + .toggle-slider::before { transform: translateX(18px); }

.timer-input {
  width: 56px;
  padding: .3rem .5rem;
  border: 1.5px solid var(--border);
  border-radius: 8px;
  background: var(--surface);
  font-family: 'Syne', sans-serif;
  font-size: .9rem;
  text-align: center;
  color: var(--ink);
  outline: none;
}

.timer-input:focus { border-color: var(--accent); }
.timer-input:disabled { opacity: .4; }
.timer-label { font-size: .85rem; color: var(--muted); flex: 1; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   GAME SCREEN
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#game {
  flex-direction: column;
  background: var(--bg);
}

.game-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: .7rem 1.2rem;
  background: var(--card);
  border-bottom: 1px solid var(--border);
  flex-shrink: 0;
  gap: .8rem;
  box-shadow: 0 1px 4px var(--shadow);
}

.header-logo {
  font-family: 'Syne', sans-serif;
  font-weight: 800;
  font-size: 1.1rem;
  letter-spacing: -.02em;
}

.header-logo .r { color: var(--row-clr); }
.header-logo .c { color: var(--col-clr); }

.header-center {
  display: flex;
  align-items: center;
  gap: .7rem;
}

.score-chip {
  font-family: 'Syne', sans-serif;
  font-size: .85rem;
  font-weight: 700;
  padding: .25rem .7rem;
  border-radius: 20px;
  background: var(--tag-bg);
  border: 1px solid var(--border);
  color: var(--ink);
}

.timer-chip {
  font-family: 'Syne', sans-serif;
  font-size: 1rem;
  font-weight: 800;
  padding: .2rem .65rem;
  border-radius: 20px;
  background: var(--ink);
  color: var(--bg);
  min-width: 50px;
  text-align: center;
  transition: background .3s;
}

.timer-chip.urgent { background: var(--wrong); animation: urgentPulse .5s alternate infinite; }

@keyframes urgentPulse { to { opacity: .7; } }

.room-chip {
  font-family: 'Syne', sans-serif;
  font-size: .75rem;
  font-weight: 700;
  letter-spacing: .1em;
  color: var(--muted);
  border: 1px solid var(--border);
  border-radius: 8px;
  padding: .2rem .55rem;
}

.header-quit {
  padding: .3rem .7rem;
  border: 1px solid var(--border);
  border-radius: 8px;
  background: transparent;
  font-family: 'Instrument Sans', sans-serif;
  font-size: .8rem;
  color: var(--muted);
  cursor: pointer;
  transition: all .15s;
}
.header-quit:hover { border-color: var(--wrong); color: var(--wrong); }

/* â”€â”€â”€ Main layout â”€â”€â”€ */
.game-body {
  flex: 1;
  display: grid;
  grid-template-columns: 1fr 280px;
  min-height: 0;
  overflow: hidden;
}

@media (max-width: 720px) {
  .game-body {
    grid-template-columns: 1fr;
    grid-template-rows: 1fr auto;
    overflow: auto;
  }
}

/* â”€â”€â”€ Grid area â”€â”€â”€ */
.grid-area {
  display: flex;
  align-items: center;
  justify-content: center;
  padding: 1rem;
  overflow: auto;
}

.grid-wrap {
  display: flex;
  flex-direction: column;
  gap: 0;
}

.col-headers {
  display: flex;
  margin-left: 96px;
  gap: 4px;
}

.col-hdr {
  width: 72px;
  text-align: center;
  font-size: .68rem;
  font-weight: 600;
  color: var(--col-clr);
  text-transform: uppercase;
  letter-spacing: .04em;
  line-height: 1.2;
  padding-bottom: 5px;
  word-break: break-word;
}

.grid-row-wrap {
  display: flex;
  align-items: center;
  gap: 4px;
}

.row-hdr {
  width: 92px;
  text-align: right;
  padding-right: 8px;
  font-size: .68rem;
  font-weight: 600;
  color: var(--row-clr);
  text-transform: uppercase;
  letter-spacing: .04em;
  line-height: 1.2;
  word-break: break-word;
}

.cell {
  width: 72px;
  height: 72px;
  border: 1.5px solid var(--border);
  border-radius: 10px;
  background: var(--card);
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  position: relative;
  transition: all .15s;
  overflow: hidden;
  box-shadow: 0 1px 3px var(--shadow);
}

.cell::before {
  content: '';
  position: absolute;
  inset: 0;
  background: linear-gradient(135deg, rgba(192,57,43,.05), rgba(26,111,168,.05));
  opacity: 0;
  transition: opacity .15s;
}

.cell:hover::before { opacity: 1; }
.cell:hover { border-color: var(--accent); transform: scale(1.06); z-index: 2; box-shadow: 0 4px 12px var(--shadow); }

.cell.disabled { cursor: default; }
.cell.disabled:hover { border-color: var(--border); transform: none; box-shadow: 0 1px 3px var(--shadow); }
.cell.disabled::before { display: none; }

.cell.guessed {
  background: var(--success-bg);
  border-color: var(--success);
  cursor: default;
}
.cell.guessed:hover { transform: none; }

.cell.wrong-flash {
  animation: wrongFlash .5s ease;
}

@keyframes wrongFlash {
  0%, 100% { background: var(--card); }
  50% { background: var(--wrong-bg); border-color: var(--wrong); }
}

.cell.active-target {
  border-color: var(--accent);
  box-shadow: 0 0 0 3px rgba(212,160,23,.25), 0 2px 8px var(--shadow);
}

.cell-check {
  font-size: 1.5rem;
  color: var(--success);
}

.cell-coord {
  position: absolute;
  bottom: 3px;
  right: 5px;
  font-family: 'Syne', sans-serif;
  font-size: .52rem;
  font-weight: 700;
  color: var(--muted);
  opacity: .5;
}

/* â”€â”€â”€ Side panel â”€â”€â”€ */
.side {
  border-left: 1px solid var(--border);
  background: var(--surface);
  display: flex;
  flex-direction: column;
  overflow: hidden;
}

.side-section {
  padding: 1rem;
  border-bottom: 1px solid var(--border);
  flex-shrink: 0;
}

.side-lbl {
  font-size: .7rem;
  text-transform: uppercase;
  letter-spacing: .12em;
  color: var(--muted);
  margin-bottom: .6rem;
  font-weight: 600;
}

/* player card */
.player-card {
  display: flex;
  align-items: center;
  gap: .75rem;
  padding: .7rem;
  background: var(--card);
  border: 1px solid var(--border);
  border-radius: 10px;
}

.p-avatar {
  width: 38px; height: 38px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-family: 'Syne', sans-serif;
  font-size: 1.1rem;
  font-weight: 800;
  flex-shrink: 0;
}

.p-name {
  font-weight: 600;
  font-size: .95rem;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.p-role {
  font-size: .75rem;
  color: var(--muted);
  margin-top: .1rem;
}

/* target / clue display */
.target-card {
  background: var(--card);
  border: 1px solid var(--border);
  border-radius: 10px;
  padding: .75rem;
}

.target-coord-badge {
  font-family: 'Syne', sans-serif;
  font-size: .75rem;
  font-weight: 700;
  color: var(--muted);
  margin-bottom: .4rem;
}

.target-pair {
  display: flex;
  align-items: center;
  gap: .4rem;
  flex-wrap: wrap;
}

.tw {
  font-size: .9rem;
  font-weight: 600;
  padding: .2rem .5rem;
  border-radius: 6px;
}

.tw-row { color: var(--row-clr); background: rgba(192,57,43,.08); }
.tw-col { color: var(--col-clr); background: rgba(26,111,168,.08); }
.tw-sep { color: var(--muted); font-size: .8rem; }

.hint-note {
  font-size: .78rem;
  color: var(--muted);
  font-style: italic;
  margin-top: .5rem;
}

/* clue input */
.clue-field {
  width: 100%;
  padding: .7rem .9rem;
  border: 1.5px solid var(--border);
  border-radius: 10px;
  background: var(--card);
  font-family: 'Instrument Sans', sans-serif;
  font-size: 1rem;
  color: var(--ink);
  outline: none;
  transition: border-color .18s, box-shadow .18s;
  margin-bottom: .6rem;
}

.clue-field:focus {
  border-color: var(--accent);
  box-shadow: 0 0 0 3px rgba(212,160,23,.12);
}

.clue-field:disabled {
  background: var(--tag-bg);
  color: var(--muted);
  cursor: not-allowed;
}

.give-btn {
  width: 100%;
  padding: .72rem;
  background: var(--ink);
  border: none;
  border-radius: 10px;
  color: var(--bg);
  font-family: 'Syne', sans-serif;
  font-size: .95rem;
  font-weight: 700;
  cursor: pointer;
  transition: opacity .18s;
}

.give-btn:hover:not(:disabled) { opacity: .85; }
.give-btn:disabled { opacity: .4; cursor: not-allowed; }

/* clue reveal */
.clue-reveal {
  background: var(--card);
  border: 1.5px solid var(--accent);
  border-radius: 10px;
  padding: 1rem;
  text-align: center;
  margin-bottom: .6rem;
}

.clue-word {
  font-family: 'Instrument Serif', serif;
  font-size: 1.9rem;
  font-weight: 400;
  color: var(--ink);
  letter-spacing: -.01em;
}

.clue-sub {
  font-size: .72rem;
  text-transform: uppercase;
  letter-spacing: .1em;
  color: var(--muted);
  margin-top: .3rem;
}

.guess-tip {
  font-size: .82rem;
  color: var(--muted);
  text-align: center;
  line-height: 1.5;
}

/* waiting overlay for non-active player */
.waiting-note {
  background: var(--tag-bg);
  border: 1px solid var(--border);
  border-radius: 10px;
  padding: .8rem;
  text-align: center;
  font-size: .85rem;
  color: var(--muted);
  line-height: 1.5;
}

/* log */
.log-scroll {
  flex: 1;
  overflow-y: auto;
  padding: .8rem 1rem;
  display: flex;
  flex-direction: column;
  gap: .35rem;
  min-height: 0;
}

.log-scroll::-webkit-scrollbar { width: 4px; }
.log-scroll::-webkit-scrollbar-thumb { background: var(--border); border-radius: 2px; }

.log-entry {
  font-size: .78rem;
  line-height: 1.45;
  color: var(--muted);
  display: flex;
  gap: .4rem;
  align-items: flex-start;
}

.log-entry .li { flex-shrink: 0; }
.log-entry strong { color: var(--ink); }
.log-entry .lc { font-style: italic; color: var(--accent); }
.log-entry .ll { font-family: 'Syne', sans-serif; font-size: .72rem; color: var(--muted); }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   END SCREEN
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#end {
  align-items: center;
  justify-content: center;
  padding: 2rem;
  background: var(--bg);
}

.end-inner {
  max-width: 400px;
  width: 100%;
  text-align: center;
  animation: rise .5s ease both;
}

@keyframes rise {
  from { opacity: 0; transform: translateY(20px); }
  to   { opacity: 1; transform: translateY(0); }
}

.end-trophy { font-size: 5rem; line-height: 1; margin-bottom: 1rem; }

.end-title {
  font-family: 'Syne', sans-serif;
  font-size: 2.5rem;
  font-weight: 800;
  letter-spacing: -.03em;
  margin-bottom: .4rem;
}

.end-sub { color: var(--muted); margin-bottom: 2rem; }

.end-stats {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: .75rem;
  margin-bottom: 2rem;
}

.stat-box {
  background: var(--card);
  border: 1px solid var(--border);
  border-radius: 14px;
  padding: 1.2rem .8rem;
  box-shadow: 0 2px 8px var(--shadow);
}

.stat-n {
  font-family: 'Syne', sans-serif;
  font-size: 2.2rem;
  font-weight: 800;
  color: var(--ink);
  line-height: 1;
}

.stat-desc {
  font-size: .72rem;
  text-transform: uppercase;
  letter-spacing: .1em;
  color: var(--muted);
  margin-top: .3rem;
}

.end-btns { display: flex; flex-direction: column; gap: .7rem; }

.btn-again {
  padding: .9rem;
  background: var(--ink);
  border: none;
  border-radius: 12px;
  color: var(--bg);
  font-family: 'Syne', sans-serif;
  font-size: 1rem;
  font-weight: 700;
  cursor: pointer;
  transition: opacity .18s;
}

.btn-again:hover { opacity: .85; }

.btn-home {
  padding: .9rem;
  background: transparent;
  border: 1.5px solid var(--border);
  border-radius: 12px;
  color: var(--muted);
  font-family: 'Instrument Sans', sans-serif;
  font-size: .9rem;
  cursor: pointer;
  transition: all .18s;
}

.btn-home:hover { border-color: var(--muted); color: var(--ink); }

/* â”€â”€ Firebase setup note â”€â”€ */
#firebase-setup-banner {
  position: fixed;
  bottom: 0; left: 0; right: 0;
  background: #fff3cd;
  border-top: 2px solid #f0c040;
  padding: 1rem 1.5rem;
  font-size: .85rem;
  color: #664d03;
  z-index: 1000;
  display: none;
  line-height: 1.5;
}

#firebase-setup-banner a { color: #495057; font-weight: 600; }
#firebase-setup-banner .close-banner {
  float: right;
  cursor: pointer;
  font-size: 1.2rem;
  line-height: 1;
  margin-left: 1rem;
}

/* toast */
.toast {
  position: fixed;
  bottom: 1.5rem;
  left: 50%;
  transform: translateX(-50%) translateY(80px);
  background: var(--ink);
  color: var(--bg);
  padding: .65rem 1.2rem;
  border-radius: 24px;
  font-size: .9rem;
  font-weight: 500;
  z-index: 500;
  transition: transform .3s ease;
  pointer-events: none;
  white-space: nowrap;
}

.toast.show { transform: translateX(-50%) translateY(0); }
</style>
</head>
<body>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• LOBBY â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="lobby" class="screen active">
  <div class="logo-block">
    <div class="logo-cross">
      <span class="w-row" id="lg-cross">Cross</span>
      <span class="w-sep">âœ•</span>
      <span class="w-col" id="lg-clues">Clues</span>
    </div>
    <div class="logo-sub" id="lg-sub">Online Cooperative Word Game</div>
  </div>

  <div class="lobby-card">
    <div class="lang-row">
      <button class="lang-pill active" onclick="setLang('en')">ğŸ‡¬ğŸ‡§ English</button>
      <button class="lang-pill" onclick="setLang('es')">ğŸ‡ªğŸ‡¸ EspaÃ±ol</button>
    </div>

    <!-- Create Room -->
    <div id="create-section">
      <div class="section-lbl" id="lbl-your-name">Your Name</div>
      <input type="text" class="field" id="create-name" maxlength="20" placeholder="Player 1">

      <div class="timer-row">
        <label class="toggle-switch">
          <input type="checkbox" id="timer-toggle" onchange="onTimerToggle()">
          <span class="toggle-slider"></span>
        </label>
        <span class="timer-label" id="lbl-timer-toggle">Enable timer</span>
        <input type="number" class="timer-input" id="timer-secs" value="90" min="15" max="600" disabled>
        <span class="timer-label" style="flex:none" id="lbl-secs">sec</span>
      </div>

      <button class="btn-main btn-create" onclick="createRoom()" id="btn-create">Create Room</button>
    </div>

    <!-- Waiting for partner (after create) -->
    <div id="waiting-section" style="display:none">
      <div class="room-code-display">
        <div class="room-code-label" id="lbl-room-code">Room Code â€” share with your partner</div>
        <div class="room-code-value" id="room-code-value">â€”â€”â€”</div>
      </div>
      <div class="status-msg" id="waiting-msg">
        <span id="waiting-text">Waiting for partner</span><span class="waiting-dots"></span>
      </div>
    </div>

    <div class="or-divider" id="or-div">or</div>

    <!-- Join Room -->
    <div id="join-section">
      <div class="section-lbl" id="lbl-join-name">Your Name</div>
      <input type="text" class="field" id="join-name" maxlength="20" placeholder="Player 2">
      <div class="section-lbl" id="lbl-enter-code">Room Code</div>
      <input type="text" class="field" id="join-code" maxlength="6" placeholder="ABC123" style="text-transform:uppercase;letter-spacing:.15em;font-family:'Syne',sans-serif;font-weight:700;">
      <button class="btn-main btn-join" onclick="joinRoom()" id="btn-join">Join Room</button>
      <div class="status-msg" id="join-status" style="margin-top:.5rem;display:none"></div>
    </div>
  </div>

  <div id="firebase-setup-banner">
    <span class="close-banner" onclick="this.parentElement.style.display='none'">Ã—</span>
    <strong>Setup required:</strong> This game uses Firebase Realtime Database for live sync.
    See the <a href="#" onclick="showFirebaseInstructions()">setup instructions</a> inside the page source
    (search for <code>FIREBASE_CONFIG</code>) to add your free Firebase project credentials.
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• GAME â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="game" class="screen">
  <div class="game-header">
    <div class="header-logo"><span class="r">Cross</span> <span class="c">Clues</span></div>
    <div class="header-center">
      <span class="score-chip" id="hdr-score">0 / 25</span>
      <span class="timer-chip" id="hdr-timer" style="display:none">1:30</span>
      <span class="room-chip" id="hdr-room">â€”</span>
    </div>
    <button class="header-quit" id="btn-quit" onclick="quitGame()">Quit</button>
  </div>

  <div class="game-body">
    <!-- Grid -->
    <div class="grid-area">
      <div id="grid-wrap" class="grid-wrap"></div>
    </div>

    <!-- Side -->
    <div class="side">
      <div class="side-section" id="side-player">
        <div class="side-lbl" id="lbl-now-playing">Now Playing</div>
        <div class="player-card">
          <div class="p-avatar" id="p-avatar">?</div>
          <div>
            <div class="p-name" id="p-name-display">â€”</div>
            <div class="p-role" id="p-role-display">â€”</div>
          </div>
        </div>
      </div>

      <!-- Giver's target + input -->
      <div class="side-section" id="giver-block">
        <div class="side-lbl" id="lbl-target">Target</div>
        <div class="target-card" id="target-card">
          <div class="target-coord-badge" id="tc-coord">â€”</div>
          <div class="target-pair" id="tc-pair"></div>
          <div class="hint-note" id="tc-hint"></div>
        </div>
      </div>

      <div class="side-section" id="clue-input-block">
        <div class="side-lbl" id="lbl-give-clue">Your Clue</div>
        <input type="text" class="clue-field" id="clue-input" maxlength="40" placeholder="one wordâ€¦">
        <button class="give-btn" id="give-btn" onclick="submitClue()">Give Clue â†’</button>
      </div>

      <!-- Guesser's view -->
      <div class="side-section" id="guesser-block" style="display:none">
        <div class="side-lbl" id="lbl-the-clue">The Clue</div>
        <div class="clue-reveal">
          <div class="clue-word" id="revealed-clue">â€”</div>
          <div class="clue-sub" id="lbl-one-word">one word</div>
        </div>
        <div class="guess-tip" id="guess-tip">Tap the grid cell that matches!</div>
      </div>

      <!-- Waiting (for non-active turns) -->
      <div class="side-section" id="waiting-block" style="display:none">
        <div class="waiting-note" id="waiting-note-text">Waiting for partnerâ€¦</div>
      </div>

      <!-- Log header -->
      <div class="side-lbl" style="padding:.7rem 1rem .2rem;flex-shrink:0" id="lbl-log">Log</div>
      <div class="log-scroll" id="log-scroll"></div>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• END â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="end" class="screen">
  <div class="end-inner">
    <div class="end-trophy" id="end-trophy">ğŸ†</div>
    <div class="end-title" id="end-title">Congratulations!</div>
    <div class="end-sub" id="end-sub">You solved all pairs!</div>
    <div class="end-stats">
      <div class="stat-box">
        <div class="stat-n" id="stat-matched">0</div>
        <div class="stat-desc" id="lbl-stat-matched">Matched</div>
      </div>
      <div class="stat-box">
        <div class="stat-n" id="stat-rounds">0</div>
        <div class="stat-desc" id="lbl-stat-rounds">Rounds</div>
      </div>
    </div>
    <div class="end-btns">
      <button class="btn-again" id="btn-play-again" onclick="playAgain()">Play Again</button>
      <button class="btn-home" id="btn-go-home" onclick="goHome()">Home</button>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  Firebase SDK
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<script type="module">
// â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
// â”‚  FIREBASE SETUP INSTRUCTIONS                                    â”‚
// â”‚                                                                 â”‚
// â”‚  1. Go to https://console.firebase.google.com                   â”‚
// â”‚  2. Create a new project (free Spark plan works)                â”‚
// â”‚  3. Add a Web App to the project                                â”‚
// â”‚  4. Copy your firebaseConfig object                             â”‚
// â”‚  5. Paste it below, replacing the placeholder values            â”‚
// â”‚  6. In Firebase console â†’ Build â†’ Realtime Database:            â”‚
// â”‚     - Create database (start in test mode for easy setup)       â”‚
// â”‚  7. Done! Host this HTML file anywhere (even open locally)      â”‚
// â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

const FIREBASE_CONFIG = {
 apiKey: "AIzaSyCa_uT9_f2LbjO-zAKXPVK5Fob_4NWoHLA",
  authDomain: "cross-clues-31450.firebaseapp.com",
  projectId: "cross-clues-31450",
  storageBucket: "cross-clues-31450.firebasestorage.app",
  messagingSenderId: "1043663543507",
  appId: "1:1043663543507:web:13ee17b1da0c47b2c74826",
  measurementId: "G-63Z8MV0CFB"
};

// â”€â”€â”€ Firebase imports â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import {
  getDatabase, ref, set, get, update, onValue, off, remove, push
} from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

// â”€â”€â”€ Config check â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const firebaseReady = FIREBASE_CONFIG.apiKey !== "YOUR_API_KEY";

let app, db;
if (firebaseReady) {
  app = initializeApp(FIREBASE_CONFIG);
  db  = getDatabase(app);
} else {
  document.getElementById('firebase-setup-banner').style.display = 'block';
  console.warn('Firebase not configured â€” multiplayer disabled. See FIREBASE_CONFIG in source.');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//   WORD LISTS (EN / ES)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const WORDS = {
  en: [
    "OCEAN","FIRE","MOON","TREE","STONE","CLOCK","BRIDGE","CLOUD","WIND","MOUNTAIN",
    "BOOK","HEART","STAR","RIVER","LION","SHIP","GOLD","SHADOW","FLOWER","DREAM",
    "SWORD","EAGLE","DESERT","MIRROR","CROWN","ANCHOR","THUNDER","CANDLE","FEATHER","WAVE",
    "KEY","DOOR","BELL","FISH","RAIN","SNOW","LEAF","NIGHT","ROAD","KING",
    "CAVE","WING","FLAME","ROSE","MAP","CAGE","BONE","SONG","LIGHT","HORN",
    "WOLF","TRAIL","GARDEN","SILVER","TOWER","STORM","ARROW","PEARL","CRYSTAL","FROST",
    "SEAL","FORGE","BEACON","TIDE","ORBIT","DUSK","MIST","LORE","SHIELD","VEIL"
  ],
  es: [
    "OCÃ‰ANO","FUEGO","LUNA","ÃRBOL","PIEDRA","RELOJ","PUENTE","NUBE","VIENTO","MONTAÃ‘A",
    "LIBRO","CORAZÃ“N","ESTRELLA","RÃO","LEÃ“N","BARCO","ORO","SOMBRA","FLOR","SUEÃ‘O",
    "ESPADA","ÃGUILA","DESIERTO","ESPEJO","CORONA","ANCLA","TRUENO","VELA","PLUMA","OLA",
    "LLAVE","PUERTA","CAMPANA","PEZ","LLUVIA","NIEVE","HOJA","NOCHE","CAMINO","REY",
    "CUEVA","ALA","LLAMA","ROSA","MAPA","JAULA","HUESO","CANCIÃ“N","LUZ","CUERNO",
    "LOBO","SENDERO","JARDÃN","PLATA","TORRE","TORMENTA","FLECHA","PERLA","CRISTAL","ESCARCHA",
    "FOCA","FRAGUA","FARO","MAREA","Ã“RBITA","CREPÃšSCULO","NIEBLA","LEYENDA","ESCUDO","VELO"
  ]
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//   TRANSLATIONS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const T = {
  en: {
    sub: "Online Cooperative Word Game",
    yourName: "Your Name", joinName: "Your Name",
    enterCode: "Room Code", timerToggle: "Enable timer", secs: "sec",
    createBtn: "Create Room", joinBtn: "Join Room",
    roomCode: "Room Code â€” share with your partner",
    waitingText: "Waiting for partner",
    nowPlaying: "Now Playing", target: "Target", giveClue: "Your Clue",
    theClue: "The Clue", oneWord: "one word",
    guessInstruction: "Tap the grid cell that matches!",
    hintNote: "Give one word that hints at both!",
    giver: "Clue Giver", guesser: "Guesser",
    cluePlaceholder: "one wordâ€¦", giveBtn: "Give Clue â†’",
    log: "Log", quit: "Quit",
    statMatched: "Matched", statRounds: "Rounds",
    playAgain: "Play Again", goHome: "Home",
    congratsTitle: "Congratulations!", congratsSub: n => `You matched ${n} pairs!`,
    wrongMsg: (clue, rw, cw) => `"${clue}" was for <strong>${rw}</strong> Ã— <strong>${cw}</strong>`,
    p1def: "Player 1", p2def: "Player 2",
    waitingPartner: "Waiting for your partnerâ€¦",
    partnerThinking: name => `${name} is giving a clueâ€¦`,
    waitingGuess: name => `${name} is guessingâ€¦`,
    yourTurnGive: "Your turn! Give a clue.",
    yourTurnGuess: "Your turn! Tap a cell on the grid.",
    roundLog: (n, c) => `${n}: "${c}"`,
    correctLog: (c, r, col) => `âœ“ "${c}" â†’ ${r}Ã—${col}`,
    wrongLog: (c, r, col) => `âœ— "${c}" â†’ ${r}Ã—${col}`,
    joinError: "Room not found. Check the code.",
    roomFull: "Room is already full.",
    gameInProgress: "Game already in progress.",
  },
  es: {
    sub: "Juego cooperativo de palabras en lÃ­nea",
    yourName: "Tu Nombre", joinName: "Tu Nombre",
    enterCode: "CÃ³digo de Sala", timerToggle: "Activar temporizador", secs: "seg",
    createBtn: "Crear Sala", joinBtn: "Unirse",
    roomCode: "CÃ³digo de Sala â€” comparte con tu compaÃ±ero",
    waitingText: "Esperando al compaÃ±ero",
    nowPlaying: "Turno de", target: "Objetivo", giveClue: "Tu Pista",
    theClue: "La Pista", oneWord: "una palabra",
    guessInstruction: "Â¡Toca la celda del tablero que corresponde!",
    hintNote: "Â¡Da una palabra que insinÃºe las dos!",
    giver: "Da la Pista", guesser: "Adivina",
    cluePlaceholder: "una palabraâ€¦", giveBtn: "Dar Pista â†’",
    log: "Registro", quit: "Salir",
    statMatched: "Adivinadas", statRounds: "Rondas",
    playAgain: "Jugar de Nuevo", goHome: "Inicio",
    congratsTitle: "Â¡Felicidades!", congratsSub: n => `Â¡Adivinasteis ${n} parejas!`,
    wrongMsg: (clue, rw, cw) => `"${clue}" era para <strong>${rw}</strong> Ã— <strong>${cw}</strong>`,
    p1def: "Jugador 1", p2def: "Jugador 2",
    waitingPartner: "Esperando a tu compaÃ±eroâ€¦",
    partnerThinking: name => `${name} estÃ¡ dando una pistaâ€¦`,
    waitingGuess: name => `${name} estÃ¡ adivinandoâ€¦`,
    yourTurnGive: "Â¡Tu turno! Da una pista.",
    yourTurnGuess: "Â¡Tu turno! Toca una celda.",
    roundLog: (n, c) => `${n}: "${c}"`,
    correctLog: (c, r, col) => `âœ“ "${c}" â†’ ${r}Ã—${col}`,
    wrongLog: (c, r, col) => `âœ— "${c}" â†’ ${r}Ã—${col}`,
    joinError: "Sala no encontrada. Verifica el cÃ³digo.",
    roomFull: "La sala estÃ¡ llena.",
    gameInProgress: "El juego ya estÃ¡ en curso.",
  }
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//   STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let lang = 'en';
let myRole = null;       // 'p1' | 'p2'
let roomId  = null;
let roomRef = null;
let roomUnsubscribe = null;
let localName = '';

let timerInterval = null;
let localTimerLeft = 0;

// snapshot of current game state from Firebase
let gstate = null;

const t = (key, ...args) => {
  const v = T[lang][key];
  return typeof v === 'function' ? v(...args) : (v ?? key);
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//   UTILS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function shuffle(arr) {
  const a = [...arr];
  for (let i = a.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [a[i], a[j]] = [a[j], a[i]];
  }
  return a;
}

function genCode() {
  const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
  return Array.from({length: 6}, () => chars[Math.floor(Math.random() * chars.length)]).join('');
}

function showToast(msg, dur = 2200) {
  const el = document.getElementById('toast');
  el.textContent = msg;
  el.classList.add('show');
  setTimeout(() => el.classList.remove('show'), dur);
}

function showScreen(id) {
  document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
  document.getElementById(id).classList.add('active');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//   LANGUAGE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
window.setLang = (l) => {
  lang = l;
  document.querySelectorAll('.lang-pill').forEach((b, i) => {
    b.classList.toggle('active', (i === 0 && l === 'en') || (i === 1 && l === 'es'));
  });
  applyLobbyTranslations();
};

function applyLobbyTranslations() {
  const p = T[lang];
  document.getElementById('lg-sub').textContent = p.sub;
  document.getElementById('lbl-your-name').textContent = p.yourName;
  document.getElementById('lbl-join-name').textContent = p.joinName;
  document.getElementById('lbl-enter-code').textContent = p.enterCode;
  document.getElementById('lbl-timer-toggle').textContent = p.timerToggle;
  document.getElementById('lbl-secs').textContent = p.secs;
  document.getElementById('btn-create').textContent = p.createBtn;
  document.getElementById('btn-join').textContent = p.joinBtn;
  document.getElementById('lbl-room-code').textContent = p.roomCode;
  document.getElementById('waiting-text').textContent = p.waitingText;
  document.getElementById('create-name').placeholder = p.p1def;
  document.getElementById('join-name').placeholder = p.p2def;
}

function applyGameTranslations() {
  const p = T[lang];
  document.getElementById('lbl-now-playing').textContent = p.nowPlaying;
  document.getElementById('lbl-target').textContent = p.target;
  document.getElementById('lbl-give-clue').textContent = p.giveClue;
  document.getElementById('lbl-the-clue').textContent = p.theClue;
  document.getElementById('lbl-one-word').textContent = p.oneWord;
  document.getElementById('guess-tip').textContent = p.guessInstruction;
  document.getElementById('clue-input').placeholder = p.cluePlaceholder;
  document.getElementById('give-btn').textContent = p.giveBtn;
  document.getElementById('lbl-log').textContent = p.log;
  document.getElementById('btn-quit').textContent = p.quit;
  document.getElementById('lbl-stat-matched').textContent = p.statMatched;
  document.getElementById('lbl-stat-rounds').textContent = p.statRounds;
  document.getElementById('btn-play-again').textContent = p.playAgain;
  document.getElementById('btn-go-home').textContent = p.goHome;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//   TIMER TOGGLE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
window.onTimerToggle = () => {
  document.getElementById('timer-secs').disabled = !document.getElementById('timer-toggle').checked;
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//   CREATE ROOM
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
window.createRoom = async () => {
  if (!firebaseReady) { showToast('Configure Firebase first â€” see setup instructions'); return; }
  const name = document.getElementById('create-name').value.trim() || t('p1def');
  const useTimer = document.getElementById('timer-toggle').checked;
  const timerSecs = parseInt(document.getElementById('timer-secs').value) || 90;

  roomId  = genCode();
  myRole  = 'p1';
  localName = name;
  lang;   // current lang

  // Build initial game data (will be populated properly when p2 joins)
  const roomData = {
    created: Date.now(),
    lang,
    useTimer,
    timerSecs,
    status: 'waiting',   // waiting | playing | ended
    p1: { name, connected: true },
    p2: null,
    game: null,
  };

  roomRef = ref(db, `rooms/${roomId}`);
  await set(roomRef, roomData);

  // Show room code
  document.getElementById('create-section').style.display = 'none';
  document.getElementById('or-div').style.display = 'none';
  document.getElementById('join-section').style.display = 'none';
  document.getElementById('waiting-section').style.display = '';
  document.getElementById('room-code-value').textContent = roomId;

  // Listen for partner
  listenRoom();
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//   JOIN ROOM
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
window.joinRoom = async () => {
  if (!firebaseReady) { showToast('Configure Firebase first â€” see setup instructions'); return; }
  const name = document.getElementById('join-name').value.trim() || t('p2def');
  const code = document.getElementById('join-code').value.trim().toUpperCase();
  if (!code || code.length < 4) { showJoinError(t('joinError')); return; }

  const snap = await get(ref(db, `rooms/${code}`));
  if (!snap.exists()) { showJoinError(t('joinError')); return; }

  const data = snap.val();
  if (data.p2 && data.p2.connected) { showJoinError(t('roomFull')); return; }
  if (data.status === 'playing') { showJoinError(t('gameInProgress')); return; }

  roomId    = code;
  myRole    = 'p2';
  localName = name;
  lang      = data.lang || 'en';

  // Set lang pills
  document.querySelectorAll('.lang-pill').forEach((b, i) => {
    b.classList.toggle('active', (i===0 && lang==='en') || (i===1 && lang==='es'));
  });

  roomRef = ref(db, `rooms/${roomId}`);
  await update(roomRef, { 'p2': { name, connected: true } });

  // Start the game (p2 triggers game start)
  const G = 5;
  const pool = shuffle(WORDS[lang]);
  const rowWords = pool.slice(0, G);
  const colWords = pool.slice(G, G * 2);
  const allCells = [];
  for (let r = 0; r < G; r++) for (let c = 0; c < G; c++) allCells.push(`${r},${c}`);
  const targetOrder = shuffle(allCells);

  const gameData = {
    rowWords, colWords,
    targetOrder,
    targetIndex: 0,
    currentPlayer: 'p1',   // p1 starts as giver
    phase: 'giving',        // giving | guessing
    currentClue: '',
    guessed: [],
    rounds: 0,
    log: [],
    timerStartedAt: null,
  };

  await update(roomRef, { status: 'playing', game: gameData });

  listenRoom();
};

function showJoinError(msg) {
  const el = document.getElementById('join-status');
  el.textContent = msg;
  el.className = 'status-msg error';
  el.style.display = '';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//   LISTEN TO ROOM
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function listenRoom() {
  if (roomUnsubscribe) { off(roomRef); }
  roomUnsubscribe = onValue(roomRef, (snap) => {
    if (!snap.exists()) return;
    const data = snap.val();

    if (data.status === 'waiting') {
      // Still waiting for partner
      return;
    }

    if (data.status === 'playing' && data.game) {
      gstate = data;
      lang = data.lang || lang;
      applyGameTranslations();
      showScreen('game');
      document.getElementById('hdr-room').textContent = roomId;
      renderGame(data);
    }

    if (data.status === 'ended' && data.game) {
      gstate = data;
      renderEndScreen(data);
    }
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//   RENDER GAME
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderGame(data) {
  const g = data.game;
  const guessedSet = new Set(g.guessed || []);
  const amGiver   = g.currentPlayer === myRole;
  const amGuesser = !amGiver;

  // Score
  document.getElementById('hdr-score').textContent = `${guessedSet.size} / ${g.rowWords.length * g.colWords.length}`;

  // Build grid if needed (first time or new game)
  buildGrid(g, guessedSet, g.phase, amGuesser);

  // Timer
  if (data.useTimer) {
    document.getElementById('hdr-timer').style.display = '';
    if (g.timerStartedAt) {
      startLocalTimer(data.timerSecs, g.timerStartedAt);
    }
  } else {
    document.getElementById('hdr-timer').style.display = 'none';
    stopLocalTimer();
  }

  // Player panel
  const giverName   = g.currentPlayer === 'p1' ? data.p1.name : data.p2.name;
  const guesserName = g.currentPlayer === 'p1' ? data.p2.name : data.p1.name;

  const displayName = (g.phase === 'giving') ? giverName : guesserName;
  const role        = (g.phase === 'giving') ? t('giver') : t('guesser');
  const color       = g.currentPlayer === 'p1' ? 'var(--row-clr)' : 'var(--col-clr)';

  document.getElementById('p-avatar').textContent  = displayName.charAt(0).toUpperCase();
  document.getElementById('p-avatar').style.background = color;
  document.getElementById('p-avatar').style.color  = '#fff';
  document.getElementById('p-name-display').textContent = displayName;
  document.getElementById('p-role-display').textContent = role;

  // Panel logic
  const giverBlock       = document.getElementById('giver-block');
  const clueInputBlock   = document.getElementById('clue-input-block');
  const guesserBlock     = document.getElementById('guesser-block');
  const waitingBlock     = document.getElementById('waiting-block');

  // Reset all
  giverBlock.style.display     = 'none';
  clueInputBlock.style.display = 'none';
  guesserBlock.style.display   = 'none';
  waitingBlock.style.display   = 'none';

  if (g.phase === 'giving') {
    if (amGiver) {
      // Show target + clue input
      giverBlock.style.display   = '';
      clueInputBlock.style.display = '';
      document.getElementById('clue-input').disabled = false;
      document.getElementById('give-btn').disabled   = false;
      document.getElementById('clue-input').value    = '';
      setTimeout(() => document.getElementById('clue-input').focus(), 100);

      // Set target
      const tgt = currentTargetFromState(g);
      if (tgt) {
        const [tr, tc] = tgt.split(',').map(Number);
        document.getElementById('tc-coord').textContent = `${String.fromCharCode(65+tr)}${tc+1}`;
        document.getElementById('tc-pair').innerHTML =
          `<span class="tw tw-row">${g.rowWords[tr]}</span>
           <span class="tw-sep">Ã—</span>
           <span class="tw tw-col">${g.colWords[tc]}</span>`;
        document.getElementById('tc-hint').textContent = t('hintNote');
        // Highlight target cell for giver
        highlightCell(`${tr},${tc}`);
      }
    } else {
      // Show waiting note
      waitingBlock.style.display = '';
      document.getElementById('waiting-note-text').textContent = t('partnerThinking', giverName);
    }
  } else if (g.phase === 'guessing') {
    if (amGuesser) {
      // Show clue reveal
      guesserBlock.style.display = '';
      document.getElementById('revealed-clue').textContent = g.currentClue || 'â€”';
    } else {
      // Giver waits
      waitingBlock.style.display = '';
      document.getElementById('waiting-note-text').textContent = t('waitingGuess', guesserName);
      // Still show target info for context
      giverBlock.style.display = '';
      document.getElementById('clue-input').disabled = true;
    }
  }

  // Log
  renderLog(g.log || []);
}

function currentTargetFromState(g) {
  const guessedSet = new Set(g.guessed || []);
  const order = g.targetOrder || [];
  for (let i = g.targetIndex; i < order.length; i++) {
    if (!guessedSet.has(order[i])) return order[i];
  }
  return null;
}

// â”€â”€â”€ Grid builder â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function buildGrid(g, guessedSet, phase, amGuesser) {
  const wrap = document.getElementById('grid-wrap');
  wrap.innerHTML = '';

  const G = g.rowWords.length;

  // Col headers
  const colHdr = document.createElement('div');
  colHdr.className = 'col-headers';
  for (let c = 0; c < G; c++) {
    const d = document.createElement('div');
    d.className = 'col-hdr';
    d.textContent = g.colWords[c];
    colHdr.appendChild(d);
  }
  wrap.appendChild(colHdr);

  for (let r = 0; r < G; r++) {
    const row = document.createElement('div');
    row.className = 'grid-row-wrap';

    const rh = document.createElement('div');
    rh.className = 'row-hdr';
    rh.textContent = g.rowWords[r];
    row.appendChild(rh);

    for (let c = 0; c < G; c++) {
      const cell = document.createElement('div');
      cell.className = 'cell';
      cell.id = `cell-${r}-${c}`;
      cell.dataset.key = `${r},${c}`;

      const coord = document.createElement('div');
      coord.className = 'cell-coord';
      coord.textContent = `${String.fromCharCode(65+r)}${c+1}`;
      cell.appendChild(coord);

      if (guessedSet.has(`${r},${c}`)) {
        cell.classList.add('guessed');
        cell.innerHTML = `<span class="cell-check">âœ“</span>`;
        cell.classList.add('disabled');
      } else {
        if (phase === 'guessing' && amGuesser) {
          cell.addEventListener('click', () => onCellClick(r, c));
        } else {
          cell.classList.add('disabled');
        }
      }

      row.appendChild(cell);
    }
    wrap.appendChild(row);
  }
}

function highlightCell(key) {
  document.querySelectorAll('.cell').forEach(c => c.classList.remove('active-target'));
  const [r, c] = key.split(',');
  const el = document.getElementById(`cell-${r}-${c}`);
  if (el) el.classList.add('active-target');
}

function renderLog(entries) {
  const scroll = document.getElementById('log-scroll');
  scroll.innerHTML = '';
  const items = [...entries].reverse();
  for (const entry of items) {
    const div = document.createElement('div');
    div.className = 'log-entry';
    div.innerHTML = `<span class="li">${entry.icon}</span><span class="log-txt">${entry.text}</span>`;
    scroll.appendChild(div);
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//   CELL CLICK (GUESSER)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
window.onCellClick = async (r, c) => {
  if (!gstate || !gstate.game) return;
  const g = gstate.game;

  if (g.phase !== 'guessing') return;
  const amGuesser = g.currentPlayer !== myRole;
  if (!amGuesser) return;

  const guessedSet = new Set(g.guessed || []);
  if (guessedSet.has(`${r},${c}`)) return;

  const tgt = currentTargetFromState(g);
  if (!tgt) return;

  const correct = tgt === `${r},${c}`;
  const [tr, tc] = tgt.split(',').map(Number);

  let newGuessed = [...(g.guessed || [])];
  let newTargetIndex = g.targetIndex;
  let newLog = [...(g.log || [])];

  if (correct) {
    newGuessed.push(`${r},${c}`);
    newTargetIndex++;
    newLog.push({
      icon: 'âœ…',
      text: t('correctLog', g.currentClue, g.rowWords[tr], g.colWords[tc])
    });
    // Flash success
    const el = document.getElementById(`cell-${r}-${c}`);
    if (el) el.style.transition = 'background .2s';

    // Check win
    const G = g.rowWords.length;
    if (newGuessed.length >= G * G) {
      await update(ref(db, `rooms/${roomId}/game`), {
        guessed: newGuessed,
        targetIndex: newTargetIndex,
        log: newLog,
        phase: 'giving',
        currentClue: '',
        timerStartedAt: null,
      });
      await update(roomRef, { status: 'ended' });
      return;
    }
  } else {
    // Flash wrong cell
    const el = document.getElementById(`cell-${r}-${c}`);
    if (el) { el.classList.add('wrong-flash'); setTimeout(() => el.classList.remove('wrong-flash'), 600); }

    newLog.push({
      icon: 'âŒ',
      text: t('wrongLog', g.currentClue, g.rowWords[tr], g.colWords[tc])
    });
    newTargetIndex++;
    showToast(t('wrongMsg', g.currentClue, g.rowWords[tr], g.colWords[tc]).replace(/<[^>]+>/g, ''));
  }

  stopLocalTimer();

  // Next turn: swap player, back to giving
  const nextPlayer = g.currentPlayer === 'p1' ? 'p2' : 'p1';

  await update(ref(db, `rooms/${roomId}/game`), {
    guessed: newGuessed,
    targetIndex: newTargetIndex,
    log: newLog,
    phase: 'giving',
    currentPlayer: nextPlayer,
    currentClue: '',
    timerStartedAt: null,
    rounds: (g.rounds || 0) + 1,
  });
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//   SUBMIT CLUE (GIVER)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
window.submitClue = async () => {
  const clue = document.getElementById('clue-input').value.trim().toUpperCase();
  if (!clue) return;
  if (!gstate || !gstate.game) return;
  const g = gstate.game;
  if (g.phase !== 'giving') return;
  if (g.currentPlayer !== myRole) return;

  const newLog = [...(g.log || []), {
    icon: 'ğŸ—£ï¸',
    text: t('roundLog', localName, clue)
  }];

  document.getElementById('give-btn').disabled = true;
  document.getElementById('clue-input').disabled = true;

  const timerStartedAt = gstate.useTimer ? Date.now() : null;

  await update(ref(db, `rooms/${roomId}/game`), {
    phase: 'guessing',
    currentClue: clue,
    log: newLog,
    timerStartedAt,
  });
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//   LOCAL TIMER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function startLocalTimer(totalSecs, startedAt) {
  stopLocalTimer();
  const elapsed = Math.floor((Date.now() - startedAt) / 1000);
  localTimerLeft = Math.max(0, totalSecs - elapsed);
  renderTimerDisplay();

  timerInterval = setInterval(() => {
    localTimerLeft--;
    renderTimerDisplay();
    if (localTimerLeft <= 0) {
      stopLocalTimer();
      // Auto-advance if it's our turn
      handleTimerExpiry();
    }
  }, 1000);
}

function stopLocalTimer() {
  clearInterval(timerInterval);
  timerInterval = null;
}

function renderTimerDisplay() {
  const el = document.getElementById('hdr-timer');
  const m = Math.floor(localTimerLeft / 60);
  const s = localTimerLeft % 60;
  el.textContent = `${m}:${s.toString().padStart(2,'0')}`;
  el.classList.toggle('urgent', localTimerLeft <= 10);
}

async function handleTimerExpiry() {
  if (!gstate || !gstate.game) return;
  const g = gstate.game;

  // Only the relevant player should push the state change
  const isMyTurn = (g.phase === 'giving' && g.currentPlayer === myRole) ||
                   (g.phase === 'guessing' && g.currentPlayer !== myRole);
  if (!isMyTurn) return;

  const nextPlayer = g.currentPlayer === 'p1' ? 'p2' : 'p1';
  const newLog = [...(g.log || []), { icon: 'â±ï¸', text: 'Time expired' }];

  await update(ref(db, `rooms/${roomId}/game`), {
    phase: 'giving',
    currentPlayer: nextPlayer,
    currentClue: '',
    timerStartedAt: null,
    rounds: (g.rounds || 0) + 1,
    targetIndex: (g.targetIndex || 0) + (g.phase === 'guessing' ? 1 : 0),
    log: newLog,
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//   END SCREEN
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderEndScreen(data) {
  stopLocalTimer();
  showScreen('end');
  const g = data.game;
  const n = (g.guessed || []).length;
  document.getElementById('end-trophy').textContent = 'ğŸ†';
  document.getElementById('end-title').textContent = t('congratsTitle');
  document.getElementById('end-sub').textContent = t('congratsSub', n);
  document.getElementById('stat-matched').textContent = n;
  document.getElementById('stat-rounds').textContent = g.rounds || 0;
  document.getElementById('btn-play-again').textContent = t('playAgain');
  document.getElementById('btn-go-home').textContent = t('goHome');
  document.getElementById('lbl-stat-matched').textContent = t('statMatched');
  document.getElementById('lbl-stat-rounds').textContent = t('statRounds');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//   NAVIGATION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
window.quitGame = () => {
  if (confirm(lang === 'es' ? 'Â¿Salir del juego?' : 'Quit the game?')) {
    stopLocalTimer();
    if (roomRef) off(roomRef);
    goHome();
  }
};

window.playAgain = async () => {
  if (!firebaseReady || !roomRef || !gstate) { goHome(); return; }
  stopLocalTimer();

  const G = 5;
  const pool = shuffle(WORDS[lang]);
  const rowWords = pool.slice(0, G);
  const colWords = pool.slice(G, G * 2);
  const allCells = [];
  for (let r = 0; r < G; r++) for (let c = 0; c < G; c++) allCells.push(`${r},${c}`);
  const targetOrder = shuffle(allCells);

  const gameData = {
    rowWords, colWords, targetOrder,
    targetIndex: 0,
    currentPlayer: 'p1',
    phase: 'giving',
    currentClue: '',
    guessed: [],
    rounds: 0,
    log: [],
    timerStartedAt: null,
  };

  await update(roomRef, { status: 'playing', game: gameData });
};

window.goHome = () => {
  stopLocalTimer();
  if (roomRef) off(roomRef);
  roomId = roomRef = roomUnsubscribe = null;
  myRole = null; gstate = null;

  // Reset lobby UI
  document.getElementById('create-section').style.display = '';
  document.getElementById('or-div').style.display = '';
  document.getElementById('join-section').style.display = '';
  document.getElementById('waiting-section').style.display = 'none';
  document.getElementById('join-status').style.display = 'none';
  document.getElementById('join-code').value = '';
  document.getElementById('log-scroll').innerHTML = '';

  showScreen('lobby');
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//   FIREBASE INSTRUCTIONS (fallback demo)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
window.showFirebaseInstructions = () => {
  alert(
    'Firebase Setup:\n\n' +
    '1. Go to https://console.firebase.google.com\n' +
    '2. Create a free project\n' +
    '3. Add a Web App\n' +
    '4. Copy the firebaseConfig\n' +
    '5. Edit this HTML file and paste it into FIREBASE_CONFIG\n' +
    '6. Enable Realtime Database (Build â†’ Realtime Database)\n' +
    '7. Done!'
  );
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//   INIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
applyLobbyTranslations();
</script>
</body>
</html>
