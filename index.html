<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Cross Clues by olikpa</title>
<link href="https://fonts.googleapis.com/css2?family=Syne:wght@700;800&family=Instrument+Sans:wght@400;500;600&family=Instrument+Serif:ital@0;1&display=swap" rel="stylesheet">
<style>
:root{
  --bg:#f5f0e8;--surface:#fffdf8;--card:#ffffff;--border:#e0d8cc;
  --shadow:rgba(60,40,10,.08);--ink:#1c1710;--muted:#8a7f6e;
  --row-clr:#c0392b;--col-clr:#1a6fa8;--accent:#d4a017;
  --success:#2e7d52;--success-bg:#d4f0e0;--wrong:#c0392b;
  --wrong-bg:#fdf0ef;--tag-bg:#f0ece3;
  --t1:#e05a7a;--t1-bg:#fde8ef;
  --t2:#3a7fd4;--t2-bg:#e8f0fd;
  --t3:#7b4fb5;--t3-bg:#f0e8fd;
  --t4:#2e7d52;--t4-bg:#d4f0e0;
}
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
body{font-family:'Instrument Sans',sans-serif;background:var(--bg);color:var(--ink);min-height:100vh;overflow-x:hidden}
body::after{content:'';position:fixed;inset:0;pointer-events:none;z-index:999;opacity:.025;background-image:url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)'/%3E%3C/svg%3E")}
.screen{display:none;min-height:100vh}
.screen.active{display:flex;flex-direction:column}

/* LOBBY */
#lobby{align-items:center;justify-content:center;padding:2rem 1rem;gap:1.4rem;background:radial-gradient(ellipse 80% 60% at 20% 10%,rgba(212,160,23,.12) 0%,transparent 60%),radial-gradient(ellipse 60% 50% at 80% 90%,rgba(26,111,168,.1) 0%,transparent 60%),var(--bg)}
.logo-block{text-align:center}
.logo-cross{display:inline-flex;align-items:center;gap:.3rem;font-family:'Syne',sans-serif;font-size:clamp(2.2rem,6vw,3.8rem);font-weight:800;letter-spacing:-.03em;line-height:1}
.logo-cross .w-row{color:var(--row-clr)}.logo-cross .w-sep{color:var(--muted);font-size:.6em}.logo-cross .w-col{color:var(--col-clr)}
.logo-by{font-size:.78rem;color:var(--muted);letter-spacing:.14em;text-transform:uppercase;margin-top:.4rem}
.logo-by em{color:var(--accent);font-style:normal;font-weight:600}
.lobby-card{background:var(--card);border:1px solid var(--border);border-radius:20px;padding:1.8rem;width:100%;max-width:440px;box-shadow:0 4px 24px var(--shadow)}
.lang-row{display:flex;gap:.5rem;margin-bottom:1.3rem;padding:.3rem;background:var(--tag-bg);border-radius:12px}
.lang-pill{flex:1;padding:.52rem;border:none;border-radius:9px;background:transparent;font-family:'Instrument Sans',sans-serif;font-size:.85rem;color:var(--muted);cursor:pointer;transition:all .18s;font-weight:500}
.lang-pill.active{background:var(--card);color:var(--ink);box-shadow:0 1px 4px var(--shadow)}
.or-divider{display:flex;align-items:center;gap:.8rem;margin:1.1rem 0;color:var(--muted);font-size:.8rem;text-transform:uppercase;letter-spacing:.1em}
.or-divider::before,.or-divider::after{content:'';flex:1;height:1px;background:var(--border)}
.section-lbl{font-size:.73rem;text-transform:uppercase;letter-spacing:.1em;color:var(--muted);margin-bottom:.55rem;font-weight:600}
.field{width:100%;padding:.72rem 1rem;border:1.5px solid var(--border);border-radius:12px;background:var(--surface);font-family:'Instrument Sans',sans-serif;font-size:1rem;color:var(--ink);outline:none;transition:border-color .18s,box-shadow .18s;margin-bottom:.75rem}
.field:focus{border-color:var(--accent);box-shadow:0 0 0 3px rgba(212,160,23,.15)}
.field::placeholder{color:var(--muted)}
.btn-main{width:100%;padding:.82rem;border:none;border-radius:12px;font-family:'Syne',sans-serif;font-size:1rem;font-weight:700;cursor:pointer;transition:transform .12s,opacity .18s;letter-spacing:.02em}
.btn-main:hover{opacity:.9;transform:translateY(-1px)}.btn-main:active{transform:translateY(0)}
.btn-create{background:var(--ink);color:var(--bg)}.btn-join{background:var(--accent);color:var(--ink)}

/* option grid: mode + grid size */
.opt-group{margin-bottom:.9rem}
.opt-grid{display:flex;gap:.45rem;flex-wrap:wrap}
.opt-btn{flex:1;min-width:60px;padding:.55rem .3rem;border:1.5px solid var(--border);border-radius:10px;background:transparent;font-family:'Instrument Sans',sans-serif;font-size:.82rem;font-weight:500;color:var(--muted);cursor:pointer;transition:all .18s;text-align:center;line-height:1.3}
.opt-btn.active{border-color:var(--accent);background:rgba(212,160,23,.1);color:var(--ink);font-weight:600}

/* sound toggle in lobby */
.sound-row{display:flex;align-items:center;gap:.7rem;padding:.55rem 0;font-size:.84rem;color:var(--muted)}
.toggle-switch{position:relative;width:38px;height:21px;cursor:pointer;flex-shrink:0}
.toggle-switch input{opacity:0;width:0;height:0}
.toggle-slider{position:absolute;inset:0;background:var(--border);border-radius:11px;transition:.2s}
.toggle-slider::before{content:'';position:absolute;width:15px;height:15px;left:3px;top:3px;background:#fff;border-radius:50%;transition:.2s;box-shadow:0 1px 3px rgba(0,0,0,.2)}
.toggle-switch input:checked+.toggle-slider{background:var(--accent)}
.toggle-switch input:checked+.toggle-slider::before{transform:translateX(17px)}
.timer-row{display:flex;align-items:center;gap:.7rem;padding:.6rem 0;border-top:1px solid var(--border);margin-top:.1rem}
.timer-input{width:52px;padding:.28rem .45rem;border:1.5px solid var(--border);border-radius:8px;background:var(--surface);font-family:'Syne',sans-serif;font-size:.9rem;text-align:center;color:var(--ink);outline:none}
.timer-input:focus{border-color:var(--accent)}.timer-input:disabled{opacity:.4}
.timer-label{font-size:.83rem;color:var(--muted);flex:1}

/* waiting room */
.room-code-display{background:var(--tag-bg);border:1.5px dashed var(--border);border-radius:12px;padding:1.1rem;text-align:center;margin-bottom:.9rem}
.room-code-label{font-size:.73rem;text-transform:uppercase;letter-spacing:.1em;color:var(--muted);margin-bottom:.35rem}
.room-code-value{font-family:'Syne',sans-serif;font-size:2.1rem;font-weight:800;letter-spacing:.15em;color:var(--ink)}
.waiting-dots::after{content:'';animation:dots 1.4s infinite}
@keyframes dots{0%{content:''}25%{content:'.'}50%{content:'..'}75%{content:'...'}}
.status-msg{text-align:center;font-size:.88rem;color:var(--muted);padding:.4rem 0}
.status-msg.error{color:var(--wrong)}
.players-in-room{margin-top:.7rem}
.players-list{display:flex;flex-wrap:wrap;gap:.4rem;margin-top:.35rem}
.player-chip{display:flex;align-items:center;gap:.35rem;padding:.23rem .58rem;background:var(--tag-bg);border:1px solid var(--border);border-radius:20px;font-size:.79rem;font-weight:500}
.player-chip-dot{width:8px;height:8px;border-radius:50%;flex-shrink:0}
.team-assign-wrap{margin-top:.5rem;border:1px solid var(--border);border-radius:12px;overflow:hidden}
.team-assign-row{display:flex;align-items:center;justify-content:space-between;padding:.45rem .7rem;border-bottom:1px solid var(--border);font-size:.84rem}
.team-assign-row:last-child{border-bottom:none}
.team-assign-name{font-weight:500}
.team-sel{padding:.2rem .45rem;border:1.5px solid var(--border);border-radius:8px;background:var(--surface);font-family:'Instrument Sans',sans-serif;font-size:.79rem;color:var(--ink);outline:none;cursor:pointer}
.team-sel:focus{border-color:var(--accent)}
.num-teams-row{display:flex;align-items:center;gap:.6rem;margin-bottom:.5rem;font-size:.84rem;color:var(--muted)}
.num-teams-row select{padding:.2rem .45rem;border:1.5px solid var(--border);border-radius:8px;background:var(--surface);font-family:'Instrument Sans',sans-serif;font-size:.81rem;color:var(--ink);outline:none;cursor:pointer}
.start-game-btn{margin-top:.8rem;width:100%;padding:.78rem;background:var(--success);border:none;border-radius:12px;color:#fff;font-family:'Syne',sans-serif;font-size:.93rem;font-weight:700;cursor:pointer;transition:opacity .18s}
.start-game-btn:hover{opacity:.88}.start-game-btn:disabled{opacity:.4;cursor:not-allowed}

/* GAME */
#game{flex-direction:column;background:var(--bg)}
.game-header{display:flex;align-items:center;padding:.65rem 1rem;background:var(--card);border-bottom:1px solid var(--border);flex-shrink:0;gap:.6rem;box-shadow:0 1px 4px var(--shadow)}
.header-logo{font-family:'Syne',sans-serif;font-weight:800;font-size:1rem;letter-spacing:-.02em;white-space:nowrap}
.header-logo .r{color:var(--row-clr)}.header-logo .c{color:var(--col-clr)}
.header-center{display:flex;align-items:center;gap:.5rem;flex:1;justify-content:center}
.score-chip{font-family:'Syne',sans-serif;font-size:.82rem;font-weight:700;padding:.22rem .65rem;border-radius:20px;background:var(--tag-bg);border:1px solid var(--border);color:var(--ink)}
.timer-chip{font-family:'Syne',sans-serif;font-size:.95rem;font-weight:800;padding:.18rem .6rem;border-radius:20px;background:var(--ink);color:var(--bg);min-width:46px;text-align:center;transition:background .3s}
.timer-chip.urgent{background:var(--wrong);animation:urgentPulse .5s alternate infinite}
@keyframes urgentPulse{to{opacity:.7}}
.room-chip{font-family:'Syne',sans-serif;font-size:.72rem;font-weight:700;letter-spacing:.1em;color:var(--muted);border:1px solid var(--border);border-radius:8px;padding:.18rem .5rem;cursor:pointer}
.room-chip:hover{border-color:var(--muted)}
.hdr-btns{display:flex;gap:.35rem;align-items:center;flex-shrink:0}
.hdr-btn{padding:.28rem .62rem;border:1px solid var(--border);border-radius:8px;background:transparent;font-family:'Instrument Sans',sans-serif;font-size:.77rem;color:var(--muted);cursor:pointer;transition:all .15s;white-space:nowrap;line-height:1}
.hdr-btn:hover{border-color:var(--muted);color:var(--ink)}
.hdr-btn.green{border-color:var(--success);color:var(--success);font-family:'Syne',sans-serif;font-weight:700}
.hdr-btn.green:hover{background:var(--success);color:#fff}
.hdr-btn.red:hover{border-color:var(--wrong);color:var(--wrong)}

.teams-score-bar{display:flex;gap:.45rem;padding:.5rem .9rem;border-bottom:1px solid var(--border);flex-shrink:0;background:var(--card)}
.team-score-chip{flex:1;padding:.38rem .45rem;border-radius:9px;border:2px solid transparent;text-align:center;font-family:'Syne',sans-serif;font-size:.8rem;font-weight:700;transition:all .2s}
.team-score-chip.active-team{transform:scale(1.04);box-shadow:0 2px 8px var(--shadow)}
.team-score-n{font-size:1.25rem;line-height:1}
.team-score-label{font-size:.58rem;text-transform:uppercase;letter-spacing:.07em;opacity:.75;margin-top:.1rem}

.game-body{flex:1;display:grid;grid-template-columns:1fr 284px;min-height:0;overflow:hidden}
@media(max-width:720px){.game-body{grid-template-columns:1fr;grid-template-rows:1fr auto;overflow:auto}}

/* GRID with zoom */
.grid-area{display:flex;align-items:center;justify-content:center;padding:1rem;overflow:auto;position:relative}

.grid-wrap{display:flex;flex-direction:column;gap:0;transform-origin:center center;transition:transform .18s ease}
.col-headers{display:flex;gap:4px}
.col-hdr{text-align:center;font-size:.65rem;font-weight:600;color:var(--col-clr);text-transform:uppercase;letter-spacing:.04em;line-height:1.2;padding-bottom:4px;word-break:break-word}
.grid-row-wrap{display:flex;align-items:center;gap:4px}
.row-hdr{text-align:right;padding-right:7px;font-size:.65rem;font-weight:600;color:var(--row-clr);text-transform:uppercase;letter-spacing:.04em;line-height:1.2;word-break:break-word}
.cell{border:1.5px solid var(--border);border-radius:9px;background:var(--card);display:flex;align-items:center;justify-content:center;cursor:pointer;position:relative;transition:all .15s;overflow:hidden;box-shadow:0 1px 3px var(--shadow);flex-direction:column;gap:2px}
.cell::before{content:'';position:absolute;inset:0;background:linear-gradient(135deg,rgba(192,57,43,.05),rgba(26,111,168,.05));opacity:0;transition:opacity .15s}
.cell:hover::before{opacity:1}
.cell:hover{border-color:var(--accent);transform:scale(1.06);z-index:2;box-shadow:0 4px 12px var(--shadow)}
.cell.disabled{cursor:default}
.cell.disabled:hover{border-color:var(--border);transform:none;box-shadow:0 1px 3px var(--shadow)}
.cell.disabled::before{display:none}
/* correctly guessed = green */
.cell.guessed{background:var(--success-bg);border-color:var(--success);border-width:2px;cursor:default;box-shadow:0 0 0 3px rgba(46,125,82,.18),0 2px 8px rgba(46,125,82,.15)}
.cell.guessed:hover{transform:none;border-color:var(--success)}
.cell.guessed-pop{animation:guessedPop .45s cubic-bezier(.36,1.56,.64,1) both}
@keyframes guessedPop{0%{transform:scale(.85);opacity:.6}60%{transform:scale(1.12)}100%{transform:scale(1);opacity:1}}
/* team colored guessed */
.cell.guessed-t1{background:var(--t1-bg);border-color:var(--t1);border-width:2px;cursor:default;box-shadow:0 0 0 3px rgba(224,90,122,.18)}
.cell.guessed-t2{background:var(--t2-bg);border-color:var(--t2);border-width:2px;cursor:default;box-shadow:0 0 0 3px rgba(58,127,212,.18)}
.cell.guessed-t3{background:var(--t3-bg);border-color:var(--t3);border-width:2px;cursor:default;box-shadow:0 0 0 3px rgba(123,79,181,.18)}
.cell.guessed-t4{background:var(--t4-bg);border-color:var(--t4);border-width:2px;cursor:default;box-shadow:0 0 0 3px rgba(46,125,82,.18)}
.cell.guessed-t1:hover,.cell.guessed-t2:hover,.cell.guessed-t3:hover,.cell.guessed-t4:hover{transform:none}
.cell-check{font-size:1.4rem;color:inherit;line-height:1}
.cell-team-label{font-size:.55rem;font-weight:700;text-transform:uppercase;letter-spacing:.05em;opacity:.75}
/* wrong-chosen = ORANGE = what the player actually picked */
.cell.wrong-chosen{background:#fff0e0;border-color:#e07b00;border-width:2px;cursor:default;box-shadow:0 0 0 3px rgba(224,123,0,.28);animation:popIn .3s ease both}
.cell.wrong-chosen:hover{transform:none;border-color:#e07b00}
.cell.wrong-chosen::before{display:none}
/* correct-flash = RED = what they SHOULD have picked (shows tick) */
.cell.correct-flash{background:#fde8e8;border-color:var(--wrong);border-width:2px;cursor:default;box-shadow:0 0 0 4px rgba(192,57,43,.28);animation:popIn .3s ease both}
.cell.correct-flash:hover{transform:none;border-color:var(--wrong)}
.cell.correct-flash::before{display:none}
@keyframes popIn{0%{transform:scale(.86);opacity:.5}60%{transform:scale(1.1)}100%{transform:scale(1);opacity:1}}
/* missed = orange permanent (after game continues or rounds) */
.cell.missed{background:#fff0e0;border-color:#e07b00;border-width:2px;cursor:default;box-shadow:0 0 0 3px rgba(224,123,0,.22)}
.cell.missed:hover{transform:none;border-color:#e07b00}
.cell.missed::before{display:none}
.cell.missed-pop{animation:missedPop .4s cubic-bezier(.36,1.4,.64,1) both}
@keyframes missedPop{0%{transform:scale(.9)}60%{transform:scale(1.08)}100%{transform:scale(1)}}
.cell-miss-icon{font-size:1.2rem;font-weight:700;color:#e07b00;line-height:1}
.cell-correct-tick{font-size:1.2rem;font-weight:700;color:var(--wrong);line-height:1}
.cell.active-target{border-color:var(--accent);box-shadow:0 0 0 3px rgba(212,160,23,.25)}
.cell-coord{position:absolute;bottom:2px;right:4px;font-family:'Syne',sans-serif;font-size:.46rem;font-weight:700;color:var(--muted);opacity:.5}
/* side panel */
.side{border-left:1px solid var(--border);background:var(--surface);display:flex;flex-direction:column;overflow:hidden}
.side-section{padding:.88rem;border-bottom:1px solid var(--border);flex-shrink:0}
.side-lbl{font-size:.68rem;text-transform:uppercase;letter-spacing:.12em;color:var(--muted);margin-bottom:.55rem;font-weight:600}
.players-strip{display:flex;flex-wrap:wrap;gap:.3rem}
.player-pill{display:flex;align-items:center;gap:.28rem;padding:.2rem .5rem;border-radius:20px;border:1.5px solid transparent;font-size:.76rem;font-weight:500;transition:all .2s}
.player-pill.active-player{border-color:var(--accent);background:rgba(212,160,23,.08);font-weight:700}
.player-pill.is-me{text-decoration:underline;text-underline-offset:2px}
.pill-dot{width:7px;height:7px;border-radius:50%;flex-shrink:0}
.pill-role{font-size:.61rem;color:var(--muted);text-transform:uppercase;letter-spacing:.06em}
.team-col-hdr{font-size:.62rem;font-weight:700;text-transform:uppercase;letter-spacing:.08em;margin-bottom:.15rem}
.team-col{display:flex;flex-direction:column;gap:.17rem;flex:1}
.player-card{display:flex;align-items:center;gap:.68rem;padding:.65rem;background:var(--card);border:1px solid var(--border);border-radius:10px}
.p-avatar{width:35px;height:35px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-family:'Syne',sans-serif;font-size:.95rem;font-weight:800;flex-shrink:0}
.p-name{font-weight:600;font-size:.88rem;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.p-role{font-size:.71rem;color:var(--muted);margin-top:.08rem}
.target-card{background:var(--card);border:1px solid var(--border);border-radius:10px;padding:.68rem}
.target-coord-badge{font-family:'Syne',sans-serif;font-size:.72rem;font-weight:700;color:var(--muted);margin-bottom:.32rem}
.target-pair{display:flex;align-items:center;gap:.38rem;flex-wrap:wrap}
.tw{font-size:.87rem;font-weight:600;padding:.17rem .46rem;border-radius:6px}
.tw-row{color:var(--row-clr);background:rgba(192,57,43,.08)}.tw-col{color:var(--col-clr);background:rgba(26,111,168,.08)}.tw-sep{color:var(--muted);font-size:.77rem}
.hint-note{font-size:.75rem;color:var(--muted);font-style:italic;margin-top:.42rem}
.clue-field{width:100%;padding:.68rem .86rem;border:1.5px solid var(--border);border-radius:10px;background:var(--card);font-family:'Instrument Sans',sans-serif;font-size:1rem;color:var(--ink);outline:none;transition:border-color .18s;margin-bottom:.55rem}
.clue-field:focus{border-color:var(--accent);box-shadow:0 0 0 3px rgba(212,160,23,.12)}
.clue-field:disabled{background:var(--tag-bg);color:var(--muted);cursor:not-allowed}
.give-btn{width:100%;padding:.68rem;background:var(--ink);border:none;border-radius:10px;color:var(--bg);font-family:'Syne',sans-serif;font-size:.92rem;font-weight:700;cursor:pointer;transition:opacity .18s}
.give-btn:hover:not(:disabled){opacity:.85}.give-btn:disabled{opacity:.4;cursor:not-allowed}
.clue-reveal{background:var(--card);border:1.5px solid var(--accent);border-radius:10px;padding:.88rem;text-align:center;margin-bottom:.55rem}
.clue-word{font-family:'Instrument Serif',serif;font-size:1.75rem;font-weight:400;color:var(--ink);letter-spacing:-.01em}
.clue-sub{font-size:.7rem;text-transform:uppercase;letter-spacing:.1em;color:var(--muted);margin-top:.27rem}
.guess-tip{font-size:.8rem;color:var(--muted);text-align:center;line-height:1.5}
.waiting-note{background:var(--tag-bg);border:1px solid var(--border);border-radius:10px;padding:.75rem;text-align:center;font-size:.82rem;color:var(--muted);line-height:1.5}
.log-scroll{flex:1;overflow-y:auto;padding:.75rem .88rem;display:flex;flex-direction:column;gap:.3rem;min-height:0}
.log-scroll::-webkit-scrollbar{width:4px}.log-scroll::-webkit-scrollbar-thumb{background:var(--border);border-radius:2px}
.log-entry{font-size:.76rem;line-height:1.45;color:var(--muted);display:flex;gap:.38rem;align-items:flex-start}

/* WIN MODAL */
@keyframes rise{from{opacity:0;transform:translateY(20px)}to{opacity:1;transform:translateY(0)}}
.btn-again{padding:.82rem;background:var(--success);border:none;border-radius:12px;color:#fff;font-family:'Syne',sans-serif;font-size:.95rem;font-weight:700;cursor:pointer;transition:opacity .18s;width:100%}
.btn-again:hover{opacity:.85}
.btn-home{padding:.82rem;background:transparent;border:1.5px solid var(--border);border-radius:12px;color:var(--muted);font-family:'Instrument Sans',sans-serif;font-size:.86rem;cursor:pointer;transition:all .18s;width:100%}
.btn-home:hover{border-color:var(--muted);color:var(--ink)}
.btn-secondary{padding:.82rem;background:transparent;border:1.5px solid var(--accent);border-radius:12px;color:var(--accent);font-family:'Syne',sans-serif;font-size:.9rem;font-weight:700;cursor:pointer;transition:all .18s;width:100%}
.btn-secondary:hover{background:var(--accent);color:var(--ink)}
.win-modal-box{background:var(--card);border:1px solid var(--border);border-radius:22px;padding:1.8rem 1.6rem;box-shadow:0 8px 40px rgba(28,23,16,.22);max-width:380px;width:92%;text-align:center;animation:rise .4s ease both;max-height:90vh;overflow-y:auto}
.win-trophy{font-size:3.4rem;line-height:1;margin-bottom:.6rem}
.win-title{font-family:'Syne',sans-serif;font-size:1.7rem;font-weight:800;letter-spacing:-.03em;margin-bottom:.25rem;color:var(--success)}
.win-sub{color:var(--muted);font-size:.88rem;margin-bottom:.9rem;line-height:1.5}
.win-players{display:flex;flex-wrap:wrap;gap:.35rem;justify-content:center;margin-bottom:.9rem}
.win-player-chip{display:flex;align-items:center;gap:.3rem;padding:.25rem .6rem;border-radius:20px;font-size:.8rem;font-weight:600;border:1.5px solid}
.win-info{background:var(--tag-bg);border:1px solid var(--border);border-radius:12px;padding:.65rem .9rem;margin-bottom:1rem;text-align:left;display:flex;flex-direction:column;gap:.3rem}
.win-info-row{display:flex;align-items:center;gap:.45rem;font-size:.82rem;color:var(--muted)}
.win-info-val{font-weight:600;color:var(--ink)}
.win-teams-scores{display:flex;gap:.45rem;margin-bottom:.9rem;flex-wrap:wrap;justify-content:center}
.win-team-box{padding:.6rem .9rem;border-radius:12px;border:2px solid;min-width:75px}
.win-team-box.winner{transform:scale(1.06);box-shadow:0 4px 14px var(--shadow)}
.win-team-score{font-family:'Syne',sans-serif;font-size:1.6rem;font-weight:800;line-height:1}
.win-team-label{font-size:.62rem;text-transform:uppercase;letter-spacing:.07em;opacity:.75;margin-top:.14rem}
.win-btns{display:flex;flex-direction:column;gap:.5rem}
/* host config inside win modal */
.host-config{background:var(--surface);border:1px solid var(--border);border-radius:12px;padding:.85rem;margin-bottom:.75rem;text-align:left}
.host-config-title{font-size:.7rem;text-transform:uppercase;letter-spacing:.1em;color:var(--muted);font-weight:600;margin-bottom:.6rem}
.config-opt-grid{display:flex;gap:.35rem;flex-wrap:wrap;margin-bottom:.5rem}
.config-opt-btn{flex:1;min-width:48px;padding:.45rem .25rem;border:1.5px solid var(--border);border-radius:9px;background:transparent;font-family:'Instrument Sans',sans-serif;font-size:.79rem;font-weight:500;color:var(--muted);cursor:pointer;transition:all .18s;text-align:center}
.config-opt-btn.active{border-color:var(--accent);background:rgba(212,160,23,.1);color:var(--ink);font-weight:600}
.config-timer-row{display:flex;align-items:center;gap:.6rem;font-size:.82rem;color:var(--muted);padding-top:.4rem;border-top:1px solid var(--border);margin-top:.4rem}

/* MODAL overlay (game over + ready) */
.modal-bg{display:none;position:fixed;inset:0;z-index:200;align-items:center;justify-content:center;background:rgba(28,23,16,.55);backdrop-filter:blur(3px)}
.modal-bg.open{display:flex}
.modal-box{background:var(--card);border:1px solid var(--border);border-radius:22px;padding:2rem 1.8rem;box-shadow:0 8px 40px rgba(28,23,16,.22);max-width:340px;width:90%;text-align:center;animation:rise .35s ease both}
.gameover-icon{font-size:3.8rem;line-height:1;margin-bottom:.72rem}
.gameover-title{font-family:'Syne',sans-serif;font-size:1.7rem;font-weight:800;letter-spacing:-.03em;margin-bottom:.36rem;color:var(--wrong)}
.gameover-sub{color:var(--muted);margin-bottom:1.35rem;line-height:1.5;font-size:.91rem}
.gameover-btns{display:flex;flex-direction:column;gap:.52rem}
/* ready modal */
.ready-title{font-family:'Syne',sans-serif;font-size:1.4rem;font-weight:800;margin-bottom:.28rem}
.ready-sub{color:var(--muted);font-size:.85rem;margin-bottom:1rem;line-height:1.5}
.ready-list{text-align:left;margin-bottom:1rem;display:flex;flex-direction:column;gap:.25rem}
.ready-row{display:flex;align-items:center;gap:.5rem;font-size:.84rem}
.ready-icon{flex-shrink:0;font-size:.95rem}


/* HURRY BUTTON + DROPDOWN */
.hurry-wrap{position:relative}
.hdr-btn.hurry{border-color:#e07b00;color:#e07b00;font-size:.82rem}
.hdr-btn.hurry:hover{background:#e07b00;color:#fff}
.hurry-menu{display:none;position:absolute;top:calc(100% + 6px);right:0;background:var(--card);border:1.5px solid var(--border);border-radius:14px;box-shadow:0 6px 24px rgba(28,23,16,.18);z-index:300;overflow:hidden;min-width:170px;animation:dropIn .15s ease both}
@keyframes dropIn{from{opacity:0;transform:translateY(-6px)}to{opacity:1;transform:translateY(0)}}
.hurry-menu.open{display:block}
.hurry-option{display:block;width:100%;padding:.65rem 1rem;border:none;background:transparent;font-family:'Instrument Sans',sans-serif;font-size:.88rem;font-weight:600;color:var(--ink);cursor:pointer;text-align:left;transition:background .12s;white-space:nowrap}
.hurry-option:hover{background:var(--tag-bg)}
.hurry-option:active{background:var(--border)}

/* FLOATING REACTION */
.reaction-container{position:fixed;inset:0;pointer-events:none;z-index:9999;overflow:hidden}
.reaction-bubble{position:absolute;font-family:'Syne',sans-serif;font-weight:800;font-size:clamp(1.4rem,4vw,2.2rem);color:#fff;text-shadow:0 2px 8px rgba(0,0,0,.35),0 0 0 3px rgba(224,123,0,.5);white-space:nowrap;animation:reactionFly 3.2s cubic-bezier(.22,1,.36,1) both;user-select:none}
@keyframes reactionFly{
  0%  {opacity:0;transform:scale(.4) translateY(0)}
  8%  {opacity:1;transform:scale(1.25) translateY(-20px)}
  18% {transform:scale(1) translateY(-40px)}
  60% {opacity:1;transform:scale(1) translateY(-180px) rotate(var(--rot))}
  100%{opacity:0;transform:scale(.8) translateY(-320px) rotate(var(--rot))}
}

.toast{position:fixed;bottom:1.4rem;left:50%;transform:translateX(-50%) translateY(80px);background:var(--ink);color:var(--bg);padding:.6rem 1.1rem;border-radius:24px;font-size:.87rem;font-weight:500;z-index:500;transition:transform .3s ease;pointer-events:none;white-space:nowrap;max-width:90vw;text-align:center}
.toast.show{transform:translateX(-50%) translateY(0)}
</style>
</head>
<body>

<!-- ‚ïê‚ïê‚ïê LOBBY ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="lobby" class="screen active">
  <div class="logo-block">
    <div class="logo-cross">
      <span class="w-row">Cross</span><span class="w-sep">‚úï</span><span class="w-col">Clues</span>
    </div>
    <div class="logo-by">by <em>olikpa</em></div>
  </div>

  <div class="lobby-card">
    <div class="lang-row">
      <button class="lang-pill" onclick="setLang('en')">üá¨üáß English</button>
      <button class="lang-pill active" onclick="setLang('es')">üá™üá∏ Espa√±ol</button>
    </div>

    <div id="create-section">
      <div class="section-lbl" id="lbl-your-name">Tu Nombre</div>
      <input type="text" class="field" id="create-name" maxlength="20" placeholder="Jugador 1">

      <div class="opt-group">
        <div class="section-lbl" id="lbl-game-mode">Modo de Juego</div>
        <div class="opt-grid">
          <button class="opt-btn active" id="mode-btn-coop" onclick="selectMode('coop')">ü§ù <span id="lbl-mode-coop">Cooperativo</span></button>
          <button class="opt-btn" id="mode-btn-teams" onclick="selectMode('teams')">‚öîÔ∏è <span id="lbl-mode-teams">Equipos</span></button>
        </div>
      </div>

      <div class="opt-group">
        <div class="section-lbl" id="lbl-grid-size">Tama√±o del Tablero</div>
        <div class="opt-grid">
          <button class="opt-btn" id="size-btn-3" onclick="selectSize(3)">3√ó3</button>
          <button class="opt-btn active" id="size-btn-4" onclick="selectSize(4)">4√ó4</button>
          <button class="opt-btn" id="size-btn-5" onclick="selectSize(5)">5√ó5</button>
          <button class="opt-btn" id="size-btn-6" onclick="selectSize(6)">6√ó6</button>
        </div>
      </div>

      <div class="opt-group">
        <div class="section-lbl" id="lbl-theme">Tem√°tica</div>
        <div class="opt-grid">
          <button class="opt-btn active" id="theme-btn-classic" onclick="selectTheme('classic')">üåç <span id="lbl-theme-classic">Cl√°sica</span></button>
          <button class="opt-btn" id="theme-btn-football" onclick="selectTheme('football')">‚öΩ <span id="lbl-theme-football">F√∫tbol</span></button>
        </div>
      </div>

      <div class="timer-row">
        <label class="toggle-switch">
          <input type="checkbox" id="timer-toggle" onchange="onTimerToggle()">
          <span class="toggle-slider"></span>
        </label>
        <span class="timer-label" id="lbl-timer-toggle">Activar temporizador</span>
        <input type="number" class="timer-input" id="timer-secs" value="90" min="15" max="600" disabled>
        <span class="timer-label" style="flex:none" id="lbl-secs">seg</span>
      </div>

      <button class="btn-main btn-create" onclick="createRoom()" id="btn-create">Crear Sala</button>
    </div>

    <!-- Waiting room -->
    <div id="waiting-section" style="display:none">
      <div class="room-code-display">
        <div class="room-code-label" id="lbl-room-code">C√≥digo de Sala</div>
        <div class="room-code-value" id="room-code-value">‚Äî‚Äî‚Äî</div>
      </div>
      <div class="players-in-room">
        <div class="section-lbl" id="lbl-players-joined">Jugadores en la sala</div>
        <div class="players-list" id="lobby-players-list"></div>
      </div>
      <div id="teams-config" style="display:none;margin-top:.85rem">
        <div class="section-lbl" id="lbl-assign-teams">Asignar jugadores a equipos</div>
        <div class="num-teams-row">
          <span id="lbl-num-teams">N√∫mero de equipos:</span>
          <select id="num-teams-sel" onchange="onNumTeamsChange()">
            <option value="2">2</option><option value="3">3</option><option value="4">4</option>
          </select>
        </div>
        <div class="team-assign-wrap" id="team-assign-list"></div>
      </div>
      <button class="start-game-btn" id="start-game-btn" onclick="hostStartGame()" disabled>Empezar Partida ‚Üí</button>
      <div class="status-msg" style="margin-top:.5rem">
        <span id="waiting-text">Esperando jugadores</span><span class="waiting-dots"></span>
      </div>
    </div>

    <div class="or-divider" id="or-div">o</div>

    <div id="join-section">
      <div class="section-lbl" id="lbl-join-name">Tu Nombre</div>
      <input type="text" class="field" id="join-name" maxlength="20" placeholder="Jugador 2">
      <div class="section-lbl" id="lbl-enter-code">C√≥digo de Sala</div>
      <input type="text" class="field" id="join-code" maxlength="6" placeholder="ABC123"
        style="text-transform:uppercase;letter-spacing:.15em;font-family:'Syne',sans-serif;font-weight:700"
        oninput="this.value=this.value.toUpperCase()">
      <button class="btn-main btn-join" onclick="joinRoom()" id="btn-join">Unirse</button>
      <div class="status-msg" id="join-status" style="display:none"></div>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê GAME ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="game" class="screen">
  <div class="game-header">
    <div class="header-logo"><span class="r">Cross</span><span class="c">‚úïClues</span><span style="font-size:.55rem;font-weight:400;color:var(--muted);letter-spacing:.1em;text-transform:uppercase;margin-left:.35rem;align-self:flex-end;padding-bottom:.1rem"> by olikpa</span></div>
    <div class="header-center">
      <span class="score-chip" id="hdr-score">0/16</span>
      <span class="timer-chip" id="hdr-timer" style="display:none">1:30</span>
      <span class="room-chip" id="hdr-room" onclick="copyRoomCode()">‚Äî</span>
    </div>
    <div class="hdr-btns">
      <div class="hurry-wrap" id="hurry-wrap">
        <button class="hdr-btn hurry" id="btn-hurry" onclick="toggleHurryMenu(event)" title="Apurar">üì£</button>
        <div class="hurry-menu" id="hurry-menu">
          <button class="hurry-option" onclick="sendHurry('DALE VIEJO!!!')">üò§ DALE VIEJO!!!</button>
          <button class="hurry-option" onclick="sendHurry('APURATE P*TO')">ü§¨ APURATE P*TO</button>
          <button class="hurry-option" onclick="sendHurry('DALE BOCA')">üíôüíõ DALE BOCA</button>
        </div>
      </div>
      <button class="hdr-btn" id="btn-sound-game" onclick="toggleSound()" title="Sonido">üîä</button>
      <button class="hdr-btn" onclick="zoomGrid(-1)" title="Alejar tablero">‚àí</button>
      <button class="hdr-btn" onclick="zoomGrid(1)" title="Acercar tablero">+</button>
      <button class="hdr-btn green" id="btn-new-game" onclick="requestNewGame()">Nuevo</button>
      <button class="hdr-btn red" id="btn-quit" onclick="quitGame()">Salir</button>
    </div>
  </div>
  <div class="teams-score-bar" id="teams-score-bar" style="display:none"></div>
  <div class="game-body">
    <div class="grid-area">
      <div id="grid-wrap" class="grid-wrap" data-zoom="1"></div>
    </div>
    <div class="side">
      <div class="side-section">
        <div class="side-lbl" id="lbl-players">Jugadores</div>
        <div class="players-strip" id="players-strip"></div>
      </div>
      <div class="side-section" id="side-player">
        <div class="side-lbl" id="lbl-now-playing">Turno de</div>
        <div class="player-card">
          <div class="p-avatar" id="p-avatar">?</div>
          <div><div class="p-name" id="p-name-display">‚Äî</div><div class="p-role" id="p-role-display">‚Äî</div></div>
        </div>
      </div>
      <div class="side-section" id="giver-block">
        <div class="side-lbl" id="lbl-target">Objetivo</div>
        <div class="target-card">
          <div class="target-coord-badge" id="tc-coord">‚Äî</div>
          <div class="target-pair" id="tc-pair"></div>
          <div class="hint-note" id="tc-hint"></div>
        </div>
      </div>
      <div class="side-section" id="clue-input-block">
        <div class="side-lbl" id="lbl-give-clue">Tu Pista</div>
        <input type="text" class="clue-field" id="clue-input" maxlength="40" placeholder="una palabra‚Ä¶"
          onkeydown="if(event.key==='Enter') submitClue()">
        <button class="give-btn" id="give-btn" onclick="submitClue()">Dar Pista ‚Üí</button>
      </div>
      <div class="side-section" id="guesser-block" style="display:none">
        <div class="side-lbl" id="lbl-the-clue">La Pista</div>
        <div class="clue-reveal">
          <div class="clue-word" id="revealed-clue">‚Äî</div>
          <div class="clue-sub" id="lbl-one-word">una palabra</div>
        </div>
        <div class="guess-tip" id="guess-tip">¬°Toc√° la celda que corresponde!</div>
      </div>
      <div class="side-section" id="waiting-block" style="display:none">
        <div class="waiting-note" id="waiting-note-text">Esperando‚Ä¶</div>
      </div>
      <div class="side-lbl" style="padding:.65rem .88rem .18rem;flex-shrink:0" id="lbl-log">Registro</div>
      <div class="log-scroll" id="log-scroll"></div>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê GAME OVER MODAL ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="gameover-modal" class="modal-bg">
  <div class="modal-box">
    <div class="gameover-icon">üí•</div>
    <div class="gameover-title" id="go-title">¬°Game Over!</div>
    <div class="gameover-sub" id="go-sub">Erraron un cruce.</div>
    <div class="gameover-btns">
      <button class="btn-again" id="btn-go-again" onclick="requestNewGame()">Intentar de nuevo</button>
      <button class="btn-secondary" id="btn-go-analyze" onclick="closeGameOverModal()">üîç Analizar el tablero</button>
      <button class="btn-home" id="btn-go-home2" onclick="goHome()">Salir de la sala</button>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê READY MODAL ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="ready-modal" class="modal-bg">
  <div class="modal-box">
    <div class="gameover-icon">üé≤</div>
    <div class="ready-title" id="ready-title">Nuevo Juego</div>
    <div class="ready-sub" id="ready-sub">Esperando que todos confirmen‚Ä¶</div>
    <div class="ready-list" id="ready-list"></div>
    <div id="ready-action-btns" style="display:flex;flex-direction:column;gap:.5rem">
      <button class="btn-again" id="btn-join-ready" onclick="joinReady()" style="display:none">‚ñ∂ Unirme a la nueva partida</button>
      <button class="btn-home" id="btn-leave-ready" onclick="leaveFromReady()">Salir de la sala</button>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê WIN MODAL ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="win-modal" class="modal-bg">
  <div class="win-modal-box">
    <div class="win-trophy">üèÜ</div>
    <div class="win-title" id="win-title">¬°Felicitaciones!</div>
    <div class="win-sub" id="win-sub"></div>
    <div class="win-players" id="win-players"></div>
    <div class="win-teams-scores" id="win-teams-scores" style="display:none"></div>
    <div class="win-info" id="win-info"></div>
    <!-- HOST: config for new game with different settings -->
    <div class="host-config" id="host-config" style="display:none">
      <div class="host-config-title" id="lbl-new-config">Nueva configuraci√≥n</div>
      <div class="host-config-title" style="margin-bottom:.35rem;margin-top:.1rem;font-size:.72rem;color:var(--muted);font-weight:400;text-transform:none;letter-spacing:0" id="lbl-mode-cfg">Modo</div>
      <div class="config-opt-grid">
        <button class="config-opt-btn active" id="cfg-mode-coop" onclick="setCfgMode('coop')">ü§ù <span id="cfg-lbl-coop">Cooperativo</span></button>
        <button class="config-opt-btn" id="cfg-mode-teams" onclick="setCfgMode('teams')">‚öîÔ∏è <span id="cfg-lbl-teams">Equipos</span></button>
      </div>
      <div class="host-config-title" style="margin-bottom:.35rem;margin-top:.4rem;font-size:.72rem;color:var(--muted);font-weight:400;text-transform:none;letter-spacing:0" id="lbl-theme-cfg">Tem√°tica</div>
      <div class="config-opt-grid">
        <button class="config-opt-btn active" id="cfg-theme-classic" onclick="setCfgTheme('classic')">üåç <span id="cfg-lbl-theme-classic">Cl√°sica</span></button>
        <button class="config-opt-btn" id="cfg-theme-football" onclick="setCfgTheme('football')">‚öΩ <span id="cfg-lbl-theme-football">F√∫tbol</span></button>
      </div>
      <div class="host-config-title" style="margin-bottom:.35rem;margin-top:.4rem;font-size:.72rem;color:var(--muted);font-weight:400;text-transform:none;letter-spacing:0" id="lbl-size-cfg">Tablero</div>
      <div class="config-opt-grid">
        <button class="config-opt-btn" id="cfg-size-3" onclick="setCfgSize(3)">3√ó3</button>
        <button class="config-opt-btn active" id="cfg-size-4" onclick="setCfgSize(4)">4√ó4</button>
        <button class="config-opt-btn" id="cfg-size-5" onclick="setCfgSize(5)">5√ó5</button>
        <button class="config-opt-btn" id="cfg-size-6" onclick="setCfgSize(6)">6√ó6</button>
      </div>
      <div class="config-timer-row">
        <label class="toggle-switch">
          <input type="checkbox" id="cfg-timer-toggle" onchange="onCfgTimerToggle()">
          <span class="toggle-slider"></span>
        </label>
        <span id="lbl-cfg-timer">Temporizador</span>
        <input type="number" class="timer-input" id="cfg-timer-secs" value="90" min="15" max="600" disabled style="margin-left:auto">
        <span style="font-size:.8rem;color:var(--muted)" id="lbl-cfg-secs">seg</span>
      </div>
    </div>
    <div id="win-cfg-confirm" style="display:none;margin-bottom:.5rem">
      <button class="btn-again" onclick="requestNewGame('newcfg')" style="background:var(--accent);color:var(--ink)" id="btn-cfg-confirm">Empezar ‚Üí</button>
    </div>
    <div class="win-btns" id="win-btns"></div>
  </div>
</div>

<div class="reaction-container" id="reaction-container"></div>
<div class="toast" id="toast"></div>

<script type="module">
const FIREBASE_CONFIG={
  apiKey:"AIzaSyCa_uT9_f2LbjO-zAKXPVK5Fob_4NWoHLA",
  authDomain:"cross-clues-31450.firebaseapp.com",
  databaseURL:"https://cross-clues-31450-default-rtdb.firebaseio.com",
  projectId:"cross-clues-31450",
  storageBucket:"cross-clues-31450.firebasestorage.app",
  messagingSenderId:"1043663543507",
  appId:"1:1043663543507:web:13ee17b1da0c47b2c74826",
};
import{initializeApp}from"https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import{getDatabase,ref,set,get,update,onValue,off}from"https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";
const app=initializeApp(FIREBASE_CONFIG);
const db=getDatabase(app);

const TEAM_COLORS={
  1:{hex:'#e05a7a',bg:'#fde8ef',label:'üå∏'},
  2:{hex:'#3a7fd4',bg:'#e8f0fd',label:'üîµ'},
  3:{hex:'#7b4fb5',bg:'#f0e8fd',label:'üü£'},
  4:{hex:'#2e7d52',bg:'#d4f0e0',label:'üü¢'},
};
const PLAYER_COLORS=['#c0392b','#1a6fa8','#2e7d52','#7b3fa0','#d4a017','#00868a','#e07b39','#5a5a9c','#8b4513','#1a7a4a'];

// ‚îÄ‚îÄ WORDS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const WORDS={
  es:["Selva","Desierto","Playa","Volc√°n","Isla","Cueva","Oc√©ano","R√≠o","Monta√±a","Bosque","Pantano","Glaciar","Pradera","Cascada","Acantilado","Valle","Jungla","Polo","Arrecife","Abismo","Horizonte","Estanque","Jard√≠n","Invernadero","Ciudad","Pueblo","Hospital","Escuela","Parque","Cine","Estadio","Biblioteca","Aeropuerto","Granja","Castillo","Prisi√≥n","Laboratorio","Hotel","Restaurante","Oficina","Iglesia","Museo","Cementerio","Zool√≥gico","Tienda","Supermercado","Puente","Estaci√≥n","Gimnasio","Teatro","Circo","Casino","Banco","F√°brica","Mina","Puerto","Faro","Templo","Pir√°mide","Torre","Muro","Trinchera","Mansi√≥n","Caba√±a","Rascacielos","Metro","Carretera","Callej√≥n","Plaza","Mercado","Universidad","Guarder√≠a","Comisar√≠a","Cuartel","Juzgado","Parlamento","Ayuntamiento","Catedral","Sinagoga","Mezquita","Santuario","Altar","Tumba","Ruinas","Laberinto","Helipuerto","Quiosco","Espacio","Marte","Estrella","Planeta","Cometa","Galaxia","Universo","Sat√©lite","Cohete","Manzana","Pan","Caf√©","Chocolate","Pizza","Queso","Huevo","Vino","Cuchillo","Tenedor","Martillo","Llave","Reloj","Tel√©fono","C√°mara","Libro","Espejo","L√°mpara","Silla","Mesa","Cama","Maleta","Dinero","Guitarra","Pelota","Bicicleta","Coche","Avi√≥n","Barco","Tren","Paraguas","Gafas","Zapato","Sombrero","Anillo","Jab√≥n","Cepillo","Papel","Pintura","Piedra","Radio","Botella","Caja","Bolsa","Cesta","Cuchara","Plato","Vaso","Sart√©n","Olla","Horno","Nevera","Toalla","Peine","Esponja","Almohada","S√°bana","Manta","Cortina","Microondas","Aspiradora","Lavadora","Plancha","Ventilador","Estufa","Grifo","Ladrillo","Cemento","Clavo","Tornillo","Sierra","Taladro","Br√∫jula","Mapa","Telescopio","Microscopio","Jeringuilla","Pastilla","Vendaje","Muleta","Term√≥metro","Dron","Chip","L√°ser","Prism√°ticos","Bater√≠a","Enchufe","Cable","Pantalla","Laptop","Perro","Gato","Caballo","Le√≥n","Elefante","P√°jaro","Pez","Serpiente","Ara√±a","Abeja","Tigre","Oso","Lobo","Tibur√≥n","Ballena","Delf√≠n","√Åguila","B√∫ho","Mariposa","Hormiga","Rana","Tortuga","Cocodrilo","Mono","Vaca","Oveja","Cerdo","Pollo","Rat√≥n","Conejo","M√©dico","Polic√≠a","Bombero","Profesor","Chef","Artista","Piloto","Astronauta","Soldado","Rey","Beb√©","Gigante","Fantasma","Robot","Alien","Pirata","Payaso","Mago","Atleta","Cient√≠fico","Abogado","Granjero","Actor","Cantante","Bailar√≠n","Periodista","Carpintero","Fot√≥grafo","Detective","Esp√≠a","Ninja","Caballero","Vikingo","Vaquero","Zombi","Vampiro","Sirena","Drag√≥n","Juez","Pol√≠tico","Banquero","Marinero","Minero","Mec√°nico","Electricista","Fontanero","Peluquero","Veterinario","√Årbol","Flor","Nube","√Åtomo","Sangre","Hueso","Cerebro","Coraz√≥n","Pulm√≥n","Mano","Pie","Ojo","Oreja","Nariz","Boca","Diente","Pelo","Piel","U√±a","M√∫sculo","Esqueleto","Nervio","Gen","Amor","Miedo","Tiempo","Sue√±o","Guerra","Paz","M√∫sica","Magia","Suerte","Destino","Ruido","Calor","Velocidad","Peso","Altura","Color","Forma","N√∫mero","Historia","Futuro","Mentira","Verdad","Crimen","Justicia","Veneno","Medicina","Electricidad","Fuego","Agua","Aire","Tierra","Oro","Basura","Regalo","Vacaciones","Peligro","Odio","Alegr√≠a","Tristeza","Ira","Orgullo","Envidia","Poder","Libertad","Ley","Deuda","√âxito","Fracaso","Victoria","Derrota","Secreto","Misterio","Enigma","Arte","Ciencia","Religi√≥n","Pol√≠tica","Idioma","Sonido","Ritmo","Poes√≠a","Danza","Juego","Deporte","Trabajo","Fiesta","Boda","Funeral","Viaje","Aventura","Caos","Orden","Energ√≠a","Fuerza","Gravedad","Vac√≠o","Infinito","Ma√±ana","Semana","Mes","A√±o","Siglo","Pasado","Presente","Eternidad","Volar","Nadar","Correr","Dormir","Comer","Cantar","Bailar","Escribir","Leer","Pelear","Ganar","Perder","Romper","Arreglar","Comprar","Vender","Grande","Peque√±o","R√°pido","Lento","Viejo","Nuevo","Caro","Barato","Pesado","Ligero","Duro","Blando","Dulce","Salado","Amargo","Picante","Sucio","Limpio","Mojado","Seco","Fuerte","D√©bil","Invisible","Brillante","Oscuro","Rojo","Azul","Verde","Amarillo","Blanco","Negro","Redondo","Cuadrado","Largo","Corto","Caliente","Helado","Suave","√Åspero","Lleno","Abierto","Cerrado","Joven","Anciano","Rico","Pobre","Sano","Enfermo","Vivo","Muerto","Real","Falso","F√°cil","Dif√≠cil","√ötil","Solo","Libre","Preso","Cerca","Lejos","Arriba","Abajo","Dentro","Fuera","Norte","Sur","Este","Oeste"],
  en:["Jungle","Desert","Beach","Volcano","Island","Cave","Ocean","River","Mountain","Forest","Swamp","Glacier","Meadow","Waterfall","Cliff","Valley","Reef","Abyss","Horizon","Pond","City","Village","Hospital","School","Park","Cinema","Stadium","Library","Airport","Farm","Castle","Prison","Laboratory","Hotel","Restaurant","Office","Church","Museum","Cemetery","Zoo","Store","Bridge","Station","Gym","Theater","Circus","Casino","Bank","Factory","Mine","Harbor","Lighthouse","Temple","Pyramid","Tower","Wall","Trench","Mansion","Skyscraper","Subway","Highway","Alley","Square","Market","University","Precinct","Barracks","Courthouse","Parliament","Cathedral","Mosque","Sanctuary","Altar","Tomb","Ruins","Maze","Greenhouse","Space","Mars","Star","Planet","Comet","Galaxy","Universe","Satellite","Rocket","Apple","Bread","Coffee","Chocolate","Pizza","Cheese","Egg","Wine","Knife","Fork","Hammer","Key","Clock","Phone","Camera","Book","Mirror","Lamp","Chair","Table","Bed","Suitcase","Money","Guitar","Ball","Bicycle","Car","Airplane","Ship","Train","Umbrella","Glasses","Shoe","Hat","Ring","Soap","Brush","Paper","Paint","Stone","Radio","Bottle","Box","Bag","Spoon","Plate","Cup","Pan","Oven","Fridge","Towel","Pillow","Blanket","Curtain","Microwave","Drill","Compass","Map","Telescope","Microscope","Syringe","Pill","Bandage","Thermometer","Drone","Chip","Laser","Binoculars","Battery","Screen","Laptop","Dog","Cat","Horse","Lion","Elephant","Bird","Fish","Snake","Spider","Bee","Tiger","Bear","Wolf","Shark","Whale","Dolphin","Eagle","Owl","Butterfly","Ant","Frog","Turtle","Crocodile","Monkey","Cow","Sheep","Pig","Chicken","Mouse","Rabbit","Doctor","Police","Firefighter","Teacher","Chef","Artist","Pilot","Astronaut","Soldier","King","Baby","Giant","Ghost","Robot","Alien","Pirate","Clown","Wizard","Athlete","Scientist","Lawyer","Farmer","Actor","Singer","Dancer","Journalist","Carpenter","Photographer","Detective","Spy","Ninja","Knight","Viking","Cowboy","Zombie","Vampire","Mermaid","Dragon","Judge","Politician","Sailor","Miner","Mechanic","Electrician","Plumber","Barber","Vet","Blood","Bone","Brain","Heart","Lung","Hand","Foot","Eye","Ear","Nose","Mouth","Tooth","Hair","Skin","Muscle","Skeleton","Nerve","Gene","Love","Fear","Time","Dream","War","Peace","Music","Magic","Luck","Destiny","Noise","Heat","Speed","Weight","Height","Color","Shape","Number","History","Future","Lie","Truth","Crime","Justice","Poison","Medicine","Fire","Water","Air","Earth","Gold","Trash","Gift","Danger","Hate","Joy","Sadness","Anger","Pride","Envy","Power","Freedom","Law","Debt","Success","Failure","Victory","Defeat","Secret","Mystery","Art","Science","Religion","Politics","Language","Sound","Rhythm","Poetry","Dance","Game","Sport","Work","Party","Wedding","Journey","Adventure","Chaos","Order","Energy","Gravity","Infinity","Morning","Week","Month","Year","Century","Past","Eternity","Big","Small","Fast","Slow","Old","New","Expensive","Heavy","Light","Hard","Soft","Sweet","Salty","Bitter","Spicy","Dirty","Clean","Wet","Dry","Strong","Weak","Invisible","Bright","Dark","Red","Blue","Green","Yellow","White","Black","Round","Square","Long","Short","Hot","Cold","Smooth","Rough","Full","Open","Closed","Young","Rich","Poor","Healthy","Sick","Alive","Dead","Real","Fake","Easy","Difficult","Useful","Alone","Free","Near","Far","Up","Down"]
};

const SIMILAR_ES=[
  new Set(["Selva","Jungla","Bosque"]),new Set(["Oc√©ano","R√≠o","Lago","Estanque","Arrecife"]),
  new Set(["Monta√±a","Volc√°n","Acantilado","Valle"]),new Set(["Desierto","Pradera","Pantano","Glaciar"]),
  new Set(["Playa","Isla","Puerto","Faro"]),new Set(["Ciudad","Pueblo","Plaza","Callej√≥n","Rascacielos","Carretera","Metro"]),
  new Set(["Iglesia","Catedral","Sinagoga","Mezquita","Templo","Santuario","Altar"]),
  new Set(["Hospital","Universidad","Escuela","Laboratorio","Comisar√≠a","Cuartel","Juzgado","Parlamento","Ayuntamiento"]),
  new Set(["Hotel","Mansi√≥n","Caba√±a","Castillo"]),new Set(["Cine","Teatro","Circo","Casino","Estadio","Gimnasio"]),
  new Set(["Tienda","Supermercado","Mercado","Banco"]),
  new Set(["Estrella","Luna","Sol","Planeta","Cometa","Galaxia","Universo","Espacio","Marte","Sat√©lite","Cohete"]),
  new Set(["Fuego","Calor","Volc√°n"]),new Set(["Agua","Lluvia","R√≠o","Oc√©ano"]),
  new Set(["√Årbol","Flor","Jard√≠n","Invernadero","Bosque"]),new Set(["Nube","Lluvia","Horizonte"]),
  new Set(["Perro","Gato","Conejo","Rat√≥n"]),new Set(["Le√≥n","Tigre"]),
  new Set(["Ballena","Delf√≠n","Tibur√≥n","Pez"]),new Set(["√Åguila","B√∫ho","P√°jaro"]),
  new Set(["Ara√±a","Hormiga","Abeja","Mariposa"]),new Set(["Serpiente","Cocodrilo","Rana","Tortuga"]),
  new Set(["Vaca","Oveja","Cerdo","Caballo","Pollo"]),
  new Set(["Amor","Odio","Envidia","Orgullo","Ira","Alegr√≠a","Tristeza"]),
  new Set(["Guerra","Paz","Crimen","Justicia","Ley","Derrota","Victoria"]),
  new Set(["M√∫sica","Sonido","Ritmo","Danza","Cantar","Bailar"]),new Set(["Arte","Poes√≠a","Pintura"]),
  new Set(["Ma√±ana","Semana","Mes","A√±o","Siglo","Pasado","Presente","Futuro","Eternidad"]),
  new Set(["Mano","Pie","Ojo","Oreja","Nariz","Boca","Diente","Pelo","Piel","U√±a","M√∫sculo","Hueso","Esqueleto","Nervio","Cerebro","Coraz√≥n","Pulm√≥n","Sangre"]),
  new Set(["Cuchillo","Tenedor","Cuchara","Plato","Vaso","Sart√©n","Olla","Horno","Nevera","Microondas"]),
  new Set(["Cama","Almohada","S√°bana","Manta"]),new Set(["Silla","Mesa","Cortina","L√°mpara"]),
  new Set(["Coche","Bicicleta","Tren","Avi√≥n","Barco","Metro"]),
  new Set(["Rojo","Azul","Verde","Amarillo","Blanco","Negro"]),
  new Set(["Grande","Peque√±o","Largo","Corto"]),new Set(["R√°pido","Lento","Velocidad"]),
  new Set(["Caliente","Helado","Fr√≠o","Calor"]),new Set(["Dulce","Salado","Amargo","Picante"]),
  new Set(["Sucio","Limpio","Mojado","Seco"]),new Set(["Fuerte","D√©bil","Duro","Blando","Suave","√Åspero"]),
  new Set(["Rico","Pobre","Deuda","Dinero","Oro"]),new Set(["Zombi","Vampiro","Fantasma","Drag√≥n","Sirena"]),
  new Set(["Pirata","Vikingo","Ninja","Caballero","Vaquero"]),new Set(["Detective","Esp√≠a","Polic√≠a"]),
  new Set(["Cantante","Bailar√≠n","Actor","Artista"]),
];
const SIMILAR_EN=[
  new Set(["Jungle","Forest"]),new Set(["Ocean","River","Lake","Pond","Reef"]),
  new Set(["Mountain","Volcano","Cliff","Valley"]),new Set(["Desert","Meadow","Swamp","Glacier"]),
  new Set(["Beach","Island","Harbor","Lighthouse"]),new Set(["City","Village","Square","Alley","Skyscraper","Highway","Subway"]),
  new Set(["Church","Cathedral","Mosque","Temple","Sanctuary","Altar"]),
  new Set(["Hospital","University","School","Laboratory","Precinct","Barracks","Courthouse"]),
  new Set(["Hotel","Mansion","Castle"]),new Set(["Cinema","Theater","Circus","Casino","Stadium","Gym"]),
  new Set(["Store","Market","Bank"]),
  new Set(["Star","Moon","Sun","Planet","Comet","Galaxy","Universe","Space","Mars","Satellite","Rocket"]),
  new Set(["Fire","Heat"]),new Set(["Water","Rain","River","Ocean"]),
  new Set(["Tree","Flower","Garden","Greenhouse","Forest"]),new Set(["Cloud","Rain","Horizon"]),
  new Set(["Dog","Cat","Rabbit","Mouse"]),new Set(["Lion","Tiger"]),
  new Set(["Whale","Dolphin","Shark","Fish"]),new Set(["Eagle","Owl","Bird"]),
  new Set(["Spider","Ant","Bee","Butterfly"]),new Set(["Snake","Crocodile","Frog","Turtle"]),
  new Set(["Cow","Sheep","Pig","Horse","Chicken"]),
  new Set(["Love","Hate","Envy","Pride","Anger","Joy","Sadness"]),
  new Set(["War","Peace","Crime","Justice","Law","Defeat","Victory"]),
  new Set(["Music","Sound","Rhythm","Dance"]),new Set(["Art","Poetry","Painting"]),
  new Set(["Morning","Night","Week","Month","Year","Century","Past","Present","Future","Eternity"]),
  new Set(["Hand","Foot","Eye","Ear","Nose","Mouth","Tooth","Hair","Skin","Muscle","Bone","Brain","Heart","Lung","Blood"]),
  new Set(["Knife","Fork","Spoon","Plate","Cup","Pan","Oven","Fridge","Microwave"]),
  new Set(["Bed","Pillow","Blanket"]),new Set(["Chair","Table","Curtain","Lamp"]),
  new Set(["Car","Bicycle","Train","Airplane","Ship","Subway"]),
  new Set(["Red","Blue","Green","Yellow","White","Black"]),
  new Set(["Big","Small","Long","Short"]),new Set(["Fast","Slow","Speed"]),
  new Set(["Hot","Cold","Heat","Frozen"]),new Set(["Sweet","Salty","Bitter","Spicy"]),
  new Set(["Dirty","Clean","Wet","Dry"]),new Set(["Strong","Weak","Hard","Soft","Smooth","Rough"]),
  new Set(["Rich","Poor","Debt","Money","Gold"]),new Set(["Zombie","Vampire","Ghost","Dragon","Mermaid"]),
  new Set(["Pirate","Viking","Ninja","Knight","Cowboy"]),new Set(["Detective","Spy","Police"]),
  new Set(["Singer","Dancer","Actor","Artist"]),
];


// ‚îÄ‚îÄ FOOTBALL WORDS (theme: football) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// Language-agnostic: same words used for both ES and EN since they are proper nouns
const FOOTBALL_WORDS = [
  // Competiciones
  "Champions League","Copa Libertadores","Premier League","La Liga","Serie A",
  "Bundesliga","Ligue 1","Copa del Rey","Mundial de F√∫tbol","Copa Am√©rica",
  "Eurocopa","MLS","Europa League","FA Cup","Copa Italia","Copa Alemania",
  "Community Shield","Copa Sudamericana","Recopa Sudamericana","Mundial de Clubes",
  "UEFA Nations League",
  // Clubes Europa
  "Real Madrid","FC Barcelona","Atletico de Madrid","Sevilla","Valencia","Athletic Bilbao",
  "Manchester City","Liverpool","Manchester United","Arsenal","Chelsea","Tottenham","Aston Villa",
  "Juventus","AC Milan","Inter de Milan","AS Roma","Napoli","Lazio","Fiorentina",
  "Bayern Munich","Borussia Dortmund","Bayer Leverkusen","RB Leipzig",
  "PSG","Olympique de Lyon","Olympique de Marsella",
  "Benfica","Porto","Sporting de Lisboa",
  "Ajax","PSV Eindhoven","Feyenoord",
  // Clubes Sudam√©rica
  "Boca Juniors","River Plate","Independiente","Racing Club","San Lorenzo",
  "Flamengo","Palmeiras","Corinthians","Sao Paulo","Gremio","Santos","Cruzeiro",
  "Pe√±arol","Nacional","Colo Colo","Universidad de Chile",
  "Atletico Nacional","Millonarios",
  // Clubes MLS
  "Inter Miami","LA Galaxy","New York City FC",
  // DTs
  "Pep Guardiola","Alex Ferguson","Carlo Ancelotti","Jose Mourinho","Jurgen Klopp",
  "Diego Simeone","Zinedine Zidane","Johan Cruyff","Rinus Michels","Vicente del Bosque",
  "Marcello Lippi","Arrigo Sacchi","Fabio Capello","Louis van Gaal","Arsene Wenger",
  "Ottmar Hitzfeld","Brian Clough","Jupp Heynckes","Lionel Scaloni","Marcelo Bielsa",
  "Carlos Bianchi","Luiz Felipe Scolari","Tele Santana","Carlos Bilardo","Cesar Luis Menotti",
  "Mario Zagallo","Giovanni Trapattoni","Guus Hiddink","Antonio Conte","Massimiliano Allegri",
  // Jugadores hist√≥ricos / cl√°sicos
  "Lionel Messi","Diego Maradona","Pel√©","Cristiano Ronaldo","Franz Beckenbauer",
  "Michel Platini","Gerd M√ºller","Eusebio","Marco van Basten","George Best",
  "Bobby Charlton","Garrincha","Zico","Romario","Roberto Baggio",
  "Paolo Maldini","Franco Baresi","Lev Yashin","Gianluigi Buffon","Iker Casillas",
  "Manuel Neuer","Sergio Ramos","Carles Puyol","Andres Iniesta","Xavi Hernandez",
  "Luka Modric","Toni Kroos","Karim Benzema","Thierry Henry","Wayne Rooney",
  "Luis Suarez","Neymar Jr","Kaka","Andrea Pirlo","Steven Gerrard",
  "Frank Lampard","Paul Scholes","David Beckham","Gabriel Batistuta","Hernan Crespo",
  "Juan Roman Riquelme","Javier Zanetti","Cafu","Roberto Carlos","Dani Alves",
  "Fabio Cannavaro","Alessandro Del Piero","Francesco Totti","Raul Gonzalez",
  "Oliver Kahn","Peter Schmeichel","Dino Zoff","Gordon Banks",
  "Ruud Gullit","Lothar Matth√§us","Dennis Bergkamp","Clarence Seedorf",
  "Hugo Sanchez","Mario Kempes","Daniel Passarella","Enzo Francescoli",
  "Carlos Valderrama","Hristo Stoichkov","Eric Cantona","Alan Shearer",
  "Ruud van Nistelrooy","Miroslav Klose","Filippo Inzaghi","David Villa","Fernando Torres",
  "Sergio Ag√ºero","Angel Di Maria",
  // Jugadores actuales
  "Kylian Mbapp√©","Erling Haaland","Robert Lewandowski","Zlatan Ibrahimovic",
  "Kevin De Bruyne","Mohamed Salah","Harry Kane","Vinicius Jr","Jude Bellingham",
  "Rodri","Antoine Griezmann","Lautaro Martinez","Alisson Becker","Thibaut Courtois",
  "Jan Oblak","Marcelo","Gerard Pique","Patrick Vieira","Claude Makelele",
  "Roy Keane","Pavel Nedved","George Weah","Michael Owen","Luis Figo","Rivaldo",
  "Shevchenko","Petr Cech","Rio Ferdinand","John Terry","Gary Neville","Ashley Cole",
  "Javier Mascherano","Radamel Falcao","James Rodriguez","Alexis Sanchez","Arturo Vidal",
  "Edinson Cavani","Diego Forlan","Virgil van Dijk","Joshua Kimmich"
];

// Football has no similar-word groups (all are proper nouns, all distinct)
const SIMILAR_FOOTBALL = [];

// ‚îÄ‚îÄ TRANSLATIONS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const T={
  en:{
    sub:"Online Cooperative Word Game",yourName:"Your Name",joinName:"Your Name",
    enterCode:"Room Code",timerToggle:"Enable timer",secs:"sec",
    soundOn:"Sound on",soundOff:"Sound off",
    createBtn:"Create Room",joinBtn:"Join Room",
    roomCode:"Room Code ‚Äî share with everyone",playersJoined:"Players in room",
    waitingText:"Waiting for players",startGame:"Start Game ‚Üí",
    gameMode:"Game Mode",modeCoop:"Cooperative",modeTeams:"Teams",
    gridSize:"Board Size",
    assignTeams:"Assign players to teams",numTeams:"Number of teams:",
    nowPlaying:"Now Playing",players:"Players",target:"Target",
    giveClue:"Your Clue",theClue:"The Clue",oneWord:"one word",
    guessInstruction:"Tap the grid cell that matches!",
    hintNote:"Give one word that hints at both!",
    giver:"Clue Giver",guesser:"Guesser",
    cluePlaceholder:"one word‚Ä¶",giveBtn:"Give Clue ‚Üí",
    log:"Log",quit:"Quit",newGame:"New",
    statMatched:"Matched",statRounds:"Rounds",
    playAgain:"Play Again",goHome:"Leave Room",
    playSameTeams:"‚ñ∂ Play Again ‚Äî same teams",
    playNewTeams:"üîÄ Play Again ‚Äî reassign teams",
    reassignTeams:"Reassign teams",

    wrongMsg:(c,r,col)=>`"${c}" was for ${r} √ó ${col}`,
    p1def:"Player 1",p2def:"Player 2",
    partnerThinking:n=>`${n} is giving a clue‚Ä¶`,
    waitingGuess:"Waiting for a guess‚Ä¶",
    roundLog:(n,c)=>`${n}: "${c}"`,
    correctLog:(c,r,col)=>`‚úì "${c}" ‚Üí ${r}√ó${col}`,
    wrongLog:(c,r,col)=>`‚úó "${c}" ‚Üí ${r}√ó${col}`,
    joinError:"Room not found. Check the code.",
    roomFull:"Room is full (max 10 players).",
    codedRoom:c=>`Room: ${c}`,copiedCode:"Room code copied!",
    needPlayers:"Need at least 2 players to start.",
    teamsNeedAll:"Each team needs at least 1 player.",
    youLabel:"you",
    team:n=>`Team ${n}`,wins:"wins",tieGame:"It's a tie!",
    sameTeamWatch:"Your team is giving ‚Äî watch!",
    otherTeamTurn:n=>`Team ${n} is giving‚Ä¶`,
    yourTeamGuess:"Your team: tap the right cell!",
    gameOverTitle:"Game Over!",
    gameOverSub:(r,c)=>`You missed: "${r}" √ó "${c}"`,
    tryAgain:"Try Again",analyzeBoard:"üîç Analyze the board",
    readyTitle:"New Game",readySub:"Someone wants to start a new game!",
    readyYou:"Ready ‚úì",readyWaiting:"Waiting‚Ä¶",readyLeft:"Left",
    joinReady:"‚ñ∂ Join new game",
    playSameConfig:"‚ñ∂ Same game again",playNewConfig:"‚öôÔ∏è New game (change settings)",
    noTimer:"Off",
    themeLbl:"Theme",themeClassic:"Classic",themeFootball:"Football",
    cancelConfig:"Cancel new config",
    congratsTitle:"Congratulations!",congratsSub:(n,total)=>`You matched ${n} of ${total} crosses!`,
  },
  es:{
    sub:"Juego cooperativo de palabras en l√≠nea",yourName:"Tu Nombre",joinName:"Tu Nombre",
    enterCode:"C√≥digo de Sala",timerToggle:"Activar temporizador",secs:"seg",
    soundOn:"Sonido activado",soundOff:"Sonido desactivado",
    createBtn:"Crear Sala",joinBtn:"Unirse",
    roomCode:"C√≥digo de Sala ‚Äî compart√≠ con todos",playersJoined:"Jugadores en la sala",
    waitingText:"Esperando jugadores",startGame:"Empezar Partida ‚Üí",
    gameMode:"Modo de Juego",modeCoop:"Cooperativo",modeTeams:"Equipos",
    gridSize:"Tama√±o del Tablero",
    assignTeams:"Asignar jugadores a equipos",numTeams:"N√∫mero de equipos:",
    nowPlaying:"Turno de",players:"Jugadores",target:"Objetivo",
    giveClue:"Tu Pista",theClue:"La Pista",oneWord:"una palabra",
    guessInstruction:"¬°Toc√° la celda que corresponde!",
    hintNote:"¬°Da una palabra que insin√∫e las dos!",
    giver:"Da la Pista",guesser:"Adivina",
    cluePlaceholder:"una palabra‚Ä¶",giveBtn:"Dar Pista ‚Üí",
    log:"Registro",quit:"Salir",newGame:"Nuevo",
    statMatched:"Adivinadas",statRounds:"Rondas",
    playAgain:"Nueva Partida",goHome:"Salir de la sala",
    playSameTeams:"‚ñ∂ Jugar de nuevo ‚Äî mismos equipos",
    playNewTeams:"üîÄ Jugar de nuevo ‚Äî reasignar equipos",
    reassignTeams:"Reasignar equipos",

    wrongMsg:(c,r,col)=>`"${c}" era para ${r} √ó ${col}`,
    p1def:"Jugador 1",p2def:"Jugador 2",
    partnerThinking:n=>`${n} est√° dando una pista‚Ä¶`,
    waitingGuess:"Esperando que alguien adivine‚Ä¶",
    roundLog:(n,c)=>`${n}: "${c}"`,
    correctLog:(c,r,col)=>`‚úì "${c}" ‚Üí ${r}√ó${col}`,
    wrongLog:(c,r,col)=>`‚úó "${c}" ‚Üí ${r}√ó${col}`,
    joinError:"Sala no encontrada. Verific√° el c√≥digo.",
    roomFull:"La sala est√° llena (m√°x. 10 jugadores).",
    codedRoom:c=>`Sala: ${c}`,copiedCode:"¬°C√≥digo copiado!",
    needPlayers:"Se necesitan al menos 2 jugadores.",
    teamsNeedAll:"Cada equipo necesita al menos 1 jugador.",
    youLabel:"vos",
    team:n=>`Equipo ${n}`,wins:"gana",tieGame:"¬°Empate!",
    sameTeamWatch:"Tu equipo da la pista ‚Äî ¬°mir√°!",
    otherTeamTurn:n=>`El Equipo ${n} da la pista‚Ä¶`,
    yourTeamGuess:"Tu equipo: ¬°toc√° la celda correcta!",
    gameOverTitle:"¬°Game Over!",
    gameOverSub:(r,c)=>`Erraron: "${r}" √ó "${c}"`,
    tryAgain:"Intentar de nuevo",analyzeBoard:"üîç Analizar el tablero",
    readyTitle:"Nueva Partida",readySub:"¬°Alguien quiere empezar una nueva partida!",
    readyYou:"Listo ‚úì",readyWaiting:"Esperando‚Ä¶",readyLeft:"Se fue",
    joinReady:"‚ñ∂ Unirme a la nueva partida",
    playSameConfig:"‚ñ∂ Misma partida de nuevo",playNewConfig:"‚öôÔ∏è Nueva partida (cambiar config)",
    noTimer:"Sin temporizador",
    themeLbl:"Tem√°tica",themeClassic:"Cl√°sica",themeFootball:"F√∫tbol",
    cancelConfig:"Cancelar nueva config",
    congratsTitle:"¬°Felicitaciones!",congratsSub:(n,total)=>`¬°Adivinaron ${n} de ${total} cruces!`,
  }
};

// ‚îÄ‚îÄ STATE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let lang='es', myPlayerId=null, myName='', isHost=false;
let roomId=null, roomRef=null, gstate=null;
let selectedMode='coop', selectedSize=4, selectedTheme='classic', numTeams=2, teamAssignments={};
let timerInterval=null, localTimerLeft=0;
let soundEnabled=true, gridZoom=1;
let pendingNewGameHow=null; // 'same'|'new'|null

const t=(k,...a)=>{const v=T[lang]?.[k];return typeof v==='function'?v(...a):(v??k);};

// ‚îÄ‚îÄ UTILS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function shuffle(arr){const a=[...arr];for(let i=a.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[a[i],a[j]]=[a[j],a[i]];}return a;}
function genCode(){const c='ABCDEFGHJKLMNPQRSTUVWXYZ23456789';return Array.from({length:6},()=>c[Math.floor(Math.random()*c.length)]).join('');}
function genPlayerId(){return Math.random().toString(36).slice(2)+Date.now().toString(36);}
function showToast(msg,dur=3000){const el=document.getElementById('toast');el.textContent=msg;el.classList.add('show');setTimeout(()=>el.classList.remove('show'),dur);}
function showScreen(id){document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active'));document.getElementById(id).classList.add('active');}
function deepCopy(obj){return JSON.parse(JSON.stringify(obj));}
function openModal(id){document.getElementById(id).classList.add('open');}
function closeModal(id){document.getElementById(id).classList.remove('open');}

// ‚îÄ‚îÄ SOUND ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function playSound(type){
  if(!soundEnabled) return;
  try{
    const ctx=new(window.AudioContext||window.webkitAudioContext)();
    const osc=ctx.createOscillator(),gain=ctx.createGain();
    osc.connect(gain);gain.connect(ctx.destination);
    if(type==='ping'){
      osc.type='sine';osc.frequency.setValueAtTime(880,ctx.currentTime);
      osc.frequency.exponentialRampToValueAtTime(660,ctx.currentTime+0.15);
      gain.gain.setValueAtTime(0.18,ctx.currentTime);
      gain.gain.exponentialRampToValueAtTime(0.001,ctx.currentTime+0.5);
      osc.start();osc.stop(ctx.currentTime+0.5);
    } else if(type==='correct'){
      osc.type='sine';osc.frequency.setValueAtTime(660,ctx.currentTime);
      osc.frequency.setValueAtTime(880,ctx.currentTime+0.1);
      gain.gain.setValueAtTime(0.15,ctx.currentTime);
      gain.gain.exponentialRampToValueAtTime(0.001,ctx.currentTime+0.4);
      osc.start();osc.stop(ctx.currentTime+0.4);
    } else if(type==='wrong'){
      osc.type='sawtooth';osc.frequency.setValueAtTime(220,ctx.currentTime);
      osc.frequency.setValueAtTime(150,ctx.currentTime+0.15);
      gain.gain.setValueAtTime(0.12,ctx.currentTime);
      gain.gain.exponentialRampToValueAtTime(0.001,ctx.currentTime+0.4);
      osc.start();osc.stop(ctx.currentTime+0.4);
    }
  }catch(e){}
}

window.toggleSound=()=>{
  soundEnabled=!soundEnabled;
  const icon=soundEnabled?'üîä':'üîá';
  const el1=document.getElementById('btn-sound-game');
  if(el1) el1.textContent=icon;
  showToast(soundEnabled?t('soundOn'):t('soundOff'));
};


// ‚îÄ‚îÄ ZOOM ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
window.zoomGrid=(dir)=>{
  gridZoom=Math.max(0.5,Math.min(2,gridZoom+dir*0.15));
  const wrap=document.getElementById('grid-wrap');
  if(wrap) wrap.style.transform=`scale(${gridZoom})`;
};

// ‚îÄ‚îÄ LANGUAGE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
window.setLang=(l)=>{
  lang=l;
  document.querySelectorAll('.lang-pill').forEach((b,i)=>b.classList.toggle('active',(i===0&&l==='en')||(i===1&&l==='es')));
  applyLobbyTrans();
};

// ‚îÄ‚îÄ HURRY SYSTEM ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
window.toggleHurryMenu=(e)=>{
  e.stopPropagation();
  const menu=document.getElementById('hurry-menu');
  menu.classList.toggle('open');
};
// Close menu when clicking outside
document.addEventListener('click',()=>{
  document.getElementById('hurry-menu')?.classList.remove('open');
});

window.sendHurry=async(msg)=>{
  document.getElementById('hurry-menu')?.classList.remove('open');
  if(!roomRef||!roomId) return;
  // Write hurry event to Firebase
  await update(ref(db,`rooms/${roomId}/hurry`),{
    msg, from:myName||'?', ts:Date.now()
  });
};

function playWhistle(){
  if(!soundEnabled) return;
  try{
    const ctx=new(window.AudioContext||window.webkitAudioContext)();
    // Short sharp whistle: rising then falling
    const osc=ctx.createOscillator();
    const gain=ctx.createGain();
    osc.connect(gain);gain.connect(ctx.destination);
    osc.type='sine';
    osc.frequency.setValueAtTime(1400,ctx.currentTime);
    osc.frequency.linearRampToValueAtTime(2000,ctx.currentTime+0.08);
    osc.frequency.linearRampToValueAtTime(1600,ctx.currentTime+0.18);
    osc.frequency.linearRampToValueAtTime(2200,ctx.currentTime+0.26);
    osc.frequency.linearRampToValueAtTime(1800,ctx.currentTime+0.36);
    gain.gain.setValueAtTime(0,ctx.currentTime);
    gain.gain.linearRampToValueAtTime(0.22,ctx.currentTime+0.03);
    gain.gain.setValueAtTime(0.22,ctx.currentTime+0.34);
    gain.gain.linearRampToValueAtTime(0,ctx.currentTime+0.4);
    osc.start();osc.stop(ctx.currentTime+0.4);
  }catch(e){}
}

function spawnReaction(msg){
  const container=document.getElementById('reaction-container');
  if(!container) return;
  const COUNT=6;
  for(let i=0;i<COUNT;i++){
    setTimeout(()=>{
      const el=document.createElement('div');
      el.className='reaction-bubble';
      el.textContent=msg;
      // Random horizontal spread, random rotation
      const x=10+Math.random()*80; // % from left
      const rot=(-15+Math.random()*30)+'deg';
      const scale=0.75+Math.random()*0.5;
      el.style.cssText=`left:${x}%;bottom:10%;--rot:${rot};font-size:${scale*2}rem;`;
      container.appendChild(el);
      el.addEventListener('animationend',()=>el.remove(),{once:true});
    }, i*120);
  }
}

// Listen for hurry events in listenRoom
let lastHurryTs=0;
function handleHurryUpdate(hurry){
  if(!hurry||hurry.ts<=lastHurryTs) return;
  lastHurryTs=hurry.ts;
  playWhistle();
  spawnReaction(hurry.msg);
}

// Pre-fill last used name
try{
  const saved=localStorage.getItem('cc_last_name');
  if(saved){
    const cn=document.getElementById('create-name');
    const jn=document.getElementById('join-name');
    if(cn) cn.value=saved;
    if(jn) jn.value=saved;
  }
}catch(e){}
applyLobbyTrans();
};
function applyLobbyTrans(){
  const ids={'lg-sub':'sub','lbl-your-name':'yourName','lbl-join-name':'joinName',
    'lbl-enter-code':'enterCode','lbl-timer-toggle':'timerToggle','lbl-secs':'secs',
    'btn-create':'createBtn','btn-join':'joinBtn','lbl-room-code':'roomCode',
    'lbl-players-joined':'playersJoined','waiting-text':'waitingText','start-game-btn':'startGame',
    'lbl-game-mode':'gameMode','lbl-mode-coop':'modeCoop','lbl-mode-teams':'modeTeams',
    'lbl-grid-size':'gridSize',
    'lbl-theme':'themeLbl','lbl-theme-classic':'themeClassic','lbl-theme-football':'themeFootball',
    'lbl-assign-teams':'assignTeams','lbl-num-teams':'numTeams'};
  Object.entries(ids).forEach(([id,k])=>{const el=document.getElementById(id);if(el)el.textContent=t(k);});
  const cn=document.getElementById('create-name');if(cn)cn.placeholder=t('p1def');
  const jn=document.getElementById('join-name');if(jn)jn.placeholder=t('p2def');
}
function applyGameTrans(){
  const ids={'lbl-now-playing':'nowPlaying','lbl-players':'players','lbl-target':'target',
    'lbl-give-clue':'giveClue','lbl-the-clue':'theClue','lbl-one-word':'oneWord',
    'guess-tip':'guessInstruction','lbl-log':'log','btn-quit':'quit','btn-new-game':'newGame'};
  Object.entries(ids).forEach(([id,k])=>{const el=document.getElementById(id);if(el)el.textContent=t(k);});
  const ci=document.getElementById('clue-input');if(ci)ci.placeholder=t('cluePlaceholder');
  const gb=document.getElementById('give-btn');if(gb)gb.textContent=t('giveBtn');
}
window.onTimerToggle=()=>{document.getElementById('timer-secs').disabled=!document.getElementById('timer-toggle').checked;};

// ‚îÄ‚îÄ MODE / SIZE / TEAMS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
window.selectMode=(mode)=>{
  selectedMode=mode;
  document.getElementById('mode-btn-coop').classList.toggle('active',mode==='coop');
  document.getElementById('mode-btn-teams').classList.toggle('active',mode==='teams');
};
window.selectSize=(g)=>{
  selectedSize=g;
  [3,4,5,6].forEach(n=>document.getElementById(`size-btn-${n}`)?.classList.toggle('active',n===g));
};
window.selectTheme=(th)=>{
  selectedTheme=th;
  document.getElementById('theme-btn-classic')?.classList.toggle('active',th==='classic');
  document.getElementById('theme-btn-football')?.classList.toggle('active',th==='football');
};
window.onNumTeamsChange=()=>{
  numTeams=parseInt(document.getElementById('num-teams-sel').value)||2;
  if(gstate) renderTeamAssign(gstate.players||[]);
};
function renderTeamAssign(players){
  const container=document.getElementById('team-assign-list');
  if(!container) return;
  container.innerHTML='';
  players.forEach(p=>{
    if(!teamAssignments[p.id]) teamAssignments[p.id]=1;
    teamAssignments[p.id]=Math.min(teamAssignments[p.id],numTeams);
    const row=document.createElement('div');row.className='team-assign-row';
    const nameEl=document.createElement('span');nameEl.className='team-assign-name';
    nameEl.textContent=p.id===myPlayerId?`${p.name} (${t('youLabel')})`:p.name;
    const sel=document.createElement('select');sel.className='team-sel';
    for(let n=1;n<=numTeams;n++){
      const opt=document.createElement('option');
      opt.value=n;opt.textContent=`${TEAM_COLORS[n].label} ${t('team',n)}`;
      sel.appendChild(opt);
    }
    sel.value=String(teamAssignments[p.id]);
    sel.onchange=()=>{teamAssignments[p.id]=parseInt(sel.value);};
    row.appendChild(nameEl);row.appendChild(sel);
    container.appendChild(row);
  });
}

// ‚îÄ‚îÄ CREATE ROOM ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
window.createRoom=async()=>{
  const name=document.getElementById('create-name').value.trim()||t('p1def');
  try{localStorage.setItem('cc_last_name',name);}catch(e){}
  const useTimer=document.getElementById('timer-toggle').checked;
  const timerSecs=parseInt(document.getElementById('timer-secs').value)||90;
  myPlayerId=genPlayerId();myName=name;isHost=true;roomId=genCode();
  roomRef=ref(db,`rooms/${roomId}`);
  await set(roomRef,{created:Date.now(),lang,useTimer,timerSecs,status:'lobby',
    hostId:myPlayerId,players:[{id:myPlayerId,name}],game:null,
    mode:selectedMode,numTeams,gridSize:selectedSize,theme:selectedTheme,readyMap:{}});
  document.getElementById('create-section').style.display='none';
  document.getElementById('or-div').style.display='none';
  document.getElementById('join-section').style.display='none';
  document.getElementById('waiting-section').style.display='';
  document.getElementById('room-code-value').textContent=roomId;
  listenRoom();
};

// ‚îÄ‚îÄ JOIN ROOM ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
window.joinRoom=async()=>{
  const name=document.getElementById('join-name').value.trim()||t('p2def');
  try{localStorage.setItem('cc_last_name',name);}catch(e){}
  const code=document.getElementById('join-code').value.trim().toUpperCase();
  if(!code||code.length<4){showJoinError(t('joinError'));return;}
  const snap=await get(ref(db,`rooms/${code}`));
  if(!snap.exists()){showJoinError(t('joinError'));return;}
  const data=snap.val();
  if((data.players||[]).length>=10){showJoinError(t('roomFull'));return;}
  myPlayerId=genPlayerId();myName=name;isHost=false;
  roomId=code;lang=data.lang||'es';
  document.querySelectorAll('.lang-pill').forEach((b,i)=>b.classList.toggle('active',(i===0&&lang==='en')||(i===1&&lang==='es')));
  roomRef=ref(db,`rooms/${roomId}`);
  await update(roomRef,{players:[...(data.players||[]),{id:myPlayerId,name}]});
  listenRoom();
  document.getElementById('create-section').style.display='none';
  document.getElementById('or-div').style.display='none';
  document.getElementById('join-section').style.display='none';
  document.getElementById('waiting-section').style.display='';
  document.getElementById('room-code-value').textContent=roomId;
  document.getElementById('start-game-btn').style.display='none';
  document.getElementById('teams-config').style.display='none';
};
function showJoinError(msg){const el=document.getElementById('join-status');el.textContent=msg;el.className='status-msg error';el.style.display='';}

// ‚îÄ‚îÄ LISTEN ROOM ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function listenRoom(){
  if(!roomRef) return;
  off(roomRef);
  onValue(roomRef,(snap)=>{
    if(!snap.exists()) return;
    const data=snap.val();
    const prevPhase=gstate?.game?.phase;
    const prevClue=gstate?.game?.currentClue||'';
    gstate=data;lang=data.lang||lang;
    const players=data.players||[];

    if(data.status==='lobby'){
      renderLobbyPlayers(players);
      if(isHost){
        document.getElementById('start-game-btn').disabled=players.length<2;
        if(players.length>=2){
          document.getElementById('teams-config').style.display=selectedMode==='teams'?'':'none';
          if(selectedMode==='teams') renderTeamAssign(players);
        }
      }
      return;
    }

    // Handle ready state (waiting for everyone to confirm new game)
    if(data.status==='ready'){
      closeModal('win-modal');
      renderReadyModal(data);
      return;
    }

    if(data.status==='playing'&&data.game){
      closeModal('ready-modal');
      closeModal('gameover-modal');
      applyGameTrans();showScreen('game');
      document.getElementById('hdr-room').textContent=roomId;
      renderGame(data);
      // Sound: when clue arrives for guessers
      if(data.game.phase==='guessing'&&(prevPhase!=='guessing'||prevClue!==data.game.currentClue)){
        const mode=data.game.mode||'coop';
        let isGiver=false;
        if(mode==='teams'&&data.game.teams){
          const at=data.game.currentTeam||1;
          const gi=(data.game.teams[at]?.giverIndex||0)%Math.max(data.game.teams[at]?.players?.length||1,1);
          isGiver=data.game.teams[at]?.players?.[gi]?.id===myPlayerId;
        } else {
          isGiver=(players[data.game.currentPlayerIndex??0])?.id===myPlayerId;
        }
        if(!isGiver) playSound('ping');
      }
      // Sound: when a cell is guessed/missed by anyone (correctFlashCell or wrongChosenCell just appeared)
      const prevWrong=gstate?.game?.wrongChosenCell;
      const prevCorrect=gstate?.game?.correctFlashCell;
      if(data.game.wrongChosenCell&&data.game.wrongChosenCell!==prevWrong){
        playSound('wrong');
      }
      if(data.game.guessed?.length>(gstate?.game?.guessed?.length||0)){
        // a correct guess happened
        const newlyGuessed=(data.game.guessed||[]).filter(k=>!(gstate?.game?.guessed||[]).includes(k));
        if(newlyGuessed.length>0) playSound('correct');
      }
    }
    if(data.status==='ended'&&data.game){renderWinModal(data);}
    if(data.status==='gameover'&&data.game){renderGameOverScreen(data);}
    if(data.hurry) handleHurryUpdate(data.hurry);
  });
}

// ‚îÄ‚îÄ LOBBY PLAYERS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderLobbyPlayers(players){
  const list=document.getElementById('lobby-players-list');
  if(!list) return;
  list.innerHTML='';
  players.forEach((p,i)=>{
    const chip=document.createElement('div');chip.className='player-chip';
    const dot=document.createElement('div');dot.className='player-chip-dot';
    dot.style.background=PLAYER_COLORS[i%PLAYER_COLORS.length];
    const nameEl=document.createElement('span');
    nameEl.textContent=p.id===myPlayerId?`${p.name} (${t('youLabel')})`:p.name;
    chip.appendChild(dot);chip.appendChild(nameEl);list.appendChild(chip);
  });
}

// ‚îÄ‚îÄ START GAME ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
window.hostStartGame=async()=>{
  if(!isHost||!roomRef) return;
  const snap=await get(roomRef);
  if(!snap.exists()) return;
  const data=snap.val();
  const players=data.players||[];
  if(players.length<2){showToast(t('needPlayers'));return;}
  const mode=selectedMode,nt=numTeams,gs=selectedSize,th=selectedTheme;
  if(mode==='teams'){
    for(let n=1;n<=nt;n++){
      if(!players.some(p=>(teamAssignments[p.id]||1)===n)){showToast(t('teamsNeedAll'));return;}
    }
  }
  const gameData=buildGameData(players,data.lang||lang,mode,teamAssignments,nt,gs,th);
  await update(roomRef,{status:'playing',mode,numTeams:nt,gridSize:gs,theme:th,game:gameData,readyMap:{}});
};

// ‚îÄ‚îÄ BUILD GAME ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function buildGameData(players,gameLang,mode,teamsMap,nt,gs,theme){
  const G=gs||5;const L=gameLang||lang;
  const th=theme||'classic';
  let pool,groups;
  if(th==='football'){
    pool=shuffle(FOOTBALL_WORDS);
    groups=SIMILAR_FOOTBALL;
  } else {
    pool=shuffle(WORDS[L]||WORDS.es);
    groups=L==='en'?SIMILAR_EN:SIMILAR_ES;
  }
  function pickWords(src,count){
    const picked=[];
    for(const w of src){if(picked.length>=count)break;if(!groups.some(g=>g.has(w)&&picked.some(p=>g.has(p))))picked.push(w);}
    for(const w of src){if(picked.length>=count)break;if(!picked.includes(w))picked.push(w);}
    return picked;
  }
  const rowWords=pickWords(pool,G);
  const colWords=pickWords(pool.filter(w=>!rowWords.includes(w)),G);
  const allCells=[];for(let r=0;r<G;r++)for(let c=0;c<G;c++)allCells.push(`${r},${c}`);
  const targetOrder=shuffle(allCells);
  let teams=null;const numT=nt||2;
  if(mode==='teams'&&teamsMap){
    teams={};
    for(let n=1;n<=numT;n++){
      const tp=players.filter(p=>(teamsMap[p.id]||1)===n);
      teams[n]={players:tp,score:0,giverIndex:Math.floor(Math.random()*Math.max(tp.length,1))};
    }
    const shuffledCells=shuffle([...allCells]);
    const cpt=Math.floor(allCells.length/numT);
    for(let n=1;n<=numT;n++) teams[n].assignedCells=shuffledCells.slice((n-1)*cpt,n*cpt);
  }
  return{
    rowWords,colWords,targetOrder,targetIndex:0,gridSize:G,
    mode:mode||'coop',teams,numTeams:numT,currentTeam:1,
    currentPlayerIndex:Math.floor(Math.random()*players.length),
    phase:'giving',currentClue:'',
    guessed:[],missed:[],guessedByTeam:{},rounds:0,log:[],timerStartedAt:null,
    wrongChosenCell:null,correctFlashCell:null,
  };
}

// ‚îÄ‚îÄ HELPERS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function getMyTeam(g){
  if(!g.teams) return null;
  const nt=g.numTeams||2;
  for(let n=1;n<=nt;n++){if((g.teams[n]?.players||[]).some(p=>p.id===myPlayerId))return n;}
  return null;
}
function currentTarget(g){
  const gs=new Set(g.guessed||[]);
  for(let i=g.targetIndex||0;i<(g.targetOrder||[]).length;i++){
    if(!gs.has(g.targetOrder[i]))return g.targetOrder[i];
  }
  return null;
}

// ‚îÄ‚îÄ RENDER GAME ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderGame(data){
  const g=data.game;const players=data.players||[];
  const mode=g.mode||'coop';
  const guessedSet=new Set(g.guessed||[]);
  const missedSet=new Set(g.missed||[]);
  let giverPlayer,amGiver,amGuesser,activeTeamN;
  if(mode==='teams'&&g.teams){
    activeTeamN=g.currentTeam||1;
    const td=g.teams[activeTeamN];
    const gi=(td?.giverIndex||0)%Math.max(td?.players?.length||1,1);
    giverPlayer=td?.players?.[gi];
    amGiver=giverPlayer?.id===myPlayerId;
    const myTeam=getMyTeam(g);
    amGuesser=myTeam!==null&&myTeam!==activeTeamN;
  } else {
    const idx=g.currentPlayerIndex??0;
    giverPlayer=players[idx]||players[0];
    amGiver=giverPlayer?.id===myPlayerId;
    amGuesser=!amGiver;
  }
  const G=g.gridSize||g.rowWords?.length||5;
  document.getElementById('hdr-score').textContent=`${guessedSet.size}/${G*G}`;
  // Teams score bar
  const bar=document.getElementById('teams-score-bar');
  if(mode==='teams'&&g.teams){
    bar.style.display='';bar.innerHTML='';
    for(let n=1;n<=(g.numTeams||2);n++){
      const td=g.teams[n];const tc=TEAM_COLORS[n];
      const chip=document.createElement('div');
      chip.className='team-score-chip'+(n===activeTeamN?' active-team':'');
      chip.style.cssText=`background:${tc.bg};border-color:${tc.hex};color:${tc.hex}`;
      chip.innerHTML=`<div class="team-score-n">${td?.score||0}</div><div class="team-score-label">${tc.label} ${t('team',n)}${n===activeTeamN?' üéØ':''}</div>`;
      bar.appendChild(chip);
    }
  } else {bar.style.display='none';}
  // Timer
  if(data.useTimer){
    document.getElementById('hdr-timer').style.display='';
    if(g.timerStartedAt) startLocalTimer(data.timerSecs,g.timerStartedAt); else stopLocalTimer();
  } else {document.getElementById('hdr-timer').style.display='none';stopLocalTimer();}
  renderPlayersStrip(players,giverPlayer,mode,g.teams,g.numTeams,activeTeamN);
  const giverColor=mode==='teams'?TEAM_COLORS[activeTeamN||1].hex:PLAYER_COLORS[(g.currentPlayerIndex??0)%PLAYER_COLORS.length];
  document.getElementById('p-avatar').textContent=(giverPlayer?.name||'?').charAt(0).toUpperCase();
  document.getElementById('p-avatar').style.background=giverColor;
  document.getElementById('p-avatar').style.color='#fff';
  document.getElementById('p-name-display').textContent=giverPlayer?.name||'‚Äî';
  document.getElementById('p-role-display').textContent=t('giver');
  ['giver-block','clue-input-block','guesser-block','waiting-block'].forEach(id=>document.getElementById(id).style.display='none');
  if(g.phase==='giving'){
    if(amGiver){
      document.getElementById('giver-block').style.display='';
      document.getElementById('clue-input-block').style.display='';
      document.getElementById('clue-input').disabled=false;
      document.getElementById('give-btn').disabled=false;
      document.getElementById('clue-input').value='';
      setTimeout(()=>document.getElementById('clue-input').focus(),100);
      const tgt=currentTarget(g);
      if(tgt){
        const [tr,tc]=tgt.split(',').map(Number);
        document.getElementById('tc-coord').textContent=`${String.fromCharCode(65+tr)}${tc+1}`;
        document.getElementById('tc-pair').innerHTML=`<span class="tw tw-row">${g.rowWords[tr]}</span><span class="tw-sep">√ó</span><span class="tw tw-col">${g.colWords[tc]}</span>`;
        document.getElementById('tc-hint').textContent=t('hintNote');
        highlightTarget(tgt);
      }
    } else {
      document.getElementById('waiting-block').style.display='';
      const msg=mode==='teams'?(amGuesser?t('otherTeamTurn',activeTeamN):t('sameTeamWatch')):t('partnerThinking',giverPlayer?.name||'?');
      document.getElementById('waiting-note-text').textContent=msg;
    }
  } else {
    document.getElementById('revealed-clue').textContent=g.currentClue||'‚Äî';
    if(amGuesser){
      document.getElementById('guesser-block').style.display='';
      if(mode==='teams') document.getElementById('guess-tip').textContent=t('yourTeamGuess');
    } else {
      document.getElementById('guesser-block').style.display='';
      document.getElementById('waiting-block').style.display='';
      document.getElementById('waiting-note-text').textContent=t('waitingGuess');
    }
  }
  buildGrid(g,guessedSet,missedSet,g.phase,amGuesser);
  renderLog(g.log||[]);
}

function renderPlayersStrip(players,giverPlayer,mode,teams,numT,activeTeamN){
  const strip=document.getElementById('players-strip');strip.innerHTML='';
  if(mode==='teams'&&teams){
    for(let n=1;n<=(numT||2);n++){
      const tc=TEAM_COLORS[n];
      const col=document.createElement('div');col.className='team-col';
      const hdr=document.createElement('div');hdr.className='team-col-hdr';
      hdr.style.color=tc.hex;hdr.textContent=`${tc.label} ${t('team',n)}${n===activeTeamN?' üéØ':''}`;
      col.appendChild(hdr);
      (teams[n]?.players||[]).forEach(p=>{
        const pill=document.createElement('div');
        pill.className='player-pill'+(p.id===myPlayerId?' is-me':'')+(p.id===giverPlayer?.id?' active-player':'');
        pill.style.borderColor=n===activeTeamN?tc.hex:'transparent';
        const dot=document.createElement('div');dot.className='pill-dot';dot.style.background=tc.hex;
        const nm=document.createElement('span');nm.textContent=p.id===myPlayerId?`${p.name}(${t('youLabel')})`:p.name;
        pill.appendChild(dot);pill.appendChild(nm);
        if(p.id===giverPlayer?.id){const r=document.createElement('span');r.className='pill-role';r.textContent=t('giver');pill.appendChild(r);}
        col.appendChild(pill);
      });
      strip.appendChild(col);
    }
  } else {
    players.forEach((p,i)=>{
      const pill=document.createElement('div');
      pill.className='player-pill'+(p.id===giverPlayer?.id?' active-player':'')+(p.id===myPlayerId?' is-me':'');
      const dot=document.createElement('div');dot.className='pill-dot';dot.style.background=PLAYER_COLORS[i%PLAYER_COLORS.length];
      const nm=document.createElement('span');nm.textContent=p.id===myPlayerId?`${p.name} (${t('youLabel')})`:p.name;
      pill.appendChild(dot);pill.appendChild(nm);
      if(p.id===giverPlayer?.id){const r=document.createElement('span');r.className='pill-role';r.textContent=t('giver');pill.appendChild(r);}
      strip.appendChild(pill);
    });
  }
}

// ‚îÄ‚îÄ GRID ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function buildGrid(g,guessedSet,missedSet,phase,amGuesser){
  const wrongChosen=g.wrongChosenCell||null;
  const correctFlash=g.correctFlashCell||null;
  const G=g.gridSize||g.rowWords?.length||5;
  const CELL=Math.max(44,72-Math.max(0,(G-4)*8));
  const HDR=Math.max(60,92-Math.max(0,(G-4)*8));
  const wrap=document.getElementById('grid-wrap');
  const needsRebuild=!wrap.querySelector('.col-headers')||
    wrap.dataset.rw!=(g.rowWords||[]).join(',')||wrap.dataset.cw!=(g.colWords||[]).join(',');
  if(needsRebuild){
    wrap.innerHTML='';wrap.dataset.rw=(g.rowWords||[]).join(',');wrap.dataset.cw=(g.colWords||[]).join(',');
    const ch=document.createElement('div');ch.className='col-headers';
    ch.style.marginLeft=`${HDR}px`;
    for(let c=0;c<G;c++){
      const d=document.createElement('div');d.className='col-hdr';
      d.style.width=`${CELL}px`;d.textContent=g.colWords[c];ch.appendChild(d);
    }
    wrap.appendChild(ch);
    for(let r=0;r<G;r++){
      const row=document.createElement('div');row.className='grid-row-wrap';
      const rh=document.createElement('div');rh.className='row-hdr';rh.style.width=`${HDR}px`;rh.textContent=g.rowWords[r];row.appendChild(rh);
      for(let c=0;c<G;c++){
        const cell=document.createElement('div');cell.className='cell';cell.id=`cell-${r}-${c}`;
        cell.style.width=`${CELL}px`;cell.style.height=`${CELL}px`;
        row.appendChild(cell);
      }
      wrap.appendChild(row);
    }
  }
  const gbt=g.guessedByTeam||{};
  for(let r=0;r<G;r++){
    for(let c=0;c<G;c++){
      const key=`${r},${c}`;
      const oldCell=document.getElementById(`cell-${r}-${c}`);
      if(!oldCell) continue;
      const wasGuessed=oldCell.classList.contains('guessed')||[1,2,3,4].some(n=>oldCell.classList.contains(`guessed-t${n}`));
      const wasMissed=oldCell.classList.contains('missed');
      const isGuessed=guessedSet.has(key);
      const isMissed=missedSet.has(key);
      const teamN=gbt[key]?parseInt(gbt[key]):null;
      // Replace cell to reset listeners
      const fresh=oldCell.cloneNode(false);
      oldCell.parentNode.replaceChild(fresh,oldCell);
      const el=document.getElementById(`cell-${r}-${c}`);
      el.className='cell';
      if(isGuessed){
        const cls=teamN?`guessed-t${teamN}`:'guessed';
        el.classList.add(cls,'disabled');
        const color=teamN?TEAM_COLORS[teamN].hex:'var(--success)';
        el.innerHTML=`<div class="cell-check" style="color:${color}">‚úì</div>${teamN?`<div class="cell-team-label" style="color:${color}">${TEAM_COLORS[teamN].label}</div>`:''}`;
        if(!wasGuessed){el.classList.add('guessed-pop');el.addEventListener('animationend',()=>el.classList.remove('guessed-pop'),{once:true});}
      } else if(isMissed){
        el.classList.add('missed','disabled');
        el.innerHTML=`<div class="cell-miss-icon">‚úï</div><div class="cell-coord">${String.fromCharCode(65+r)}${c+1}</div>`;
        if(!wasMissed){el.classList.add('missed-pop');el.addEventListener('animationend',()=>el.classList.remove('missed-pop'),{once:true});}
      } else if(key===correctFlash){
        // RED with TICK ‚Äî this is what they should have picked
        el.classList.add('correct-flash','disabled');
        el.innerHTML=`<div class="cell-correct-tick">‚úì</div><div class="cell-coord">${String.fromCharCode(65+r)}${c+1}</div>`;
      } else if(key===wrongChosen){
        // ORANGE with X ‚Äî this is what the player actually picked
        el.classList.add('wrong-chosen','disabled');
        el.innerHTML=`<div class="cell-miss-icon">‚úï</div><div class="cell-coord">${String.fromCharCode(65+r)}${c+1}</div>`;
      } else {
        el.innerHTML=`<div class="cell-coord">${String.fromCharCode(65+r)}${c+1}</div>`;
        if(phase==='guessing'&&amGuesser){
          el.addEventListener('click',()=>onCellClick(r,c));
        } else {
          el.classList.add('disabled');
        }
      }
    }
  }
}

function highlightTarget(key){
  document.querySelectorAll('.cell').forEach(c=>c.classList.remove('active-target'));
  const[r,c]=key.split(',');
  const el=document.getElementById(`cell-${r}-${c}`);
  if(el) el.classList.add('active-target');
}
function renderLog(entries){
  const scroll=document.getElementById('log-scroll');scroll.innerHTML='';
  [...entries].reverse().forEach(e=>{
    const div=document.createElement('div');div.className='log-entry';
    div.innerHTML=`<span>${e.icon}</span><span>${e.text}</span>`;
    scroll.appendChild(div);
  });
}

// ‚îÄ‚îÄ CELL CLICK ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
window.onCellClick=async(r,c)=>{
  if(!gstate?.game) return;
  const g=gstate.game;const players=gstate.players||[];
  const mode=g.mode||'coop';
  if(g.phase!=='guessing') return;
  if(mode==='teams'&&g.teams){
    const myTeam=getMyTeam(g);
    if(myTeam===null||myTeam===(g.currentTeam||1)) return;
  } else {
    if((players[g.currentPlayerIndex??0])?.id===myPlayerId) return;
  }
  const guessedSet=new Set(g.guessed||[]);
  if(guessedSet.has(`${r},${c}`)) return;
  const tgt=currentTarget(g);
  if(!tgt) return;
  const[tr,tc]=tgt.split(',').map(Number);
  const correct=tgt===`${r},${c}`;
  let newGuessed=[...(g.guessed||[])];
  let newMissed=[...(g.missed||[])];
  let newLog=[...(g.log||[])];
  let newTargetIndex=g.targetIndex||0;
  let newGbt={...(g.guessedByTeam||{})};
  const myTeamN=mode==='teams'?getMyTeam(g):null;
  const G=g.gridSize||g.rowWords?.length||5;

  if(correct){
    playSound('correct');
    newGuessed.push(`${r},${c}`);newTargetIndex++;
    if(mode==='teams'&&g.teams){
      let ownerTeam=null;
      for(let n=1;n<=(g.numTeams||2);n++){
        if((g.teams[n]?.assignedCells||[]).includes(`${r},${c}`)){ownerTeam=n;break;}
      }
      newGbt[`${r},${c}`]=ownerTeam||myTeamN||1;
    }
    newLog.push({icon:'‚úÖ',text:t('correctLog',g.currentClue,g.rowWords[tr],g.colWords[tc])});
    if(newGuessed.length>=G*G){
      const wu={guessed:newGuessed,guessedByTeam:newGbt,targetIndex:newTargetIndex,
        log:newLog,phase:'giving',currentClue:'',timerStartedAt:null};
      if(mode==='teams'&&g.teams){
        const newTeams=deepCopy(g.teams);
        for(const[,tn]of Object.entries(newGbt)) if(newTeams[tn]) newTeams[tn].score=(newTeams[tn].score||0)+1;
        wu.teams=newTeams;
      }
      await update(ref(db,`rooms/${roomId}/game`),wu);
      await update(roomRef,{status:'ended'});
      return;
    }
    const upd=advanceTurn(g,players,newGuessed,newMissed,newLog,newTargetIndex,newGbt,correct,tr,tc);
    await update(ref(db,`rooms/${roomId}/game`),upd);
  } else {
    playSound('wrong');
    const wrongKey=`${r},${c}`;const correctKey=`${tr},${tc}`;
    newLog.push({icon:'‚ùå',text:t('wrongLog',g.currentClue,g.rowWords[tr],g.colWords[tc])});
    showToast(t('wrongMsg',g.currentClue,g.rowWords[tr],g.colWords[tc]));
    if(mode==='coop'){
      stopLocalTimer();
      const missedKey=`${tr},${tc}`;
      if(!newMissed.includes(missedKey)) newMissed.push(missedKey);
      newTargetIndex++;newLog.push({icon:'üí•',text:'GAME OVER'});
      await update(ref(db,`rooms/${roomId}/game`),{
        guessed:newGuessed,missed:newMissed,targetIndex:newTargetIndex,
        log:newLog,phase:'giving',currentClue:'',timerStartedAt:null,
        gameOverCell:`${tr},${tc}`,gameOverClue:g.currentClue,
        gameOverRow:g.rowWords[tr],gameOverCol:g.colWords[tc],
        wrongChosenCell:wrongKey,correctFlashCell:correctKey,
      });
      setTimeout(async()=>{ await update(roomRef,{status:'gameover'}); },4000);
      return;
    }
    newTargetIndex++;
    const missedKey=`${tr},${tc}`;
    if(!newMissed.includes(missedKey)) newMissed.push(missedKey);
    stopLocalTimer();
    const upd=advanceTurn(g,players,newGuessed,newMissed,newLog,newTargetIndex,newGbt,correct,tr,tc);
    upd.wrongChosenCell=wrongKey;upd.correctFlashCell=correctKey;
    await update(ref(db,`rooms/${roomId}/game`),upd);
  }
};

function advanceTurn(g,players,newGuessed,newMissed,newLog,newTargetIndex,newGbt,correct,tr,tc){
  const mode=g.mode||'coop';
  const upd={
    guessed:newGuessed,missed:newMissed,guessedByTeam:newGbt,
    targetIndex:newTargetIndex,log:newLog,
    phase:'giving',currentClue:'',timerStartedAt:null,
    rounds:(g.rounds||0)+1,
    wrongChosenCell:null,correctFlashCell:null,
  };
  if(mode==='teams'&&g.teams){
    const at=g.currentTeam||1;const nt=g.numTeams||2;
    const nextTeam=at>=nt?1:at+1;
    const newTeams=deepCopy(g.teams);
    newTeams[at].giverIndex=((newTeams[at].giverIndex||0)+1)%Math.max(newTeams[at].players.length,1);
    for(let n=1;n<=nt;n++) newTeams[n].score=0;
    for(const[,tn]of Object.entries(newGbt)) if(newTeams[tn]) newTeams[tn].score=(newTeams[tn].score||0)+1;
    upd.currentTeam=nextTeam;upd.teams=newTeams;
  } else {
    upd.currentPlayerIndex=((g.currentPlayerIndex??0)+1)%Math.max(players.length,1);
  }
  return upd;
}

// ‚îÄ‚îÄ SUBMIT CLUE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
window.submitClue=async()=>{
  const clue=document.getElementById('clue-input').value.trim().toUpperCase();
  if(!clue||!gstate?.game) return;
  const g=gstate.game;const players=gstate.players||[];
  const mode=g.mode||'coop';
  if(g.phase!=='giving') return;
  if(mode==='teams'&&g.teams){
    const at=g.currentTeam||1;
    const gi=(g.teams[at]?.giverIndex||0)%Math.max(g.teams[at]?.players?.length||1,1);
    if(g.teams[at]?.players?.[gi]?.id!==myPlayerId) return;
  } else {
    if(players[g.currentPlayerIndex??0]?.id!==myPlayerId) return;
  }
  document.getElementById('give-btn').disabled=true;
  document.getElementById('clue-input').disabled=true;
  const newLog=[...(g.log||[]),{icon:'üó£Ô∏è',text:t('roundLog',myName,clue)}];
  await update(ref(db,`rooms/${roomId}/game`),{
    phase:'guessing',currentClue:clue,log:newLog,
    timerStartedAt:gstate.useTimer?Date.now():null,
  });
};

// ‚îÄ‚îÄ TIMER ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function startLocalTimer(totalSecs,startedAt){
  stopLocalTimer();
  localTimerLeft=Math.max(0,totalSecs-Math.floor((Date.now()-startedAt)/1000));
  renderTimerDisplay();
  timerInterval=setInterval(async()=>{
    localTimerLeft--;renderTimerDisplay();
    if(localTimerLeft<=0){stopLocalTimer();await handleTimerExpiry();}
  },1000);
}
function stopLocalTimer(){clearInterval(timerInterval);timerInterval=null;}
function renderTimerDisplay(){
  const el=document.getElementById('hdr-timer');
  const m=Math.floor(localTimerLeft/60),s=localTimerLeft%60;
  el.textContent=`${m}:${s.toString().padStart(2,'0')}`;
  el.classList.toggle('urgent',localTimerLeft<=10);
}
async function handleTimerExpiry(){
  if(!gstate?.game) return;
  const g=gstate.game;const players=gstate.players||[];const mode=g.mode||'coop';
  let isMyResp=false;
  if(mode==='teams'&&g.teams){
    const at=g.currentTeam||1;
    const gi=(g.teams[at]?.giverIndex||0)%Math.max(g.teams[at]?.players?.length||1,1);
    const giver=g.teams[at]?.players?.[gi];
    const myTeam=getMyTeam(g);
    isMyResp=(g.phase==='giving'&&giver?.id===myPlayerId)||(g.phase==='guessing'&&myTeam!==at);
  } else {
    const giver=players[g.currentPlayerIndex??0];
    isMyResp=(g.phase==='giving'&&giver?.id===myPlayerId)||(g.phase==='guessing'&&giver?.id!==myPlayerId);
  }
  if(!isMyResp) return;
  const newLog=[...(g.log||[]),{icon:'‚è±Ô∏è',text:'Time expired'}];
  const upd=advanceTurn(g,players,g.guessed||[],g.missed||[],newLog,
    (g.targetIndex||0)+(g.phase==='guessing'?1:0),g.guessedByTeam||{},false,0,0);
  upd.phase='giving';upd.currentClue='';upd.timerStartedAt=null;
  await update(ref(db,`rooms/${roomId}/game`),upd);
}

// ‚îÄ‚îÄ GAME OVER ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderGameOverScreen(data){
  stopLocalTimer();
  const g=data.game;
  document.getElementById('go-title').textContent=t('gameOverTitle');
  document.getElementById('go-sub').textContent=t('gameOverSub',g.gameOverRow||'?',g.gameOverCol||'?');
  document.getElementById('btn-go-again').textContent=t('tryAgain');
  document.getElementById('btn-go-analyze').textContent=t('analyzeBoard');
  document.getElementById('btn-go-home2').textContent=t('goHome');
  showScreen('game');
  // Render frozen board
  const guessedSet=new Set(g.guessed||[]);
  const missedSet=new Set(g.missed||[]);
  buildGrid(g,guessedSet,missedSet,'giving',false);
  renderLog(g.log||[]);
  openModal('gameover-modal');
}
window.closeGameOverModal=()=>{ closeModal('gameover-modal'); };

// ‚îÄ‚îÄ WIN MODAL ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// State for host new-game config inside win modal
let cfgMode='coop', cfgSize=4, cfgTheme='classic', cfgTimerEnabled=false, cfgTimerSecs=90;

window.toggleHostConfig=(btn)=>{
  const cfg=document.getElementById('host-config');
  const confirm=document.getElementById('win-cfg-confirm');
  const isOpen=cfg.style.display!=='none';
  cfg.style.display=isOpen?'none':'';
  confirm.style.display=isOpen?'none':'';
  btn.textContent=isOpen?t('playNewConfig'):'‚úï ' + t('cancelConfig');
};
window.setCfgTheme=(th)=>{
  cfgTheme=th;
  document.getElementById('cfg-theme-classic')?.classList.toggle('active',th==='classic');
  document.getElementById('cfg-theme-football')?.classList.toggle('active',th==='football');
};
window.setCfgMode=(m)=>{
  cfgMode=m;
  document.getElementById('cfg-mode-coop').classList.toggle('active',m==='coop');
  document.getElementById('cfg-mode-teams').classList.toggle('active',m==='teams');
};
window.setCfgSize=(s)=>{
  cfgSize=s;
  [3,4,5,6].forEach(n=>document.getElementById(`cfg-size-${n}`)?.classList.toggle('active',n===s));
};
window.onCfgTimerToggle=()=>{
  cfgTimerEnabled=document.getElementById('cfg-timer-toggle').checked;
  document.getElementById('cfg-timer-secs').disabled=!cfgTimerEnabled;
};

function renderWinModal(data){
  stopLocalTimer();
  const g=data.game;const players=data.players||[];
  const mode=g.mode||'coop';const n=(g.guessed||[]).length;
  const G=g.gridSize||g.rowWords?.length||5;

  // Set defaults for host config from current game
  cfgMode=mode; cfgSize=G; cfgTheme=data.theme||'classic';
  cfgTimerEnabled=data.useTimer||false; cfgTimerSecs=data.timerSecs||90;

  // Title + sub
  const teamsBox=document.getElementById('win-teams-scores');
  if(mode==='teams'&&g.teams){
    const nt=g.numTeams||2;let maxScore=0;
    for(let nn=1;nn<=nt;nn++) maxScore=Math.max(maxScore,g.teams[nn]?.score||0);
    const scores=[];
    for(let nn=1;nn<=nt;nn++) scores.push({n:nn,score:g.teams[nn]?.score||0});
    scores.sort((a,b)=>b.score-a.score);
    teamsBox.style.display='';teamsBox.innerHTML='';
    scores.forEach(({n:nn,score})=>{
      const tc=TEAM_COLORS[nn];
      const box=document.createElement('div');box.className='win-team-box'+(score===maxScore?' winner':'');
      box.style.cssText=`background:${tc.bg};border-color:${tc.hex};color:${tc.hex}`;
      box.innerHTML=`<div class="win-team-score">${score}</div><div class="win-team-label">${tc.label} ${t('team',nn)}</div>`;
      teamsBox.appendChild(box);
    });
    const winners=scores.filter(s=>s.score===maxScore);
    document.getElementById('win-title').textContent=winners.length===1?`${TEAM_COLORS[winners[0].n].label} ${t('team',winners[0].n)} ${t('wins')}!`:t('tieGame');
    document.getElementById('win-sub').textContent='';
  } else {
    teamsBox.style.display='none';
    document.getElementById('win-title').textContent=t('congratsTitle');
    document.getElementById('win-sub').textContent=t('congratsSub',n,G*G);
  }

  // Player chips
  const playersEl=document.getElementById('win-players');playersEl.innerHTML='';
  players.forEach((p,i)=>{
    const chip=document.createElement('div');chip.className='win-player-chip';
    const clr=PLAYER_COLORS[i%PLAYER_COLORS.length];
    chip.style.cssText=`background:${clr}18;border-color:${clr};color:${clr}`;
    chip.innerHTML=`<span style="width:7px;height:7px;border-radius:50%;background:${clr};display:inline-block;flex-shrink:0"></span>${p.name}`;
    playersEl.appendChild(chip);
  });

  // Game info row
  const modeLabel=mode==='coop'?t('modeCoop'):t('modeTeams');
  const timerLabel=data.useTimer?`${data.timerSecs}s`:t('noTimer');
  const infoEl=document.getElementById('win-info');infoEl.innerHTML='';
  const themeLabel=(data.theme||'classic')==='football'?t('themeFootball'):t('themeClassic');
  const rows=[
    ['üéÆ',t('gameMode'),modeLabel],
    ['üåç',t('themeLbl'),themeLabel],
    ['‚äû',t('gridSize'),`${G}√ó${G}`],
    ['‚è±',t('timerToggle'),timerLabel],
    ['üéØ',t('statMatched'),`${n} / ${G*G}`],
  ];
  rows.forEach(([icon,lbl,val])=>{
    const row=document.createElement('div');row.className='win-info-row';
    row.innerHTML=`<span>${icon}</span><span>${lbl}</span><span class="win-info-val" style="margin-left:auto">${val}</span>`;
    infoEl.appendChild(row);
  });

  // Host config block - always hidden initially, shown on button click
  const hostCfg=document.getElementById('host-config');
  const winCfgConfirm=document.getElementById('win-cfg-confirm');
  if(winCfgConfirm) winCfgConfirm.style.display='none';
  if(isHost){
    hostCfg.style.display='none'; // starts hidden
    // Pre-sync cfg buttons so they're ready when opened
    setCfgMode(cfgMode); setCfgSize(cfgSize); setCfgTheme(cfgTheme);
    const tt=document.getElementById('cfg-timer-toggle');
    if(tt){ tt.checked=cfgTimerEnabled; document.getElementById('cfg-timer-secs').disabled=!cfgTimerEnabled; document.getElementById('cfg-timer-secs').value=cfgTimerSecs; }
  } else {
    hostCfg.style.display='none';
  }

  // Buttons
  const btns=document.getElementById('win-btns');btns.innerHTML='';
  if(isHost){
    const b1=document.createElement('button');b1.className='btn-again';
    b1.textContent=t('playSameConfig');
    b1.onclick=()=>requestNewGame('same');
    const b2=document.createElement('button');b2.className='btn-secondary';
    b2.textContent=t('playNewConfig');
    b2.onclick=()=>toggleHostConfig(b2);
    const b3=document.createElement('button');b3.className='btn-home';
    b3.textContent=t('goHome');b3.onclick=()=>goHome();
    btns.appendChild(b1);btns.appendChild(b2);btns.appendChild(b3);
  } else {
    const b1=document.createElement('button');b1.className='btn-again';
    b1.textContent=t('playSameConfig');
    b1.onclick=()=>requestNewGame('same');
    const b3=document.createElement('button');b3.className='btn-home';
    b3.textContent=t('goHome');b3.onclick=()=>goHome();
    btns.appendChild(b1);btns.appendChild(b3);
  }

  // Show modal over game board
  showScreen('game');
  openModal('win-modal');
}

// ‚îÄ‚îÄ READY SYSTEM (new game confirmation) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// readyMap: { playerId: 'ready'|'left' }
window.requestNewGame=async(how)=>{
  if(!roomRef||!gstate) return;
  pendingNewGameHow=how||null;
  closeModal('gameover-modal');closeModal('win-modal');
  // Mark me as ready in Firebase
  await update(ref(db,`rooms/${roomId}/readyMap`),{[myPlayerId]:'ready'});
  // Check if everyone is ready or left
  await checkAllReady();
};
// Join the pending new game (for players who see the ready modal)
window.joinReady=async()=>{
  if(!roomRef||!gstate) return;
  await update(ref(db,`rooms/${roomId}/readyMap`),{[myPlayerId]:'ready'});
  await checkAllReady();
};
// Leave from ready modal
window.leaveFromReady=async()=>{
  leaveRoom();
};

async function checkAllReady(){
  if(!roomRef||!gstate) return;
  const snap=await get(roomRef);
  if(!snap.exists()) return;
  const data=snap.val();
  const players=data.players||[];
  const readyMap=data.readyMap||{};
  const allDone=players.every(p=>readyMap[p.id]==='ready'||readyMap[p.id]==='left');
  if(allDone&&players.some(p=>readyMap[p.id]==='ready')){
    // Everyone decided ‚Äî start game
    await doStartNewGame(data);
  } else {
    // Show the ready modal
    renderReadyModal(data);
    // Set status=ready so everyone sees the modal
    if(data.status!=='ready') await update(roomRef,{status:'ready'});
  }
}

function renderReadyModal(data){
  const players=data.players||[];
  const readyMap=data.readyMap||{};
  document.getElementById('ready-title').textContent=t('readyTitle');
  document.getElementById('ready-sub').textContent=t('readySub');
  const list=document.getElementById('ready-list');list.innerHTML='';
  players.forEach((p,i)=>{
    const status=readyMap[p.id];
    const row=document.createElement('div');row.className='ready-row';
    const dot=document.createElement('div');
    dot.style.cssText=`width:8px;height:8px;border-radius:50%;background:${PLAYER_COLORS[i%PLAYER_COLORS.length]};flex-shrink:0`;
    const name=document.createElement('span');
    name.textContent=(p.id===myPlayerId?`${p.name} (${t('youLabel')})`:p.name);
    const lbl=document.createElement('span');
    lbl.style.marginLeft='auto';lbl.style.fontWeight='600';lbl.style.fontSize='.78rem';
    if(status==='ready'){lbl.textContent=t('readyYou');lbl.style.color='var(--success)';}
    else if(status==='left'){lbl.textContent=t('readyLeft');lbl.style.color='var(--muted)';}
    else{lbl.textContent=t('readyWaiting');lbl.style.color='var(--muted)';}
    row.appendChild(dot);row.appendChild(name);row.appendChild(lbl);
    list.appendChild(row);
  });
  // Show action buttons based on my state
  const myStatus=readyMap[myPlayerId];
  const joinBtn=document.getElementById('btn-join-ready');
  const leaveBtn=document.getElementById('btn-leave-ready');
  joinBtn.textContent=t('joinReady');
  leaveBtn.textContent=t('goHome');
  // Show "join" button only if I haven't decided yet
  joinBtn.style.display=(myStatus==='ready'||myStatus==='left')?'none':'';
  openModal('ready-modal');
  // If all decided, start automatically
  const allDone=players.every(p=>readyMap[p.id]==='ready'||readyMap[p.id]==='left');
  if(allDone&&players.some(p=>readyMap[p.id]==='ready')){
    doStartNewGame(data);
  }
}

async function doStartNewGame(data){
  if(!roomRef) return;
  const players=data.players||[];
  const g=data.game;
  let curMode,nt,teamsMap,gs,useTimer,timerSecs;
  if(pendingNewGameHow==='newcfg'&&isHost){
    // Host chose new config from the win modal
    curMode=cfgMode;
    nt=2;teamsMap={};
    gs=cfgSize;
    useTimer=cfgTimerEnabled;
    timerSecs=parseInt(document.getElementById('cfg-timer-secs')?.value)||cfgTimerSecs||90;
  } else {
    // Same config as previous game
    curMode=data.mode||g?.mode||'coop';
    gs=data.gridSize||g?.gridSize||selectedSize||5;
    useTimer=data.useTimer||false;
    timerSecs=data.timerSecs||90;
    if(curMode==='teams'){
      nt=data.numTeams||g?.numTeams||2;teamsMap={};
      for(let n=1;n<=nt;n++) (g?.teams?.[n]?.players||[]).forEach(p=>{teamsMap[p.id]=n;});
    } else {nt=2;teamsMap={};}
  }
  const curTheme=pendingNewGameHow==='newcfg'?cfgTheme:(data.theme||'classic');
  const gameData=buildGameData(players,data.lang||lang,curMode,teamsMap,nt,gs,curTheme);
  closeModal('gameover-modal');closeModal('ready-modal');closeModal('win-modal');
  await update(roomRef,{status:'playing',mode:curMode,numTeams:nt,gridSize:gs,theme:curTheme,useTimer,timerSecs,game:gameData,readyMap:{}});
}

// (end-reassign panel removed ‚Äî using win-modal config instead)

// ‚îÄ‚îÄ QUIT / LEAVE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function leaveRoom(){
  stopLocalTimer();
  if(roomRef&&myPlayerId){
    try{
      const snap=await get(roomRef);
      if(snap.exists()){
        const data=snap.val();
        const updatedPlayers=(data.players||[]).filter(p=>p.id!==myPlayerId);
        if(updatedPlayers.length===0){
          off(roomRef);
        } else {
          const updates={players:updatedPlayers};
          // Always mark as left in readyMap so pending ready checks resolve
          updates[`readyMap/${myPlayerId}`]='left';
          if(data.game?.teams){
            const newTeams=deepCopy(data.game.teams);
            const nt=data.game.numTeams||2;
            for(let n=1;n<=nt;n++){
              if(newTeams[n]?.players){
                newTeams[n].players=newTeams[n].players.filter(p=>p.id!==myPlayerId);
                const len=Math.max(newTeams[n].players.length,1);
                newTeams[n].giverIndex=(newTeams[n].giverIndex||0)%len;
              }
            }
            updates['game/teams']=newTeams;
          }
          await update(roomRef,updates);
          off(roomRef);
        }
      }
    }catch(e){off(roomRef);}
  }
  resetToLobby();
}
window.quitGame=()=>{if(confirm(lang==='es'?'¬øSalir del juego?':'Quit the game?'))leaveRoom();};
window.goHome=()=>{leaveRoom();};

function resetToLobby(){
  roomId=null;roomRef=null;gstate=null;myPlayerId=null;myName='';isHost=false;
  selectedMode='coop';selectedSize=4;selectedTheme='classic';numTeams=2;teamAssignments={};pendingNewGameHow=null;
  ['create-section','or-div','join-section'].forEach(id=>document.getElementById(id).style.display='');
  ['waiting-section','join-status','teams-config'].forEach(id=>document.getElementById(id).style.display='none');
  document.getElementById('join-code').value='';
  document.getElementById('log-scroll').innerHTML='';
  document.getElementById('start-game-btn').style.display='';
  document.getElementById('mode-btn-coop').classList.add('active');
  document.getElementById('mode-btn-teams').classList.remove('active');
  closeModal('gameover-modal');closeModal('ready-modal');closeModal('win-modal');
  showScreen('lobby');applyLobbyTrans();
}
window.copyRoomCode=()=>{if(!roomId)return;navigator.clipboard.writeText(roomId).catch(()=>{});showToast(t('copiedCode'));};

applyLobbyTrans();

// Remove player only when tab/window is truly closed (not just switching tabs)
// pagehide with persisted=false = real unload; persisted=true = bfcache (back button)
window.addEventListener('pagehide', (e)=>{
  if(!e.persisted && roomRef && myPlayerId && gstate) leaveRoom();
});
</script>
</body>
</html>
