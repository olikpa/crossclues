<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Cross Clues â€” Online</title>
<link href="https://fonts.googleapis.com/css2?family=Syne:wght@700;800&family=Instrument+Sans:wght@400;500;600&family=Instrument+Serif:ital@0;1&display=swap" rel="stylesheet">

<style>
:root {
  --bg: #f5f0e8;
  --surface: #fffdf8;
  --card: #ffffff;
  --border: #e0d8cc;
  --shadow: rgba(60,40,10,.08);
  --ink: #1c1710;
  --muted: #8a7f6e;
  --row-clr: #c0392b;
  --col-clr: #1a6fa8;
  --accent: #d4a017;
  --success: #2e7d52;
  --success-bg: #d4f0e0;
  --wrong: #c0392b;
  --wrong-bg: #fdf0ef;
  --tag-bg: #f0ece3;
}

*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

body {
  font-family: 'Instrument Sans', sans-serif;
  background: var(--bg);
  color: var(--ink);
  min-height: 100vh;
  overflow-x: hidden;
}

body::after {
  content: '';
  position: fixed;
  inset: 0;
  pointer-events: none;
  z-index: 999;
  opacity: .025;
  background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)'/%3E%3C/svg%3E");
}

.screen { display: none; min-height: 100vh; }
.screen.active { display: flex; flex-direction: column; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   LOBBY
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#lobby {
  align-items: center;
  justify-content: center;
  padding: 2rem 1rem;
  gap: 2rem;
  background:
    radial-gradient(ellipse 80% 60% at 20% 10%, rgba(212,160,23,.12) 0%, transparent 60%),
    radial-gradient(ellipse 60% 50% at 80% 90%, rgba(26,111,168,.1) 0%, transparent 60%),
    var(--bg);
}

.logo-block { text-align: center; }

.logo-cross {
  display: inline-flex;
  align-items: center;
  gap: .3rem;
  font-family: 'Syne', sans-serif;
  font-size: clamp(2.4rem, 7vw, 4rem);
  font-weight: 800;
  letter-spacing: -.03em;
  line-height: 1;
}
.logo-cross .w-row { color: var(--row-clr); }
.logo-cross .w-sep { color: var(--muted); font-size: .6em; }
.logo-cross .w-col { color: var(--col-clr); }

.logo-sub {
  margin-top: .5rem;
  font-size: .85rem;
  color: var(--muted);
  letter-spacing: .12em;
  text-transform: uppercase;
}

.lobby-card {
  background: var(--card);
  border: 1px solid var(--border);
  border-radius: 20px;
  padding: 2rem;
  width: 100%;
  max-width: 420px;
  box-shadow: 0 4px 24px var(--shadow);
}

.lang-row {
  display: flex;
  gap: .5rem;
  margin-bottom: 1.8rem;
  padding: .3rem;
  background: var(--tag-bg);
  border-radius: 12px;
}

.lang-pill {
  flex: 1;
  padding: .55rem;
  border: none;
  border-radius: 9px;
  background: transparent;
  font-family: 'Instrument Sans', sans-serif;
  font-size: .85rem;
  color: var(--muted);
  cursor: pointer;
  transition: all .18s;
  font-weight: 500;
}
.lang-pill.active {
  background: var(--card);
  color: var(--ink);
  box-shadow: 0 1px 4px var(--shadow);
}

.or-divider {
  display: flex;
  align-items: center;
  gap: .8rem;
  margin: 1.4rem 0;
  color: var(--muted);
  font-size: .8rem;
  text-transform: uppercase;
  letter-spacing: .1em;
}
.or-divider::before, .or-divider::after {
  content: '';
  flex: 1;
  height: 1px;
  background: var(--border);
}

.section-lbl {
  font-size: .75rem;
  text-transform: uppercase;
  letter-spacing: .1em;
  color: var(--muted);
  margin-bottom: .6rem;
  font-weight: 600;
}

.field {
  width: 100%;
  padding: .75rem 1rem;
  border: 1.5px solid var(--border);
  border-radius: 12px;
  background: var(--surface);
  font-family: 'Instrument Sans', sans-serif;
  font-size: 1rem;
  color: var(--ink);
  outline: none;
  transition: border-color .18s, box-shadow .18s;
  margin-bottom: .8rem;
}
.field:focus {
  border-color: var(--accent);
  box-shadow: 0 0 0 3px rgba(212,160,23,.15);
}
.field::placeholder { color: var(--muted); }

.btn-main {
  width: 100%;
  padding: .85rem;
  border: none;
  border-radius: 12px;
  font-family: 'Syne', sans-serif;
  font-size: 1rem;
  font-weight: 700;
  cursor: pointer;
  transition: transform .12s, opacity .18s;
  letter-spacing: .02em;
}
.btn-main:hover { opacity: .9; transform: translateY(-1px); }
.btn-main:active { transform: translateY(0); }
.btn-create { background: var(--ink); color: var(--bg); }
.btn-join { background: var(--accent); color: var(--ink); }

.room-code-display {
  background: var(--tag-bg);
  border: 1.5px dashed var(--border);
  border-radius: 12px;
  padding: 1.2rem;
  text-align: center;
  margin-bottom: 1rem;
}
.room-code-label {
  font-size: .75rem;
  text-transform: uppercase;
  letter-spacing: .1em;
  color: var(--muted);
  margin-bottom: .4rem;
}
.room-code-value {
  font-family: 'Syne', sans-serif;
  font-size: 2.2rem;
  font-weight: 800;
  letter-spacing: .15em;
  color: var(--ink);
}

.waiting-dots::after {
  content: '';
  animation: dots 1.4s infinite;
}
@keyframes dots {
  0%   { content: ''; }
  25%  { content: '.'; }
  50%  { content: '..'; }
  75%  { content: '...'; }
}

.status-msg {
  text-align: center;
  font-size: .9rem;
  color: var(--muted);
  padding: .5rem 0;
}
.status-msg.error { color: var(--wrong); }

/* players-in-room list */
.players-in-room {
  margin-top: .8rem;
}
.players-in-room-label {
  font-size: .72rem;
  text-transform: uppercase;
  letter-spacing: .1em;
  color: var(--muted);
  margin-bottom: .4rem;
}
.players-list {
  display: flex;
  flex-wrap: wrap;
  gap: .4rem;
}
.player-chip {
  display: flex;
  align-items: center;
  gap: .35rem;
  padding: .25rem .6rem;
  background: var(--tag-bg);
  border: 1px solid var(--border);
  border-radius: 20px;
  font-size: .8rem;
  font-weight: 500;
}
.player-chip-dot {
  width: 8px; height: 8px;
  border-radius: 50%;
  flex-shrink: 0;
}

.start-game-btn {
  margin-top: .8rem;
  width: 100%;
  padding: .8rem;
  background: var(--success);
  border: none;
  border-radius: 12px;
  color: #fff;
  font-family: 'Syne', sans-serif;
  font-size: .95rem;
  font-weight: 700;
  cursor: pointer;
  transition: opacity .18s;
}
.start-game-btn:hover { opacity: .88; }
.start-game-btn:disabled { opacity: .4; cursor: not-allowed; }

/* timer toggle row */
.timer-row {
  display: flex;
  align-items: center;
  gap: .8rem;
  padding: .8rem 0;
  border-top: 1px solid var(--border);
  margin-top: .5rem;
}
.toggle-switch {
  position: relative;
  width: 40px; height: 22px;
  cursor: pointer;
  flex-shrink: 0;
}
.toggle-switch input { opacity: 0; width: 0; height: 0; }
.toggle-slider {
  position: absolute;
  inset: 0;
  background: var(--border);
  border-radius: 11px;
  transition: .2s;
}
.toggle-slider::before {
  content: '';
  position: absolute;
  width: 16px; height: 16px;
  left: 3px; top: 3px;
  background: #fff;
  border-radius: 50%;
  transition: .2s;
  box-shadow: 0 1px 3px rgba(0,0,0,.2);
}
.toggle-switch input:checked + .toggle-slider { background: var(--accent); }
.toggle-switch input:checked + .toggle-slider::before { transform: translateX(18px); }

.timer-input {
  width: 56px;
  padding: .3rem .5rem;
  border: 1.5px solid var(--border);
  border-radius: 8px;
  background: var(--surface);
  font-family: 'Syne', sans-serif;
  font-size: .9rem;
  text-align: center;
  color: var(--ink);
  outline: none;
}
.timer-input:focus { border-color: var(--accent); }
.timer-input:disabled { opacity: .4; }
.timer-label { font-size: .85rem; color: var(--muted); flex: 1; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   GAME SCREEN
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#game { flex-direction: column; background: var(--bg); }

.game-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: .7rem 1.2rem;
  background: var(--card);
  border-bottom: 1px solid var(--border);
  flex-shrink: 0;
  gap: .8rem;
  box-shadow: 0 1px 4px var(--shadow);
}

.header-logo {
  font-family: 'Syne', sans-serif;
  font-weight: 800;
  font-size: 1.1rem;
  letter-spacing: -.02em;
}
.header-logo .r { color: var(--row-clr); }
.header-logo .c { color: var(--col-clr); }

.header-center {
  display: flex;
  align-items: center;
  gap: .7rem;
}

.score-chip {
  font-family: 'Syne', sans-serif;
  font-size: .85rem;
  font-weight: 700;
  padding: .25rem .7rem;
  border-radius: 20px;
  background: var(--tag-bg);
  border: 1px solid var(--border);
  color: var(--ink);
}

.timer-chip {
  font-family: 'Syne', sans-serif;
  font-size: 1rem;
  font-weight: 800;
  padding: .2rem .65rem;
  border-radius: 20px;
  background: var(--ink);
  color: var(--bg);
  min-width: 50px;
  text-align: center;
  transition: background .3s;
}
.timer-chip.urgent { background: var(--wrong); animation: urgentPulse .5s alternate infinite; }
@keyframes urgentPulse { to { opacity: .7; } }

.room-chip {
  font-family: 'Syne', sans-serif;
  font-size: .75rem;
  font-weight: 700;
  letter-spacing: .1em;
  color: var(--muted);
  border: 1px solid var(--border);
  border-radius: 8px;
  padding: .2rem .55rem;
  cursor: pointer;
}
.room-chip:hover { border-color: var(--muted); }

.header-quit {
  padding: .3rem .7rem;
  border: 1px solid var(--border);
  border-radius: 8px;
  background: transparent;
  font-family: 'Instrument Sans', sans-serif;
  font-size: .8rem;
  color: var(--muted);
  cursor: pointer;
  transition: all .15s;
}
.header-quit:hover { border-color: var(--wrong); color: var(--wrong); }

.header-new-game {
  padding: .3rem .8rem;
  border: 1.5px solid var(--success);
  border-radius: 8px;
  background: transparent;
  font-family: 'Syne', sans-serif;
  font-size: .8rem;
  font-weight: 700;
  color: var(--success);
  cursor: pointer;
  transition: all .15s;
}
.header-new-game:hover { background: var(--success); color: #fff; }

.game-body {
  flex: 1;
  display: grid;
  grid-template-columns: 1fr 290px;
  min-height: 0;
  overflow: hidden;
}
@media (max-width: 720px) {
  .game-body {
    grid-template-columns: 1fr;
    grid-template-rows: 1fr auto;
    overflow: auto;
  }
}

/* Grid area */
.grid-area {
  display: flex;
  align-items: center;
  justify-content: center;
  padding: 1rem;
  overflow: auto;
}

.grid-wrap { display: flex; flex-direction: column; gap: 0; }

.col-headers { display: flex; margin-left: 96px; gap: 4px; }

.col-hdr {
  width: 72px;
  text-align: center;
  font-size: .68rem;
  font-weight: 600;
  color: var(--col-clr);
  text-transform: uppercase;
  letter-spacing: .04em;
  line-height: 1.2;
  padding-bottom: 5px;
  word-break: break-word;
}

.grid-row-wrap { display: flex; align-items: center; gap: 4px; }

.row-hdr {
  width: 92px;
  text-align: right;
  padding-right: 8px;
  font-size: .68rem;
  font-weight: 600;
  color: var(--row-clr);
  text-transform: uppercase;
  letter-spacing: .04em;
  line-height: 1.2;
  word-break: break-word;
}

.cell {
  width: 72px;
  height: 72px;
  border: 1.5px solid var(--border);
  border-radius: 10px;
  background: var(--card);
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  position: relative;
  transition: all .15s;
  overflow: hidden;
  box-shadow: 0 1px 3px var(--shadow);
}

.cell::before {
  content: '';
  position: absolute;
  inset: 0;
  background: linear-gradient(135deg, rgba(192,57,43,.05), rgba(26,111,168,.05));
  opacity: 0;
  transition: opacity .15s;
}
.cell:hover::before { opacity: 1; }
.cell:hover { border-color: var(--accent); transform: scale(1.06); z-index: 2; box-shadow: 0 4px 12px var(--shadow); }

.cell.disabled { cursor: default; }
.cell.disabled:hover { border-color: var(--border); transform: none; box-shadow: 0 1px 3px var(--shadow); }
.cell.disabled::before { display: none; }

/* â”€â”€ GUESSED CELL: vivid green glow â”€â”€ */
.cell.guessed {
  background: var(--success-bg);
  border-color: var(--success);
  border-width: 2px;
  cursor: default;
  box-shadow: 0 0 0 3px rgba(46,125,82,.18), 0 2px 8px rgba(46,125,82,.15);
}
.cell.guessed:hover { transform: none; border-color: var(--success); box-shadow: 0 0 0 3px rgba(46,125,82,.18), 0 2px 8px rgba(46,125,82,.15); }

/* pop animation when first guessed */
.cell.guessed-pop {
  animation: guessedPop .45s cubic-bezier(.36,1.56,.64,1) both;
}
@keyframes guessedPop {
  0%   { transform: scale(.85); opacity: .6; }
  60%  { transform: scale(1.12); }
  100% { transform: scale(1); opacity: 1; }
}

.cell-check {
  font-size: 1.6rem;
  color: var(--success);
  line-height: 1;
}

.cell.wrong-flash { animation: wrongFlash .5s ease; }
@keyframes wrongFlash {
  0%, 100% { background: var(--card); }
  50% { background: var(--wrong-bg); border-color: var(--wrong); }
}

.cell.active-target {
  border-color: var(--accent);
  box-shadow: 0 0 0 3px rgba(212,160,23,.25), 0 2px 8px var(--shadow);
}

.cell-coord {
  position: absolute;
  bottom: 3px;
  right: 5px;
  font-family: 'Syne', sans-serif;
  font-size: .52rem;
  font-weight: 700;
  color: var(--muted);
  opacity: .5;
}

/* Side panel */
.side {
  border-left: 1px solid var(--border);
  background: var(--surface);
  display: flex;
  flex-direction: column;
  overflow: hidden;
}

.side-section {
  padding: 1rem;
  border-bottom: 1px solid var(--border);
  flex-shrink: 0;
}

.side-lbl {
  font-size: .7rem;
  text-transform: uppercase;
  letter-spacing: .12em;
  color: var(--muted);
  margin-bottom: .6rem;
  font-weight: 600;
}

/* Player strip - shows all players in room */
.players-strip {
  display: flex;
  flex-wrap: wrap;
  gap: .35rem;
}
.player-pill {
  display: flex;
  align-items: center;
  gap: .3rem;
  padding: .22rem .55rem;
  border-radius: 20px;
  border: 1.5px solid transparent;
  font-size: .78rem;
  font-weight: 500;
  transition: all .2s;
}
.player-pill.active-player {
  border-color: var(--accent);
  background: rgba(212,160,23,.08);
  font-weight: 700;
}
.player-pill.is-me {
  text-decoration: underline;
  text-underline-offset: 2px;
}
.pill-dot {
  width: 8px; height: 8px;
  border-radius: 50%;
  flex-shrink: 0;
}
.pill-role {
  font-size: .65rem;
  color: var(--muted);
  text-transform: uppercase;
  letter-spacing: .06em;
}

.player-card {
  display: flex;
  align-items: center;
  gap: .75rem;
  padding: .7rem;
  background: var(--card);
  border: 1px solid var(--border);
  border-radius: 10px;
}
.p-avatar {
  width: 38px; height: 38px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-family: 'Syne', sans-serif;
  font-size: 1.1rem;
  font-weight: 800;
  flex-shrink: 0;
}
.p-name {
  font-weight: 600;
  font-size: .95rem;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}
.p-role { font-size: .75rem; color: var(--muted); margin-top: .1rem; }

.target-card {
  background: var(--card);
  border: 1px solid var(--border);
  border-radius: 10px;
  padding: .75rem;
}
.target-coord-badge {
  font-family: 'Syne', sans-serif;
  font-size: .75rem;
  font-weight: 700;
  color: var(--muted);
  margin-bottom: .4rem;
}
.target-pair {
  display: flex;
  align-items: center;
  gap: .4rem;
  flex-wrap: wrap;
}
.tw { font-size: .9rem; font-weight: 600; padding: .2rem .5rem; border-radius: 6px; }
.tw-row { color: var(--row-clr); background: rgba(192,57,43,.08); }
.tw-col { color: var(--col-clr); background: rgba(26,111,168,.08); }
.tw-sep { color: var(--muted); font-size: .8rem; }
.hint-note { font-size: .78rem; color: var(--muted); font-style: italic; margin-top: .5rem; }

.clue-field {
  width: 100%;
  padding: .7rem .9rem;
  border: 1.5px solid var(--border);
  border-radius: 10px;
  background: var(--card);
  font-family: 'Instrument Sans', sans-serif;
  font-size: 1rem;
  color: var(--ink);
  outline: none;
  transition: border-color .18s, box-shadow .18s;
  margin-bottom: .6rem;
}
.clue-field:focus { border-color: var(--accent); box-shadow: 0 0 0 3px rgba(212,160,23,.12); }
.clue-field:disabled { background: var(--tag-bg); color: var(--muted); cursor: not-allowed; }

.give-btn {
  width: 100%;
  padding: .72rem;
  background: var(--ink);
  border: none;
  border-radius: 10px;
  color: var(--bg);
  font-family: 'Syne', sans-serif;
  font-size: .95rem;
  font-weight: 700;
  cursor: pointer;
  transition: opacity .18s;
}
.give-btn:hover:not(:disabled) { opacity: .85; }
.give-btn:disabled { opacity: .4; cursor: not-allowed; }

.clue-reveal {
  background: var(--card);
  border: 1.5px solid var(--accent);
  border-radius: 10px;
  padding: 1rem;
  text-align: center;
  margin-bottom: .6rem;
}
.clue-word {
  font-family: 'Instrument Serif', serif;
  font-size: 1.9rem;
  font-weight: 400;
  color: var(--ink);
  letter-spacing: -.01em;
}
.clue-sub {
  font-size: .72rem;
  text-transform: uppercase;
  letter-spacing: .1em;
  color: var(--muted);
  margin-top: .3rem;
}
.guess-tip { font-size: .82rem; color: var(--muted); text-align: center; line-height: 1.5; }

.waiting-note {
  background: var(--tag-bg);
  border: 1px solid var(--border);
  border-radius: 10px;
  padding: .8rem;
  text-align: center;
  font-size: .85rem;
  color: var(--muted);
  line-height: 1.5;
}

.log-scroll {
  flex: 1;
  overflow-y: auto;
  padding: .8rem 1rem;
  display: flex;
  flex-direction: column;
  gap: .35rem;
  min-height: 0;
}
.log-scroll::-webkit-scrollbar { width: 4px; }
.log-scroll::-webkit-scrollbar-thumb { background: var(--border); border-radius: 2px; }

.log-entry {
  font-size: .78rem;
  line-height: 1.45;
  color: var(--muted);
  display: flex;
  gap: .4rem;
  align-items: flex-start;
}
.log-entry .li { flex-shrink: 0; }
.log-entry strong { color: var(--ink); }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   END SCREEN
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#end {
  align-items: center;
  justify-content: center;
  padding: 2rem;
  background: var(--bg);
}

.end-inner {
  max-width: 400px;
  width: 100%;
  text-align: center;
  animation: rise .5s ease both;
}
@keyframes rise {
  from { opacity: 0; transform: translateY(20px); }
  to   { opacity: 1; transform: translateY(0); }
}

.end-trophy { font-size: 5rem; line-height: 1; margin-bottom: 1rem; }
.end-title { font-family: 'Syne', sans-serif; font-size: 2.5rem; font-weight: 800; letter-spacing: -.03em; margin-bottom: .4rem; }
.end-sub { color: var(--muted); margin-bottom: 2rem; }

.end-stats { display: grid; grid-template-columns: 1fr 1fr; gap: .75rem; margin-bottom: 2rem; }
.stat-box { background: var(--card); border: 1px solid var(--border); border-radius: 14px; padding: 1.2rem .8rem; box-shadow: 0 2px 8px var(--shadow); }
.stat-n { font-family: 'Syne', sans-serif; font-size: 2.2rem; font-weight: 800; color: var(--ink); line-height: 1; }
.stat-desc { font-size: .72rem; text-transform: uppercase; letter-spacing: .1em; color: var(--muted); margin-top: .3rem; }

.end-btns { display: flex; flex-direction: column; gap: .7rem; }
.btn-again { padding: .9rem; background: var(--success); border: none; border-radius: 12px; color: #fff; font-family: 'Syne', sans-serif; font-size: 1rem; font-weight: 700; cursor: pointer; transition: opacity .18s; }
.btn-again:hover { opacity: .85; }
.btn-home { padding: .9rem; background: transparent; border: 1.5px solid var(--border); border-radius: 12px; color: var(--muted); font-family: 'Instrument Sans', sans-serif; font-size: .9rem; cursor: pointer; transition: all .18s; }
.btn-home:hover { border-color: var(--muted); color: var(--ink); }

/* room code in end screen */
.end-room-code {
  font-family: 'Syne', sans-serif;
  font-size: .85rem;
  font-weight: 700;
  color: var(--muted);
  letter-spacing: .1em;
  margin-bottom: 1rem;
  padding: .4rem .9rem;
  background: var(--tag-bg);
  border: 1px solid var(--border);
  border-radius: 20px;
  display: inline-block;
}

/* toast */
.toast {
  position: fixed;
  bottom: 1.5rem;
  left: 50%;
  transform: translateX(-50%) translateY(80px);
  background: var(--ink);
  color: var(--bg);
  padding: .65rem 1.2rem;
  border-radius: 24px;
  font-size: .9rem;
  font-weight: 500;
  z-index: 500;
  transition: transform .3s ease;
  pointer-events: none;
  white-space: nowrap;
  max-width: 90vw;
  text-align: center;
}
.toast.show { transform: translateX(-50%) translateY(0); }
</style>
</head>
<body>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• LOBBY â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="lobby" class="screen active">
  <div class="logo-block">
    <div class="logo-cross">
      <span class="w-row">Cross</span>
      <span class="w-sep">âœ•</span>
      <span class="w-col">Clues</span>
    </div>
    <div class="logo-sub" id="lg-sub">Online Cooperative Word Game</div>
  </div>

  <div class="lobby-card">
    <div class="lang-row">
      <button class="lang-pill active" onclick="setLang('en')">ğŸ‡¬ğŸ‡§ English</button>
      <button class="lang-pill" onclick="setLang('es')">ğŸ‡ªğŸ‡¸ EspaÃ±ol</button>
    </div>

    <!-- Create Room -->
    <div id="create-section">
      <div class="section-lbl" id="lbl-your-name">Your Name</div>
      <input type="text" class="field" id="create-name" maxlength="20" placeholder="Player 1">

      <div class="timer-row">
        <label class="toggle-switch">
          <input type="checkbox" id="timer-toggle" onchange="onTimerToggle()">
          <span class="toggle-slider"></span>
        </label>
        <span class="timer-label" id="lbl-timer-toggle">Enable timer</span>
        <input type="number" class="timer-input" id="timer-secs" value="90" min="15" max="600" disabled>
        <span class="timer-label" style="flex:none" id="lbl-secs">sec</span>
      </div>

      <button class="btn-main btn-create" onclick="createRoom()" id="btn-create">Create Room</button>
    </div>

    <!-- Waiting in room (creator sees this) -->
    <div id="waiting-section" style="display:none">
      <div class="room-code-display">
        <div class="room-code-label" id="lbl-room-code">Room Code â€” share with everyone</div>
        <div class="room-code-value" id="room-code-value">â€”â€”â€”</div>
      </div>

      <div class="players-in-room">
        <div class="players-in-room-label" id="lbl-players-joined">Players joined</div>
        <div class="players-list" id="lobby-players-list"></div>
      </div>

      <button class="start-game-btn" id="start-game-btn" onclick="hostStartGame()" disabled>
        Start Game â†’
      </button>

      <div class="status-msg" id="waiting-msg" style="margin-top:.6rem">
        <span id="waiting-text">Waiting for players</span><span class="waiting-dots"></span>
      </div>
    </div>

    <div class="or-divider" id="or-div">or</div>

    <!-- Join Room -->
    <div id="join-section">
      <div class="section-lbl" id="lbl-join-name">Your Name</div>
      <input type="text" class="field" id="join-name" maxlength="20" placeholder="Player 2">
      <div class="section-lbl" id="lbl-enter-code">Room Code</div>
      <input type="text" class="field" id="join-code" maxlength="6" placeholder="ABC123"
        style="text-transform:uppercase;letter-spacing:.15em;font-family:'Syne',sans-serif;font-weight:700;"
        oninput="this.value=this.value.toUpperCase()">
      <button class="btn-main btn-join" onclick="joinRoom()" id="btn-join">Join Room</button>
      <div class="status-msg" id="join-status" style="margin-top:.5rem;display:none"></div>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• GAME â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="game" class="screen">
  <div class="game-header">
    <div class="header-logo"><span class="r">Cross</span> <span class="c">Clues</span></div>
    <div class="header-center">
      <span class="score-chip" id="hdr-score">0 / 25</span>
      <span class="timer-chip" id="hdr-timer" style="display:none">1:30</span>
      <span class="room-chip" id="hdr-room" title="Click to copy room code" onclick="copyRoomCode()">â€”</span>
    </div>
    <button class="header-new-game" id="btn-new-game" onclick="playAgain()">New Game</button>
    <button class="header-quit" id="btn-quit" onclick="quitGame()">Quit</button>
  </div>

  <div class="game-body">
    <div class="grid-area">
      <div id="grid-wrap" class="grid-wrap"></div>
    </div>

    <div class="side">
      <!-- All players strip -->
      <div class="side-section" id="side-players">
        <div class="side-lbl" id="lbl-players">Players</div>
        <div class="players-strip" id="players-strip"></div>
      </div>

      <!-- Current active player -->
      <div class="side-section" id="side-player">
        <div class="side-lbl" id="lbl-now-playing">Now Playing</div>
        <div class="player-card">
          <div class="p-avatar" id="p-avatar">?</div>
          <div>
            <div class="p-name" id="p-name-display">â€”</div>
            <div class="p-role" id="p-role-display">â€”</div>
          </div>
        </div>
      </div>

      <!-- Giver's target -->
      <div class="side-section" id="giver-block">
        <div class="side-lbl" id="lbl-target">Target</div>
        <div class="target-card">
          <div class="target-coord-badge" id="tc-coord">â€”</div>
          <div class="target-pair" id="tc-pair"></div>
          <div class="hint-note" id="tc-hint"></div>
        </div>
      </div>

      <!-- Giver's clue input -->
      <div class="side-section" id="clue-input-block">
        <div class="side-lbl" id="lbl-give-clue">Your Clue</div>
        <input type="text" class="clue-field" id="clue-input" maxlength="40" placeholder="one wordâ€¦"
          onkeydown="if(event.key==='Enter') submitClue()">
        <button class="give-btn" id="give-btn" onclick="submitClue()">Give Clue â†’</button>
      </div>

      <!-- Guesser's view -->
      <div class="side-section" id="guesser-block" style="display:none">
        <div class="side-lbl" id="lbl-the-clue">The Clue</div>
        <div class="clue-reveal">
          <div class="clue-word" id="revealed-clue">â€”</div>
          <div class="clue-sub" id="lbl-one-word">one word</div>
        </div>
        <div class="guess-tip" id="guess-tip">Tap the grid cell that matches!</div>
      </div>

      <!-- Waiting note -->
      <div class="side-section" id="waiting-block" style="display:none">
        <div class="waiting-note" id="waiting-note-text">Waitingâ€¦</div>
      </div>

      <div class="side-lbl" style="padding:.7rem 1rem .2rem;flex-shrink:0" id="lbl-log">Log</div>
      <div class="log-scroll" id="log-scroll"></div>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• END â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="end" class="screen">
  <div class="end-inner">
    <div class="end-trophy" id="end-trophy">ğŸ†</div>
    <div class="end-title" id="end-title">Congratulations!</div>
    <div class="end-sub" id="end-sub">You matched all pairs!</div>
    <div class="end-room-code" id="end-room-code"></div>
    <div class="end-stats">
      <div class="stat-box">
        <div class="stat-n" id="stat-matched">0</div>
        <div class="stat-desc" id="lbl-stat-matched">Matched</div>
      </div>
      <div class="stat-box">
        <div class="stat-n" id="stat-rounds">0</div>
        <div class="stat-desc" id="lbl-stat-rounds">Rounds</div>
      </div>
    </div>
    <div class="end-btns">
      <button class="btn-again" id="btn-play-again" onclick="playAgain()">Play Again (same room)</button>
      <button class="btn-home" id="btn-go-home" onclick="goHome()">Leave Room</button>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script type="module">
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  FIREBASE CONFIG  â€” your credentials are already set below
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const FIREBASE_CONFIG = {
  apiKey: "AIzaSyCa_uT9_f2LbjO-zAKXPVK5Fob_4NWoHLA",
  authDomain: "cross-clues-31450.firebaseapp.com",
  databaseURL: "https://cross-clues-31450-default-rtdb.firebaseio.com",
  projectId: "cross-clues-31450",
  storageBucket: "cross-clues-31450.firebasestorage.app",
  messagingSenderId: "1043663543507",
  appId: "1:1043663543507:web:13ee17b1da0c47b2c74826",
  measurementId: "G-63Z8MV0CFB"
};

import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import {
  getDatabase, ref, set, get, update, onValue, off
} from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

const app = initializeApp(FIREBASE_CONFIG);
const db  = getDatabase(app);

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  WORD LISTS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const WORDS = {
  en: [
    "OCEAN","FIRE","MOON","TREE","STONE","CLOCK","BRIDGE","CLOUD","WIND","MOUNTAIN",
    "BOOK","HEART","STAR","RIVER","LION","SHIP","GOLD","SHADOW","FLOWER","DREAM",
    "SWORD","EAGLE","DESERT","MIRROR","CROWN","ANCHOR","THUNDER","CANDLE","FEATHER","WAVE",
    "KEY","DOOR","BELL","FISH","RAIN","SNOW","LEAF","NIGHT","ROAD","KING",
    "CAVE","WING","FLAME","ROSE","MAP","CAGE","BONE","SONG","LIGHT","HORN",
    "WOLF","TRAIL","GARDEN","SILVER","TOWER","STORM","ARROW","PEARL","CRYSTAL","FROST",
    "SEAL","FORGE","BEACON","TIDE","ORBIT","DUSK","MIST","LORE","SHIELD","VEIL"
  ],
  es: [
    "OCÃ‰ANO","FUEGO","LUNA","ÃRBOL","PIEDRA","RELOJ","PUENTE","NUBE","VIENTO","MONTAÃ‘A",
    "LIBRO","CORAZÃ“N","ESTRELLA","RÃO","LEÃ“N","BARCO","ORO","SOMBRA","FLOR","SUEÃ‘O",
    "ESPADA","ÃGUILA","DESIERTO","ESPEJO","CORONA","ANCLA","TRUENO","VELA","PLUMA","OLA",
    "LLAVE","PUERTA","CAMPANA","PEZ","LLUVIA","NIEVE","HOJA","NOCHE","CAMINO","REY",
    "CUEVA","ALA","LLAMA","ROSA","MAPA","JAULA","HUESO","CANCIÃ“N","LUZ","CUERNO",
    "LOBO","SENDERO","JARDÃN","PLATA","TORRE","TORMENTA","FLECHA","PERLA","CRISTAL","ESCARCHA",
    "FOCA","FRAGUA","FARO","MAREA","Ã“RBITA","CREPÃšSCULO","NIEBLA","LEYENDA","ESCUDO","VELO"
  ]
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  TRANSLATIONS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const T = {
  en: {
    sub: "Online Cooperative Word Game",
    yourName: "Your Name", joinName: "Your Name",
    enterCode: "Room Code", timerToggle: "Enable timer", secs: "sec",
    createBtn: "Create Room", joinBtn: "Join Room",
    roomCode: "Room Code â€” share with everyone",
    playersJoined: "Players in room",
    waitingText: "Waiting for players",
    startGame: "Start Game â†’",
    nowPlaying: "Now Playing", players: "Players",
    target: "Target", giveClue: "Your Clue",
    theClue: "The Clue", oneWord: "one word",
    guessInstruction: "Tap the grid cell that matches!",
    hintNote: "Give one word that hints at both!",
    giver: "Clue Giver", guesser: "Guesser",
    cluePlaceholder: "one wordâ€¦", giveBtn: "Give Clue â†’",
    log: "Log", quit: "Quit", newGame: "New Game",
    statMatched: "Matched", statRounds: "Rounds",
    playAgain: "Play Again (same room)", goHome: "Leave Room",
    congratsTitle: "Congratulations!",
    congratsSub: n => `You matched all ${n} pairs!`,
    wrongMsg: (clue, rw, cw) => `"${clue}" was for ${rw} Ã— ${cw}`,
    p1def: "Player 1", p2def: "Player 2",
    partnerThinking: name => `${name} is giving a clueâ€¦`,
    waitingGuess: name => `${name} is guessingâ€¦`,
    roundLog: (n, c) => `${n}: "${c}"`,
    correctLog: (c, r, col) => `âœ“ "${c}" â†’ ${r}Ã—${col}`,
    wrongLog: (c, r, col) => `âœ— "${c}" â†’ ${r}Ã—${col}`,
    joinError: "Room not found. Check the code.",
    roomFull: "Room is full (max 10 players).",
    codedRoom: code => `Room: ${code}`,
    copiedCode: "Room code copied!",
    needPlayers: "Need at least 2 players to start.",
    waitingForHost: "Waiting for host to start the gameâ€¦",
    youLabel: "you",
  },
  es: {
    sub: "Juego cooperativo de palabras en lÃ­nea",
    yourName: "Tu Nombre", joinName: "Tu Nombre",
    enterCode: "CÃ³digo de Sala", timerToggle: "Activar temporizador", secs: "seg",
    createBtn: "Crear Sala", joinBtn: "Unirse",
    roomCode: "CÃ³digo de Sala â€” comparte con todos",
    playersJoined: "Jugadores en la sala",
    waitingText: "Esperando jugadores",
    startGame: "Empezar Partida â†’",
    nowPlaying: "Turno de", players: "Jugadores",
    target: "Objetivo", giveClue: "Tu Pista",
    theClue: "La Pista", oneWord: "una palabra",
    guessInstruction: "Â¡Toca la celda del tablero que corresponde!",
    hintNote: "Â¡Da una palabra que insinÃºe las dos!",
    giver: "Da la Pista", guesser: "Adivina",
    cluePlaceholder: "una palabraâ€¦", giveBtn: "Dar Pista â†’",
    log: "Registro", quit: "Salir", newGame: "Nuevo Juego",
    statMatched: "Adivinadas", statRounds: "Rondas",
    playAgain: "Nueva Partida (misma sala)", goHome: "Salir de la sala",
    congratsTitle: "Â¡Felicidades!",
    congratsSub: n => `Â¡Adivinasteis las ${n} parejas!`,
    wrongMsg: (clue, rw, cw) => `"${clue}" era para ${rw} Ã— ${cw}`,
    p1def: "Jugador 1", p2def: "Jugador 2",
    partnerThinking: name => `${name} estÃ¡ dando una pistaâ€¦`,
    waitingGuess: name => `${name} estÃ¡ adivinandoâ€¦`,
    roundLog: (n, c) => `${n}: "${c}"`,
    correctLog: (c, r, col) => `âœ“ "${c}" â†’ ${r}Ã—${col}`,
    wrongLog: (c, r, col) => `âœ— "${c}" â†’ ${r}Ã—${col}`,
    joinError: "Sala no encontrada. Verifica el cÃ³digo.",
    roomFull: "La sala estÃ¡ llena (mÃ¡x. 10 jugadores).",
    codedRoom: code => `Sala: ${code}`,
    copiedCode: "Â¡CÃ³digo copiado!",
    needPlayers: "Se necesitan al menos 2 jugadores.",
    waitingForHost: "Esperando que el anfitriÃ³n empiece la partidaâ€¦",
    youLabel: "tÃº",
  }
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  PLAYER COLORS (up to 10)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const PLAYER_COLORS = [
  '#c0392b','#1a6fa8','#2e7d52','#7b3fa0',
  '#d4a017','#00868a','#e07b39','#5a5a9c',
  '#8b4513','#1a7a4a'
];

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let lang = 'en';
let myPlayerId = null;   // unique ID for this browser tab
let myName = '';
let isHost = false;
let roomId = null;
let roomRef = null;
let gstate = null;       // latest Firebase snapshot

let timerInterval = null;
let localTimerLeft = 0;

const t = (key, ...args) => {
  const v = T[lang][key];
  return typeof v === 'function' ? v(...args) : (v ?? key);
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  UTILS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function shuffle(arr) {
  const a = [...arr];
  for (let i = a.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [a[i], a[j]] = [a[j], a[i]];
  }
  return a;
}

function genCode() {
  const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
  return Array.from({length: 6}, () => chars[Math.floor(Math.random() * chars.length)]).join('');
}

function genPlayerId() {
  return Math.random().toString(36).slice(2) + Date.now().toString(36);
}

function showToast(msg, dur = 2400) {
  const el = document.getElementById('toast');
  el.textContent = msg;
  el.classList.add('show');
  setTimeout(() => el.classList.remove('show'), dur);
}

function showScreen(id) {
  document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
  document.getElementById(id).classList.add('active');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  LANGUAGE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
window.setLang = (l) => {
  lang = l;
  document.querySelectorAll('.lang-pill').forEach((b, i) => {
    b.classList.toggle('active', (i===0 && l==='en') || (i===1 && l==='es'));
  });
  applyLobbyTranslations();
};

function applyLobbyTranslations() {
  document.getElementById('lg-sub').textContent = t('sub');
  document.getElementById('lbl-your-name').textContent = t('yourName');
  document.getElementById('lbl-join-name').textContent = t('joinName');
  document.getElementById('lbl-enter-code').textContent = t('enterCode');
  document.getElementById('lbl-timer-toggle').textContent = t('timerToggle');
  document.getElementById('lbl-secs').textContent = t('secs');
  document.getElementById('btn-create').textContent = t('createBtn');
  document.getElementById('btn-join').textContent = t('joinBtn');
  document.getElementById('lbl-room-code').textContent = t('roomCode');
  document.getElementById('lbl-players-joined').textContent = t('playersJoined');
  document.getElementById('waiting-text').textContent = t('waitingText');
  document.getElementById('start-game-btn').textContent = t('startGame');
  document.getElementById('create-name').placeholder = t('p1def');
  document.getElementById('join-name').placeholder = t('p2def');
}

function applyGameTranslations() {
  document.getElementById('lbl-now-playing').textContent = t('nowPlaying');
  document.getElementById('lbl-players').textContent = t('players');
  document.getElementById('lbl-target').textContent = t('target');
  document.getElementById('lbl-give-clue').textContent = t('giveClue');
  document.getElementById('lbl-the-clue').textContent = t('theClue');
  document.getElementById('lbl-one-word').textContent = t('oneWord');
  document.getElementById('guess-tip').textContent = t('guessInstruction');
  document.getElementById('clue-input').placeholder = t('cluePlaceholder');
  document.getElementById('give-btn').textContent = t('giveBtn');
  document.getElementById('lbl-log').textContent = t('log');
  document.getElementById('btn-quit').textContent = t('quit');
  document.getElementById('btn-new-game').textContent = t('newGame');
}

window.onTimerToggle = () => {
  document.getElementById('timer-secs').disabled = !document.getElementById('timer-toggle').checked;
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  CREATE ROOM
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
window.createRoom = async () => {
  const name = document.getElementById('create-name').value.trim() || t('p1def');
  const useTimer = document.getElementById('timer-toggle').checked;
  const timerSecs = parseInt(document.getElementById('timer-secs').value) || 90;

  myPlayerId = genPlayerId();
  myName = name;
  isHost = true;
  roomId = genCode();

  const roomData = {
    created: Date.now(),
    lang,
    useTimer,
    timerSecs,
    status: 'lobby',   // lobby | playing | ended
    hostId: myPlayerId,
    players: [{ id: myPlayerId, name }],
    game: null,
  };

  roomRef = ref(db, `rooms/${roomId}`);
  await set(roomRef, roomData);

  document.getElementById('create-section').style.display = 'none';
  document.getElementById('or-div').style.display = 'none';
  document.getElementById('join-section').style.display = 'none';
  document.getElementById('waiting-section').style.display = '';
  document.getElementById('room-code-value').textContent = roomId;

  listenRoom();
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  JOIN ROOM
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
window.joinRoom = async () => {
  const name = document.getElementById('join-name').value.trim() || t('p2def');
  const code = document.getElementById('join-code').value.trim().toUpperCase();
  if (!code || code.length < 4) { showJoinError(t('joinError')); return; }

  const snap = await get(ref(db, `rooms/${code}`));
  if (!snap.exists()) { showJoinError(t('joinError')); return; }

  const data = snap.val();
  const players = data.players || [];

  if (players.length >= 10) { showJoinError(t('roomFull')); return; }
  // Allow joining even if game is in progress (spectator/late join goes to lobby state listener)

  myPlayerId = genPlayerId();
  myName = name;
  isHost = false;
  roomId = code;
  lang = data.lang || 'en';

  document.querySelectorAll('.lang-pill').forEach((b, i) => {
    b.classList.toggle('active', (i===0 && lang==='en') || (i===1 && lang==='es'));
  });

  roomRef = ref(db, `rooms/${roomId}`);
  const newPlayers = [...players, { id: myPlayerId, name }];
  await update(roomRef, { players: newPlayers });

  listenRoom();

  // Hide join UI, show waiting
  document.getElementById('create-section').style.display = 'none';
  document.getElementById('or-div').style.display = 'none';
  document.getElementById('join-section').style.display = 'none';
  document.getElementById('waiting-section').style.display = '';
  document.getElementById('room-code-value').textContent = roomId;
  document.getElementById('start-game-btn').style.display = 'none'; // only host can start
};

function showJoinError(msg) {
  const el = document.getElementById('join-status');
  el.textContent = msg;
  el.className = 'status-msg error';
  el.style.display = '';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  HOST STARTS GAME
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
window.hostStartGame = async () => {
  if (!isHost || !roomRef) return;
  const snap = await get(roomRef);
  if (!snap.exists()) return;
  const data = snap.val();
  const players = data.players || [];

  if (players.length < 2) { showToast(t('needPlayers')); return; }

  const gameData = buildNewGameData(players, data.lang || lang);
  await update(roomRef, { status: 'playing', game: gameData });
};

function buildNewGameData(players, gameLang) {
  const G = 5;
  const pool = shuffle(WORDS[gameLang || lang]);
  const rowWords = pool.slice(0, G);
  const colWords = pool.slice(G, G * 2);
  const allCells = [];
  for (let r = 0; r < G; r++) for (let c = 0; c < G; c++) allCells.push(`${r},${c}`);
  const targetOrder = shuffle(allCells);

  return {
    rowWords, colWords, targetOrder,
    targetIndex: 0,
    currentPlayerIndex: 0,   // index into players array
    phase: 'giving',
    currentClue: '',
    guessed: [],
    rounds: 0,
    log: [],
    timerStartedAt: null,
  };
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  LISTEN TO ROOM
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function listenRoom() {
  if (!roomRef) return;
  off(roomRef);
  onValue(roomRef, (snap) => {
    if (!snap.exists()) return;
    const data = snap.val();
    gstate = data;
    lang = data.lang || lang;

    const players = data.players || [];

    if (data.status === 'lobby') {
      // Update lobby player list
      renderLobbyPlayers(players);
      // Enable start button for host if â‰¥2 players
      if (isHost) {
        document.getElementById('start-game-btn').disabled = players.length < 2;
      }
      return;
    }

    if (data.status === 'playing' && data.game) {
      applyGameTranslations();
      showScreen('game');
      document.getElementById('hdr-room').textContent = roomId;
      renderGame(data);
    }

    if (data.status === 'ended' && data.game) {
      renderEndScreen(data);
    }
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  LOBBY PLAYER LIST
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderLobbyPlayers(players) {
  const list = document.getElementById('lobby-players-list');
  list.innerHTML = '';
  players.forEach((p, i) => {
    const chip = document.createElement('div');
    chip.className = 'player-chip';
    const dot = document.createElement('div');
    dot.className = 'player-chip-dot';
    dot.style.background = PLAYER_COLORS[i % PLAYER_COLORS.length];
    chip.appendChild(dot);
    const nameEl = document.createElement('span');
    nameEl.textContent = p.id === myPlayerId ? `${p.name} (${t('youLabel')})` : p.name;
    chip.appendChild(nameEl);
    list.appendChild(chip);
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  RENDER GAME
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderGame(data) {
  const g = data.game;
  const players = data.players || [];
  const guessedSet = new Set(g.guessed || []);

  const currentIdx = g.currentPlayerIndex ?? 0;
  const giverPlayer = players[currentIdx] || players[0];
  const amGiver = giverPlayer && giverPlayer.id === myPlayerId;
  // Everyone else is a guesser â€” only one person guesses (the next in rotation), but
  // in Cross Clues the whole team guesses. We allow ANY non-giver to tap.
  const amGuesser = !amGiver;

  // Score
  document.getElementById('hdr-score').textContent = `${guessedSet.size} / ${g.rowWords.length * g.colWords.length}`;

  // Timer
  if (data.useTimer) {
    document.getElementById('hdr-timer').style.display = '';
    if (g.timerStartedAt) startLocalTimer(data.timerSecs, g.timerStartedAt);
    else stopLocalTimer();
  } else {
    document.getElementById('hdr-timer').style.display = 'none';
    stopLocalTimer();
  }

  // Players strip
  renderPlayersStrip(players, currentIdx, g.phase);

  // Active player card
  const activeName = g.phase === 'giving'
    ? (giverPlayer?.name || '?')
    : (giverPlayer?.name || '?');  // giver shown throughout
  const activeRole = g.phase === 'giving' ? t('giver') : t('giver'); // show giver always here
  const activeColor = PLAYER_COLORS[currentIdx % PLAYER_COLORS.length];

  document.getElementById('p-avatar').textContent = (giverPlayer?.name || '?').charAt(0).toUpperCase();
  document.getElementById('p-avatar').style.background = activeColor;
  document.getElementById('p-avatar').style.color = '#fff';
  document.getElementById('p-name-display').textContent = giverPlayer?.name || 'â€”';
  document.getElementById('p-role-display').textContent = t('giver');

  // Panels
  const giverBlock = document.getElementById('giver-block');
  const clueInputBlock = document.getElementById('clue-input-block');
  const guesserBlock = document.getElementById('guesser-block');
  const waitingBlock = document.getElementById('waiting-block');

  giverBlock.style.display = 'none';
  clueInputBlock.style.display = 'none';
  guesserBlock.style.display = 'none';
  waitingBlock.style.display = 'none';

  if (g.phase === 'giving') {
    if (amGiver) {
      giverBlock.style.display = '';
      clueInputBlock.style.display = '';
      document.getElementById('clue-input').disabled = false;
      document.getElementById('give-btn').disabled = false;
      document.getElementById('clue-input').value = '';
      setTimeout(() => document.getElementById('clue-input').focus(), 100);

      const tgt = currentTargetFromState(g);
      if (tgt) {
        const [tr, tc] = tgt.split(',').map(Number);
        document.getElementById('tc-coord').textContent = `${String.fromCharCode(65+tr)}${tc+1}`;
        document.getElementById('tc-pair').innerHTML =
          `<span class="tw tw-row">${g.rowWords[tr]}</span>
           <span class="tw-sep">Ã—</span>
           <span class="tw tw-col">${g.colWords[tc]}</span>`;
        document.getElementById('tc-hint').textContent = t('hintNote');
        highlightTargetCell(`${tr},${tc}`);
      }
    } else {
      waitingBlock.style.display = '';
      document.getElementById('waiting-note-text').textContent = t('partnerThinking', giverPlayer?.name || '?');
    }
  } else if (g.phase === 'guessing') {
    if (amGuesser) {
      guesserBlock.style.display = '';
      document.getElementById('revealed-clue').textContent = g.currentClue || 'â€”';
    } else {
      // Giver sees clue + target for context while waiting
      giverBlock.style.display = '';
      waitingBlock.style.display = '';
      document.getElementById('clue-input').disabled = true;
      document.getElementById('waiting-note-text').textContent = t('waitingGuess', 'â€¦');
      // show the clue for the giver too
      guesserBlock.style.display = '';
      document.getElementById('revealed-clue').textContent = g.currentClue || 'â€”';
    }
  }

  // Build grid
  buildGrid(g, guessedSet, g.phase, amGuesser);

  // Log
  renderLog(g.log || []);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  PLAYERS STRIP
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderPlayersStrip(players, currentIdx, phase) {
  const strip = document.getElementById('players-strip');
  strip.innerHTML = '';
  players.forEach((p, i) => {
    const pill = document.createElement('div');
    pill.className = 'player-pill';
    if (i === currentIdx) pill.classList.add('active-player');
    if (p.id === myPlayerId) pill.classList.add('is-me');

    const dot = document.createElement('div');
    dot.className = 'pill-dot';
    dot.style.background = PLAYER_COLORS[i % PLAYER_COLORS.length];

    const nameEl = document.createElement('span');
    let label = p.name;
    if (p.id === myPlayerId) label += ` (${t('youLabel')})`;
    nameEl.textContent = label;

    pill.appendChild(dot);
    pill.appendChild(nameEl);

    if (i === currentIdx) {
      const roleEl = document.createElement('span');
      roleEl.className = 'pill-role';
      roleEl.textContent = phase === 'giving' ? t('giver') : t('giver');
      pill.appendChild(roleEl);
    }

    strip.appendChild(pill);
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  GRID
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function buildGrid(g, guessedSet, phase, amGuesser) {
  const wrap = document.getElementById('grid-wrap');
  // Preserve existing grid and just update cell states if possible,
  // to avoid losing the pop animation
  const existingGrid = wrap.querySelector('.col-headers');

  // If grid words changed (new game) or no grid yet, rebuild fully
  const needsRebuild = !existingGrid ||
    wrap.dataset.rowWords !== g.rowWords.join(',') ||
    wrap.dataset.colWords !== g.colWords.join(',');

  if (needsRebuild) {
    wrap.innerHTML = '';
    wrap.dataset.rowWords = g.rowWords.join(',');
    wrap.dataset.colWords = g.colWords.join(',');

    const G = g.rowWords.length;

    const colHdr = document.createElement('div');
    colHdr.className = 'col-headers';
    for (let c = 0; c < G; c++) {
      const d = document.createElement('div');
      d.className = 'col-hdr';
      d.textContent = g.colWords[c];
      colHdr.appendChild(d);
    }
    wrap.appendChild(colHdr);

    for (let r = 0; r < G; r++) {
      const row = document.createElement('div');
      row.className = 'grid-row-wrap';

      const rh = document.createElement('div');
      rh.className = 'row-hdr';
      rh.textContent = g.rowWords[r];
      row.appendChild(rh);

      for (let c = 0; c < G; c++) {
        const cell = document.createElement('div');
        cell.className = 'cell';
        cell.id = `cell-${r}-${c}`;

        const coord = document.createElement('div');
        coord.className = 'cell-coord';
        coord.textContent = `${String.fromCharCode(65+r)}${c+1}`;
        cell.appendChild(coord);

        row.appendChild(cell);
      }
      wrap.appendChild(row);
    }
  }

  // Update each cell's state
  const G = g.rowWords.length;
  for (let r = 0; r < G; r++) {
    for (let c = 0; c < G; c++) {
      const cell = document.getElementById(`cell-${r}-${c}`);
      if (!cell) continue;
      const key = `${r},${c}`;
      const wasGuessed = cell.classList.contains('guessed');
      const isGuessed = guessedSet.has(key);

      // Remove old interaction listeners by replacing with clone
      const fresh = cell.cloneNode(true);
      cell.parentNode.replaceChild(fresh, cell);
      const el = document.getElementById(`cell-${r}-${c}`);

      el.className = 'cell';

      if (isGuessed) {
        el.classList.add('guessed', 'disabled');
        el.innerHTML = `<div class="cell-check">âœ“</div>`;
        // Add pop animation only when newly guessed
        if (!wasGuessed) {
          el.classList.add('guessed-pop');
          el.addEventListener('animationend', () => el.classList.remove('guessed-pop'), {once:true});
        }
      } else {
        // Re-add coord label
        el.innerHTML = `<div class="cell-coord">${String.fromCharCode(65+r)}${c+1}</div>`;
        if (phase === 'guessing' && amGuesser) {
          el.addEventListener('click', () => onCellClick(r, c));
        } else {
          el.classList.add('disabled');
        }
      }
    }
  }
}

function highlightTargetCell(key) {
  document.querySelectorAll('.cell').forEach(c => c.classList.remove('active-target'));
  const [r, c] = key.split(',');
  const el = document.getElementById(`cell-${r}-${c}`);
  if (el) el.classList.add('active-target');
}

function currentTargetFromState(g) {
  const guessedSet = new Set(g.guessed || []);
  const order = g.targetOrder || [];
  for (let i = g.targetIndex || 0; i < order.length; i++) {
    if (!guessedSet.has(order[i])) return order[i];
  }
  return null;
}

function renderLog(entries) {
  const scroll = document.getElementById('log-scroll');
  scroll.innerHTML = '';
  [...entries].reverse().forEach(entry => {
    const div = document.createElement('div');
    div.className = 'log-entry';
    div.innerHTML = `<span class="li">${entry.icon}</span><span>${entry.text}</span>`;
    scroll.appendChild(div);
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  CELL CLICK (GUESSER)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
window.onCellClick = async (r, c) => {
  if (!gstate || !gstate.game) return;
  const g = gstate.game;
  const players = gstate.players || [];

  if (g.phase !== 'guessing') return;

  const currentIdx = g.currentPlayerIndex ?? 0;
  const giverPlayer = players[currentIdx];
  // Only non-givers can guess
  if (giverPlayer && giverPlayer.id === myPlayerId) return;

  const guessedSet = new Set(g.guessed || []);
  if (guessedSet.has(`${r},${c}`)) return;

  const tgt = currentTargetFromState(g);
  if (!tgt) return;

  const [tr, tc] = tgt.split(',').map(Number);
  const correct = tgt === `${r},${c}`;
  let newGuessed = [...(g.guessed || [])];
  let newTargetIndex = g.targetIndex || 0;
  let newLog = [...(g.log || [])];

  // Next player in rotation
  const nextIdx = (currentIdx + 1) % players.length;

  if (correct) {
    newGuessed.push(`${r},${c}`);
    newTargetIndex++;
    newLog.push({
      icon: 'âœ…',
      text: t('correctLog', g.currentClue, g.rowWords[tr], g.colWords[tc])
    });

    const G = g.rowWords.length;
    if (newGuessed.length >= G * G) {
      // Game won!
      await update(ref(db, `rooms/${roomId}/game`), {
        guessed: newGuessed,
        targetIndex: newTargetIndex,
        log: newLog,
        phase: 'giving',
        currentClue: '',
        timerStartedAt: null,
      });
      await update(roomRef, { status: 'ended' });
      return;
    }
  } else {
    const el = document.getElementById(`cell-${r}-${c}`);
    if (el) {
      el.classList.add('wrong-flash');
      setTimeout(() => el.classList.remove('wrong-flash'), 600);
    }
    newLog.push({
      icon: 'âŒ',
      text: t('wrongLog', g.currentClue, g.rowWords[tr], g.colWords[tc])
    });
    newTargetIndex++;
    showToast(t('wrongMsg', g.currentClue, g.rowWords[tr], g.colWords[tc]));
  }

  stopLocalTimer();

  await update(ref(db, `rooms/${roomId}/game`), {
    guessed: newGuessed,
    targetIndex: newTargetIndex,
    log: newLog,
    phase: 'giving',
    currentPlayerIndex: nextIdx,
    currentClue: '',
    timerStartedAt: null,
    rounds: (g.rounds || 0) + 1,
  });
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  SUBMIT CLUE (GIVER)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
window.submitClue = async () => {
  const clue = document.getElementById('clue-input').value.trim().toUpperCase();
  if (!clue) return;
  if (!gstate || !gstate.game) return;
  const g = gstate.game;
  const players = gstate.players || [];

  if (g.phase !== 'giving') return;
  const currentIdx = g.currentPlayerIndex ?? 0;
  const giverPlayer = players[currentIdx];
  if (!giverPlayer || giverPlayer.id !== myPlayerId) return;

  document.getElementById('give-btn').disabled = true;
  document.getElementById('clue-input').disabled = true;

  const newLog = [...(g.log || []), {
    icon: 'ğŸ—£ï¸',
    text: t('roundLog', myName, clue)
  }];

  const timerStartedAt = gstate.useTimer ? Date.now() : null;

  await update(ref(db, `rooms/${roomId}/game`), {
    phase: 'guessing',
    currentClue: clue,
    log: newLog,
    timerStartedAt,
  });
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  TIMER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function startLocalTimer(totalSecs, startedAt) {
  stopLocalTimer();
  const elapsed = Math.floor((Date.now() - startedAt) / 1000);
  localTimerLeft = Math.max(0, totalSecs - elapsed);
  renderTimerDisplay();

  timerInterval = setInterval(async () => {
    localTimerLeft--;
    renderTimerDisplay();
    if (localTimerLeft <= 0) {
      stopLocalTimer();
      await handleTimerExpiry();
    }
  }, 1000);
}

function stopLocalTimer() {
  clearInterval(timerInterval);
  timerInterval = null;
}

function renderTimerDisplay() {
  const el = document.getElementById('hdr-timer');
  const m = Math.floor(localTimerLeft / 60);
  const s = localTimerLeft % 60;
  el.textContent = `${m}:${s.toString().padStart(2,'0')}`;
  el.classList.toggle('urgent', localTimerLeft <= 10);
}

async function handleTimerExpiry() {
  if (!gstate || !gstate.game) return;
  const g = gstate.game;
  const players = gstate.players || [];
  const currentIdx = g.currentPlayerIndex ?? 0;
  const giverPlayer = players[currentIdx];

  // Only the responsible party fires the update
  const isMyResponsibility =
    (g.phase === 'giving'   && giverPlayer?.id === myPlayerId) ||
    (g.phase === 'guessing' && giverPlayer?.id !== myPlayerId);

  if (!isMyResponsibility) return;

  const nextIdx = (currentIdx + 1) % players.length;
  const newLog = [...(g.log || []), { icon: 'â±ï¸', text: 'Time expired' }];

  await update(ref(db, `rooms/${roomId}/game`), {
    phase: 'giving',
    currentPlayerIndex: nextIdx,
    currentClue: '',
    timerStartedAt: null,
    rounds: (g.rounds || 0) + 1,
    targetIndex: (g.targetIndex || 0) + (g.phase === 'guessing' ? 1 : 0),
    log: newLog,
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  END SCREEN
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderEndScreen(data) {
  stopLocalTimer();
  showScreen('end');
  const g = data.game;
  const n = (g.guessed || []).length;
  document.getElementById('end-trophy').textContent = 'ğŸ†';
  document.getElementById('end-title').textContent = t('congratsTitle');
  document.getElementById('end-sub').textContent = t('congratsSub', n);
  document.getElementById('end-room-code').textContent = t('codedRoom', roomId);
  document.getElementById('stat-matched').textContent = n;
  document.getElementById('stat-rounds').textContent = g.rounds || 0;
  document.getElementById('btn-play-again').textContent = t('playAgain');
  document.getElementById('btn-go-home').textContent = t('goHome');
  document.getElementById('lbl-stat-matched').textContent = t('statMatched');
  document.getElementById('lbl-stat-rounds').textContent = t('statRounds');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  PLAY AGAIN â€” same room, no new code needed
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
window.playAgain = async () => {
  if (!roomRef || !gstate) return;
  stopLocalTimer();

  const players = gstate.players || [];
  // Reset game with same players, host can trigger or anyone
  const gameData = buildNewGameData(players, gstate.lang || lang);
  await update(roomRef, { status: 'playing', game: gameData });
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  QUIT / HOME
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
window.quitGame = () => {
  const msg = lang === 'es' ? 'Â¿Salir del juego?' : 'Quit the game?';
  if (confirm(msg)) {
    stopLocalTimer();
    if (roomRef) off(roomRef);
    resetToLobby();
  }
};

window.goHome = () => {
  stopLocalTimer();
  if (roomRef) off(roomRef);
  resetToLobby();
};

function resetToLobby() {
  roomId = null; roomRef = null; gstate = null;
  myPlayerId = null; myName = ''; isHost = false;

  document.getElementById('create-section').style.display = '';
  document.getElementById('or-div').style.display = '';
  document.getElementById('join-section').style.display = '';
  document.getElementById('waiting-section').style.display = 'none';
  document.getElementById('join-status').style.display = 'none';
  document.getElementById('join-code').value = '';
  document.getElementById('log-scroll').innerHTML = '';
  document.getElementById('start-game-btn').style.display = '';

  showScreen('lobby');
  applyLobbyTranslations();
}

window.copyRoomCode = () => {
  if (!roomId) return;
  navigator.clipboard.writeText(roomId).catch(() => {});
  showToast(t('copiedCode'));
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  INIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
applyLobbyTranslations();
</script>
</body>
</html>
